<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’£ Emoji Bomb 1v1 - Profesyonel EÅŸleÅŸme</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        /* Genel Stil ve Arka Plan */
        body { font-family: sans-serif; background: linear-gradient(to bottom right, #1a1a1a, #333333); color: #333; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .screen { width: 100%; max-width: 500px; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; box-sizing: border-box; text-align: center; background-color: #f0f0f0; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); }
        .screen.active { display: flex; }
        
        /* BileÅŸenler */
        .btn { @apply w-full text-xl font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 ease-in-out; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-500 active:scale-95; }
        .input-field { @apply w-full text-lg bg-gray-200 text-gray-900 border-2 border-gray-400 rounded-lg p-3 text-center placeholder-gray-500 focus:outline-none focus:border-blue-500; }
        .code-display { @apply text-4xl font-extrabold p-4 bg-gray-800 text-yellow-300 rounded-lg tracking-widest; }
        #globalMessage.show { display: block; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 50; animation: fadeInDown 0.3s ease-out; }

        /* Kart Stilleri */
        .card-container {
            perspective: 1000px; /* 3D Efekti iÃ§in gerekli */
        }
        .card {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            background-color: transparent;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Ters yÃ¼zÃ¼nÃ¼ gizle */
            border-radius: 8px;
            @apply flex items-center justify-center text-4xl font-black shadow-md;
        }
        .card-front {
            background-color: #4a5568; /* KapalÄ± Kart Rengi */
            color: #f7fafc;
        }
        .card-back {
            background-color: #e2e8f0; /* AÃ§Ä±k Kart Arka PlanÄ± */
            color: #333;
            transform: rotateY(180deg);
        }
        .card.bomb-selected .card-front {
            background-color: #e53e3e; /* SeÃ§im AÅŸamasÄ±nda KÄ±rmÄ±zÄ± */
            animation: pulse-red 0.5s infinite alternate;
        }
        
        /* TitreÅŸim Animasyonu */
        @keyframes vibrate {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-1px, -2px) rotate(-1deg); }
            40% { transform: translate(-3px, 0px) rotate(1deg); }
            60% { transform: translate(3px, 2px) rotate(0deg); }
            80% { transform: translate(1px, -1px) rotate(-1deg); }
            100% { transform: translate(-1px, 2px) rotate(1deg); }
        }
        .vibrate {
            animation: vibrate 0.1s linear infinite;
        }
        
        @keyframes pulse-red {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-900 select-none">

    <div id="globalMessage" class="hidden w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg">
        <p id="globalMessageText"></p>
    </div>

    <div id="lobby" class="screen active space-y-6">
        <h1 class="text-5xl font-black text-gray-900">ğŸ’£ Emoji Bomb</h1>
        <p class="text-gray-700">Sunucuya baÄŸlÄ±. KullanÄ±cÄ± adÄ±nÄ±zÄ± girin.</p>
        
        <input type="text" id="username" class="input-field" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="text" id="roomCodeInput" class="input-field uppercase" placeholder="Oda NumarasÄ± (BoÅŸ bÄ±rak=OluÅŸtur)">
        
        <button id="matchBtn" class="btn btn-primary">ğŸ® Oda OluÅŸtur / Odaya Gir</button>
    </div>
    
    <div id="waitScreen" class="screen space-y-6">
        <h2 id="waitTitle" class="text-3xl font-bold text-gray-900">Oda Kuruluyor...</h2>
        <div id="codeArea" class="space-y-3 hidden">
            <p class="text-lg text-gray-700">Oda Kodunuz:</p>
            <div id="roomCodeDisplay" class="code-display"></div>
            <button id="copyCodeBtn" class="btn bg-gray-600 text-white text-base py-2 max-w-xs">Kopyala</button>
        </div>
        <p id="waitStatus" class="text-lg text-gray-700"></p>
        <button id="cancelBtn" class="btn bg-red-600 text-base py-3 max-w-xs">Ä°ptal Et</button>
    </div>

    <div id="gameScreen" class="screen active space-y-6">
        <h1 class="text-5xl font-black text-gray-900">ğŸ•¹ï¸ Emoji Bomb</h1>
        
        <div class="flex justify-between w-full text-gray-800 font-bold">
            <p>Sen: <span id="myLives" class="text-green-600">â¤ï¸â¤ï¸</span></p>
            <p>Rakip: <span id="opponentName" class="text-blue-600"></span></p>
            <p>Rakip Can: <span id="opponentLives" class="text-green-600">â¤ï¸â¤ï¸</span></p>
        </div>
        <p id="roleStatus" class="text-gray-700"></p>

        <div id="gameContent" class="p-6 bg-gray-200 rounded-lg w-full space-y-4">
            <h3 id="turnStatus" class="text-2xl font-bold text-red-600">Rakip bekleniyor...</h3>
            <p id="actionMessage" class="text-base text-purple-600 font-semibold"></p>
            
            <div id="gameBoard" class="grid w-full max-w-sm mx-auto" style="grid-template-columns: repeat(6, 1fr);">
                </div>
            
        </div>
        
        <button id="endGameBtn" class="btn bg-gray-600 text-white text-base py-3 max-w-xs">Oyunu Bitir</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ReferanslarÄ± ve DeÄŸiÅŸkenler ---
            const screens = { lobby: document.getElementById('lobby'), wait: document.getElementById('waitScreen'), game: document.getElementById('gameScreen') };
            // ... (diÄŸer DOM referanslarÄ± aynÄ± kalÄ±r)
            const gameBoardEl = document.getElementById('gameBoard');
            const turnStatusEl = document.getElementById('turnStatus');
            const actionMessageEl = document.getElementById('actionMessage');
            const myLivesEl = document.getElementById('myLives');
            const opponentLivesEl = document.getElementById('opponentLives');
            const opponentNameEl = document.getElementById('opponentName');
            const roleStatusEl = document.getElementById('roleStatus');
            
            // SESLER
            const audioBomb = new Audio('sound1.mp3'); 
            const audioEmoji = new Audio('sound2.mp3');
            const audioWait = new Audio('sound3.mp3'); 
            
            // OYUN DURUMU
            let socket;
            let currentRoomCode = '';
            let username = '';
            let isHost = false;
            let selectedBombs = []; // SeÃ§im aÅŸamasÄ±nda kendi seÃ§tiÄŸimiz bombalar
            let level = 1; 
            const LEVELS = [18, 22, 28]; // Kart sayÄ±larÄ±
            let gameStage = 'SELECTION'; // 'SELECTION' (bomba seÃ§me) veya 'PLAY' (kart aÃ§ma)
            
            let gameData = {
                board: [], // {opened: false, emoji: '?', isBomb: false}
                turn: 0,   // 0: Host, 1: Guest
                hostLives: 2,
                guestLives: 2,
                cardsLeft: 0,
                hostBombs: [], // Rakip iÃ§in gizli bombalar
                guestBombs: [], // Rakip iÃ§in gizli bombalar
                //... diÄŸer durumlar
            };
            
            const EMOTICONS = ['ğŸ™‚', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ˜', 'ğŸ¤©', 'ğŸ‘', 'ğŸ‰', 'ğŸŒŸ', 'ğŸ•', 'ğŸ±'];

            // Render URL'niz (KENDÄ° URL'nizle deÄŸiÅŸtirin)
            const LIVE_SERVER_URL = 'https://beta-github-io.onrender.com'; 
            
            // --- Temel Fonksiyonlar ---
            function showGlobalMessage(message, isError = true) {
                // ... (AynÄ± kalÄ±r)
                globalMessageText.textContent = message;
                globalMessage.classList.remove('bg-red-600', 'bg-green-600');
                globalMessage.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
                globalMessage.classList.remove('hidden');
                globalMessage.classList.add('show');
                setTimeout(() => { globalMessage.classList.add('hidden'); globalMessage.classList.remove('show'); }, 4000);
            }
            function showScreen(screenId) {
                 Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenId].classList.add('active');
            }
            // ... (resetGame, validateInput aynÄ± kalÄ±r)
            
            // --- OYUN MANTIÄI ---

            function initializeGame(initialBoardSize) {
                gameData.board = Array(initialBoardSize).fill(null).map(() => ({
                    opened: false,
                    content: '?',
                    isBomb: false
                }));
                gameData.cardsLeft = initialBoardSize;
                gameData.hostLives = 2;
                gameData.guestLives = 2;
                gameData.hostBombs = [];
                gameData.guestBombs = [];
                selectedBombs = [];
                gameData.turn = 0; // Host BaÅŸlar
                gameStage = 'SELECTION'; 
            }
            
            function drawBoard() {
                const boardSize = LEVELS[level - 1];
                gameBoardEl.style.gridTemplateColumns = `repeat(${boardSize <= 22 ? 6 : 7}, 1fr)`; // 18, 22 iÃ§in 6 sÃ¼tun, 28 iÃ§in 7 sÃ¼tun
                gameBoardEl.innerHTML = '';
                
                gameData.board.forEach((cardState, index) => {
                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'card-container aspect-square';

                    const card = document.createElement('div');
                    card.className = `card cursor-pointer`;
                    card.dataset.index = index;

                    const front = document.createElement('div');
                    front.className = 'card-face card-front text-gray-100';
                    front.textContent = '?';
                    
                    const back = document.createElement('div');
                    back.className = 'card-face card-back';
                    back.textContent = cardState.content;

                    card.appendChild(front);
                    card.appendChild(back);
                    cardContainer.appendChild(card);
                    
                    if (cardState.opened) {
                        card.classList.add('is-flipped');
                    } else {
                        // SeÃ§im aÅŸamasÄ±nda tÄ±klanabilir yap
                        if (gameStage === 'SELECTION') {
                           // Bu aÅŸamada kartÄ± iÅŸaretle
                           if (selectedBombs.includes(index)) {
                                card.classList.add('bomb-selected');
                            }
                        }
                        card.addEventListener('click', handleCardClick);
                    }
                    
                    gameBoardEl.appendChild(cardContainer);
                });
                updateStatusDisplay();
            }

            function updateStatusDisplay() {
                myLivesEl.textContent = 'â¤ï¸'.repeat(isHost ? gameData.hostLives : gameData.guestLives);
                myLivesEl.classList.toggle('text-red-600', (isHost ? gameData.hostLives : gameData.guestLives) <= 1);
                myLivesEl.classList.toggle('text-green-600', (isHost ? gameData.hostLives : gameData.guestLives) > 1);
                
                opponentLivesEl.textContent = 'â¤ï¸'.repeat(isHost ? gameData.guestLives : gameData.hostLives);
                opponentLivesEl.classList.toggle('text-red-600', (isHost ? gameData.guestLives : gameData.hostLives) <= 1);
                opponentLivesEl.classList.toggle('text-green-600', (isHost ? gameData.guestLives : gameData.hostLives) > 1);

                const isMyTurn = (isHost && gameData.turn === 0) || (!isHost && gameData.turn === 1);

                if (gameStage === 'SELECTION') {
                    if (selectedBombs.length < 3) {
                        turnStatusEl.textContent = `Bomba SeÃ§: ${selectedBombs.length} / 3`;
                        actionMessageEl.textContent = "3 adet gizli bombayÄ± seÃ§in.";
                        turnStatusEl.classList.add('text-green-600');
                    } else {
                        turnStatusEl.textContent = `Rakip BombasÄ±nÄ± SeÃ§iyor...`;
                        actionMessageEl.textContent = "SeÃ§iminiz tamamlandÄ±. Rakibi bekleyin.";
                        turnStatusEl.classList.add('text-red-600');
                    }
                } else if (gameStage === 'PLAY') {
                    if (isMyTurn) {
                        turnStatusEl.textContent = 'SIRA SENDE!';
                        turnStatusEl.classList.add('text-green-600');
                        actionMessageEl.textContent = "Bir kart aÃ§!";
                    } else {
                        turnStatusEl.textContent = 'RAKÄ°BÄ°N SIRASI';
                        turnStatusEl.classList.add('text-red-600');
                        actionMessageEl.textContent = "Rakibin hareketini bekle.";
                    }
                }
                
                // Oyun Bitti KontrolÃ¼
                if (gameData.hostLives <= 0 || gameData.guestLives <= 0) {
                     endGame(gameData.hostLives <= 0 ? 'Guest' : 'Host');
                }
            }

            // --- ANIMASYON VE SES ---

            function startVibration() {
                const cardContainers = gameBoardEl.querySelectorAll('.card-container');
                cardContainers.forEach(container => {
                    const card = container.querySelector('.card');
                    if (!card.classList.contains('is-flipped')) {
                        card.classList.add('vibrate');
                    }
                });
                audioWait.play().catch(() => {}); // Ses Ã§alma hatasÄ± yÃ¶netimi
            }

            function stopVibration() {
                const cardContainers = gameBoardEl.querySelectorAll('.card-container');
                 cardContainers.forEach(container => {
                    const card = container.querySelector('.card');
                    card.classList.remove('vibrate');
                });
                audioWait.pause();
                audioWait.currentTime = 0;
            }
            
            async function triggerWaitAndVibrate() {
                 if (gameData.cardsLeft < 8 && gameStage === 'PLAY') { // Kalan kart sayÄ±sÄ± azaldÄ±ysa
                    startVibration();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    stopVibration();
                }
            }

            // --- KART TIKLAMA VE VERÄ° GÃ–NDERME ---
            
            function handleCardClick(event) {
                const cardElement = event.currentTarget.querySelector('.card');
                const cardIndex = parseInt(cardElement.dataset.index);

                if (gameStage === 'SELECTION') {
                    // Bomba SeÃ§im AÅŸamasÄ±
                    if (selectedBombs.includes(cardIndex)) {
                        selectedBombs = selectedBombs.filter(i => i !== cardIndex);
                    } else if (selectedBombs.length < 3) {
                        selectedBombs.push(cardIndex);
                    }
                    drawBoard(); // TahtayÄ± tekrar Ã§iz, seÃ§imi gÃ¶ster
                    
                    if (selectedBombs.length === 3) {
                        // 3 bomba seÃ§ildi, rakibe gÃ¶nder
                        socket.emit('bombSelectionComplete', { roomCode: currentRoomCode, bombs: selectedBombs });
                        updateStatusDisplay();
                    }
                } else if (gameStage === 'PLAY') {
                    // Kart AÃ§ma AÅŸamasÄ±
                    const isMyTurn = (isHost && gameData.turn === 0) || (!isHost && gameData.turn === 1);
                    if (!isMyTurn || gameData.board[cardIndex].opened || gameData.isGameOver) return; 
                    
                    sendMove(cardIndex);
                }
            }
            
            function sendMove(index) {
                if (socket && socket.connected) {
                    socket.emit('gameData', {
                        roomCode: currentRoomCode,
                        type: 'MOVE',
                        cardIndex: index,
                    });
                }
            }

            // --- HAREKETÄ° UYGULAMA (KART AÃ‡MA) ---
            
            async function applyMove(index, nextTurn) {
                if (gameData.board[index].opened) return;

                await triggerWaitAndVibrate(); // Bekleme ve titreÅŸim

                // KartÄ± aÃ§
                gameData.board[index].opened = true;
                gameData.cardsLeft -= 1;
                
                // BombayÄ± kontrol et (Kendi rolÃ¼ne gÃ¶re rakibin bombasÄ±nÄ± kontrol et)
                const opponentBombs = isHost ? gameData.guestBombs : gameData.hostBombs;
                const hitBomb = opponentBombs.includes(index);
                
                if (hitBomb) {
                    // BOMBA!
                    gameData.board[index].content = 'ğŸ’£';
                    const myLives = isHost ? --gameData.hostLives : --gameData.guestLives;
                    
                    audioBomb.play().catch(() => {});
                    showGlobalMessage(`BOOM! Bomba buldun. Kalan can: ${myLives}`, true);
                } else {
                    // GÃœVENLÄ°
                    gameData.board[index].content = EMOTICONS[Math.floor(Math.random() * EMOTICONS.length)];
                    audioEmoji.play().catch(() => {});
                }
                
                // Animasyon iÃ§in local Ã§izim
                drawBoard(); 
                
                // 1 saniye sonra sÄ±rayÄ± deÄŸiÅŸtir
                setTimeout(() => {
                    gameData.turn = nextTurn;
                    updateStatusDisplay();
                    
                    // EÄŸer oyun bittiyse (can kalmadÄ±ysa)
                    if (gameData.hostLives <= 0 || gameData.guestLives <= 0) {
                        endGame(gameData.hostLives <= 0 ? 'Guest' : 'Host');
                    }
                    
                }, 1000); // Kart aÃ§Ä±lma animasyonu sÃ¼resi kadar bekle
            }
            
            function endGame(winnerRole) {
                gameData.isGameOver = true;
                gameStage = 'ENDED';
                turnStatusEl.textContent = `OYUN BÄ°TTÄ°! KAZANAN: ${winnerRole}!`;
                actionMessageEl.textContent = `Tebrikler. Yeni seviyeye geÃ§iliyor...`;
                
                // Bir sonraki seviyeye geÃ§iÅŸ
                setTimeout(() => {
                    if (level < LEVELS.length) {
                        level++;
                        showGlobalMessage(`Yeni Seviye: ${LEVELS[level-1]} Kart!`, false);
                        
                        // Oyunu yeniden baÅŸlatma sinyalini Host'un gÃ¶ndermesi idealdir.
                        if (isHost) {
                            socket.emit('nextLevel', { roomCode: currentRoomCode, newLevel: level });
                        }
                    } else {
                         showGlobalMessage("Oyunun tÃ¼m seviyeleri tamamlandÄ±!", false);
                         resetGame();
                    }
                }, 4000);
            }


            // --- SOCKET.IO Ä°ÅLEYÄ°CÄ°LERÄ° ---

            // Socket.IO BaÄŸlantÄ±sÄ± (AynÄ± kalÄ±r)
            // ... (connectToServer fonksiyonu aynÄ± kalÄ±r, LIVE_SERVER_URL'nizle)
            
            // ODA OLUÅTURMA VE KATILMA (AynÄ± KalÄ±r)
            // ... (matchBtn olay dinleyicisi aynÄ± kalÄ±r)

            
            // gameStart OlayÄ± (Yeni MantÄ±k)
            socket.on('gameStart', (players) => {
                const opponent = players.find(p => p.id !== socket.id);
                const self = players.find(p => p.id === socket.id);

                opponentNameEl.textContent = opponent.username;
                isHost = self.isHost;
                roleStatusEl.textContent = isHost ? "RolÃ¼nÃ¼z: HOST" : "RolÃ¼nÃ¼z: GUEST";
                
                showGlobalMessage(`Oyun ${opponent.username} ile baÅŸladÄ±! Bomba seÃ§imine geÃ§iliyor.`, false);
                
                initializeGame(LEVELS[level - 1]); // Mevcut seviye kart sayÄ±sÄ± ile baÅŸlat
                drawBoard(); 
                updateStatusDisplay();
                showScreen('game');
            });
            
            // Bomb SeÃ§imi TamamlandÄ± (Rakip BombasÄ±nÄ± GÃ¶nderdi)
            socket.on('bombSelectionComplete', ({ isHost, bombs }) => {
                if (isHost) {
                    gameData.hostBombs = bombs;
                } else {
                    gameData.guestBombs = bombs;
                }
                
                // EÄŸer iki taraf da seÃ§imi tamamladÄ±ysa
                if (gameData.hostBombs.length === 3 && gameData.guestBombs.length === 3) {
                    gameStage = 'PLAY';
                    showGlobalMessage('Herkes bombasÄ±nÄ± seÃ§ti! Kart aÃ§ma aÅŸamasÄ± baÅŸlÄ±yor.', false);
                    drawBoard(); // Kart seÃ§im iÅŸaretlerini kaldÄ±rÄ±r
                } else {
                    actionMessageEl.textContent = "Rakip bombasÄ±nÄ± seÃ§ti. LÃ¼tfen siz de 3 bomba seÃ§in.";
                }
                updateStatusDisplay();
            });

            // gameData OlayÄ± (Rakibin Hareketi Geldi)
            socket.on('gameData', (data) => {
                if (gameStage !== 'PLAY') return;
                
                if (data.type === 'MOVE') {
                    const opponentTurn = gameData.turn; // Hareket eden tarafÄ±n sÄ±rasÄ±
                    const nextTurn = 1 - opponentTurn; // SÄ±ra deÄŸiÅŸecek
                    
                    // Rakibin hareketini uygula
                    applyMove(data.cardIndex, nextTurn); 
                    
                    // Rakibin hareketi olduÄŸu iÃ§in, canlar zaten applyMove iÃ§inde azalÄ±r
                }
            });

            // Seviye Atlama Sinyali (Sadece Host gÃ¶nderir)
             socket.on('nextLevel', ({ newLevel }) => {
                level = newLevel;
                showGlobalMessage(`Yeni Seviye: ${LEVELS[level-1]} Kart! Tekrar Bomb SeÃ§imi BaÅŸlÄ±yor...`, false);
                initializeGame(LEVELS[level - 1]);
                drawBoard();
                updateStatusDisplay();
            });

            // ... (DiÄŸer socket olaylarÄ± aynÄ± kalÄ±r)
            
            // --- Olay Dinleyicileri (Lobi ve BaÄŸlantÄ±) ---
            // ... (matchBtn, cancelBtn, endGameBtn, copyCodeBtn aynÄ± kalÄ±r)
            
            // BaÅŸlangÄ±Ã§ta sunucuya baÄŸlan
            // connectToServer(); // Bu fonksiyonu manuel olarak kendiniz Ã§aÄŸÄ±rmalÄ±sÄ±nÄ±z.
        });
    </script>
</body>
</html>
