<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💣 Emoji Bomb 1v1</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tone.js (Ses efektleri için) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ana Stiller ve Arka Plan */
        body {
            font-family: 'Inter', sans-serif;
            /* Gradient arka plan */
            background: linear-gradient(to bottom right, #1a1a1a, #333333);
            color: #f0f0f0;
            overflow: hidden; /* Tam ekran, kaydırma yok */
        }

        /* Ana ekran konteyneri */
        .screen {
            width: 100vw;
            height: 100vh;
            display: none; /* Varsayılan olarak gizli */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            box-sizing: border-box;
            text-align: center;
        }
        
        /* Aktif ekranı göster */
        .screen.active {
            display: flex;
        }

        /* Yükleniyor Ekranı Animasyonu */
        @keyframes pulse-spin {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
        }
        .loader-anim {
            animation: pulse-spin 2.5s infinite ease-in-out;
        }
        
        /* Büyük Buton Stilleri */
        .btn {
            @apply w-full max-w-xs text-xl font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-500 active:scale-95;
        }
        .btn-secondary {
            @apply bg-green-600 text-white hover:bg-green-500 active:scale-95;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-500 active:scale-95;
        }
        
        /* Giriş Alanları */
        .input-field {
            @apply w-full max-w-xs text-lg bg-gray-700 text-white border-2 border-gray-600 rounded-lg p-4 text-center placeholder-gray-400 focus:outline-none focus:border-blue-500;
        }

        /* Bağlantı Metin Alanları (Offer/Answer) */
        .signal-textarea {
            @apply w-full max-w-md h-24 text-xs bg-gray-800 text-gray-300 rounded-lg p-2 border border-gray-600 resize-none;
        }

        /* 3D Kart Döndürme Animasyonu */
        .card-container {
            perspective: 1000px;
            aspect-ratio: 1 / 1; /* Kare kartlar */
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-container.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            @apply rounded-lg shadow-md flex items-center justify-center;
        }
        .card-front {
            @apply bg-blue-500 text-3xl;
        }
        .card-back {
            @apply bg-gray-600 text-4xl;
            transform: rotateY(180deg);
        }

        /* Sarsıntı (Shake) Animasyonu - Bomba */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake {
            animation: shake 0.4s ease-in-out;
        }

        /* Titreşim (Vibrate) Animasyonu - Az Kart Kaldığında */
        @keyframes vibrate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1.5deg); }
            75% { transform: rotate(-1.5deg); }
        }
        .vibrating {
            animation: vibrate 0.2s infinite;
        }
        
        /* Oyun Sonu Ekranı Overlay */
        #endScreen {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100;
        }

        /* Global Mesaj */
        #globalMessage.show {
            display: block;
            animation: fadeInDown 0.3s ease-out;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white select-none">

    <!-- Global Mesaj Kutusu -->
    <div id="globalMessage" class="hidden fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg z-50">
        <p id="globalMessageText"></p>
        <button id="globalMessageClose" class="absolute top-2 right-3 text-2xl font-bold">&times;</button>
    </div>

    <!-- 1. Yükleniyor Ekranı -->
    <div id="loader" class="screen active">
        <div class="loader-anim text-center">
            <div class="text-7xl">💣</div>
            <h1 class="text-4xl font-black mt-4">Emoji Bomb</h1>
        </div>
    </div>

    <!-- 2. Lobi Ekranı -->
    <div id="lobby" class="screen">
        <div class="w-full max-w-md space-y-4">
            <h1 class="text-5xl font-black text-center">💣 Emoji Bomb</h1>
            <p class="text-lg text-gray-300 text-center">Arkadaşınla 1v1 oyna! Oda kur veya bir odaya katıl.</p>
            
            <input type="text" id="username" class="input-field" placeholder="Kullanıcı Adı">
            
            <!-- Oda Kodu Girişi kaldırıldı - sunucusuz akışta kafa karıştırıcıydı -->
            <!-- <input type="text" id="roomCodeInput" class="input-field" placeholder="Oda Kodu Gir"> -->
            
            <button id="createRoomBtn" class="btn btn-primary">🎮 Oda Kur</button>
            <button id="joinRoomBtn" class="btn btn-secondary">🔍 Katıl</button>
        </div>
    </div>
    
    <!-- 3. Bağlantı Ekranı (Sinyalleşme) -->
    <div id="connectScreen" class="screen">
        <div class="w-full max-w-lg space-y-3">
            <h2 id="connectTitle" class="text-2xl font-bold">Bağlantı Kuruluyor...</h2>
            
            <!-- Oda Kuran için -->
            <div id="hostConnect" class="space-y-3 hidden">
                <p class="text-lg">Oda Kodu: <strong id="roomCodeDisplay" class="text-2xl text-yellow-400 tracking-widest"></strong></p>
                
                <label class="text-left w-full block">1. Bu Teklif Kodunu kopyala ve arkadaşına gönder:</label>
                <p class="text-xs text-gray-400 text-left"><i>(Not: Bu kodun çok uzun olması normaldir.)</i></p>
                <textarea id="offerText" class="signal-textarea" readonly></textarea>
                <button id="copyOfferBtn" class="btn btn-primary text-sm py-2">Teklifi Kopyala</button>
                
                <label class="text-left w-full block">2. Arkadaşından gelen Cevap Kodunu buraya yapıştır:</label>
                <textarea id="answerTextHost" class="signal-textarea" placeholder="Arkadaşının cevap kodunu bekle..."></textarea>
                
                <p id="hostStatus" class="text-green-400">Bağlantı kuruluyor...</p>
            </div>
            
            <!-- Odaya Katılan için -->
            <div id="guestConnect" class="space-y-3 hidden">
                <label class="text-left w-full block">1. Arkadaşının Teklif Kodunu buraya yapıştır:</label>
                <textarea id="offerTextGuest" class="signal-textarea" placeholder="Arkadaşının teklif kodunu yapıştır..."></textarea>
                
                <button id="createAnswerBtn" class="btn btn-secondary">Cevap Oluştur</button>
                
                <label class="text-left w-full block">2. Bu Cevap Kodunu kopyala ve arkadaşına geri gönder:</label>
                <p class="text-xs text-gray-400 text-left"><i>(Not: Bu kodun çok uzun olması normaldir.)</i></p>
                <textarea id="answerTextGuest" class="signal-textarea" readonly></textarea>
                <button id="copyAnswerBtn" class="btn btn-primary text-sm py-2 hidden">Cevabı Kopyala</button>

                <p id="guestStatus" class="text-green-400">Bağlantı bekleniyor...</p>
            </div>
            <button id="cancelConnectBtn" class="btn btn-danger text-base py-2">İptal Et</button>
        </div>
    </div>

    <!-- 4. Oyun Ekranı -->
    <div id="gameScreen" class="screen">
        <!-- Üst Bilgi (Oyuncular, Canlar) -->
        <div class="w-full max-w-3xl absolute top-0 left-1/2 -translate-x-1/2 p-4">
            <div class="flex justify-between items-center text-lg sm:text-2xl font-bold">
                <div id="player1Info" class="text-left">
                    <span id="player1Name">Oyuncu 1</span>
                    <div id="player1Lives" class="text-3xl">❤️❤️</div>
                </div>
                <div id="player2Info" class="text-right">
                    <span id="player2Name">Oyuncu 2</span>
                    <div id="player2Lives" class="text-3xl">❤️❤️</div>
                </div>
            </div>
            <p id="turnIndicator" class="text-center text-xl sm:text-2xl font-bold text-yellow-400 mt-4"></p>
        </div>
        
        <!-- Oyun Alanı (Grid) -->
        <div id="gameGrid" class="w-full max-w-3xl grid gap-2 sm:gap-3 p-4 mt-32">
            <!-- Kartlar JS ile eklenecek -->
        </div>
    </div>
    
    <!-- 5. Oyun Sonu Ekranı -->
    <div id="endScreen" class="screen absolute top-0 left-0">
        <div class="text-center space-y-6">
            <h1 id="endMessage" class="text-6xl font-black">Kazandın! 🎉</h1>
            <button id="playAgainBtn" class="btn btn-primary">Tekrar Oyna</button>
            <button id="backToLobbyBtn" class="btn btn-secondary text-base py-3">Lobiye Dön</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Referansları ---
            const screens = {
// ... existing code ... */
                game: document.getElementById('gameScreen'),
                end: document.getElementById('endScreen'),
            };
            const globalMessage = document.getElementById('globalMessage');
            const globalMessageText = document.getElementById('globalMessageText');
            const globalMessageClose = document.getElementById('globalMessageClose');

            const usernameInput = document.getElementById('username');
            // const roomCodeInput = document.getElementById('roomCodeInput'); // KALDIRILDI
            const createRoomBtn = document.getElementById('createRoomBtn');
            const joinRoomBtn = document.getElementById('joinRoomBtn');
// ... existing code ... */
            // --- Oyun Durumu (State) ---
            let peerConnection;
            let dataChannel;
// ... existing code ... */
            let bombsToPlace = 0;


            // --- Temel Fonksiyonlar ---

            function showGlobalMessage(message, isError = true) {
                globalMessageText.textContent = message;
                if (isError) {
                    globalMessage.classList.add('bg-red-600');
                    globalMessage.classList.remove('bg-green-600');
                } else {
                    globalMessage.classList.remove('bg-red-600');
                    globalMessage.classList.add('bg-green-600');
                }
                globalMessage.classList.remove('hidden');
                globalMessage.classList.add('show');

                // 3 saniye sonra otomatik gizle
                setTimeout(hideGlobalMessage, 3000);
            }
            
            function hideGlobalMessage() {
                globalMessage.classList.add('hidden');
                globalMessage.classList.remove('show');
            }

            function showScreen(screenId) {
                Object.values(screens).forEach(screen => {
// ... existing code ... */
                        document.body.removeChild(ta);

                        const originalText = btn.textContent;
                        btn.textContent = 'Kopyalandı!';
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 1500);
                    } catch(e) {
                         // alert('Kopyalama başarısız. Lütfen manuel kopyalayın.');
                         showGlobalMessage('Kopyalama başarısız. Lütfen manuel kopyalayın.');
                    }
                });
// ... existing code ... */
                peerConnection = new RTCPeerConnection(config);

                // ICE adayı (ağ yolu) bulunduğunda tetiklenir
                peerConnection.onicecandidate = event => {
                    // event.candidate null olduğunda, ICE toplanması tamamlanmıştır
                    // ve localDescription (offer/answer) hazırdır.
                    if (!event.candidate) {
                        console.log('ICE Toplama tamamlandı (onicecandidate null).');
                        if (isHost) {
                            if(offerText.value.length === 0) { // Sadece ilk kez doldur
                                offerText.value = JSON.stringify(peerConnection.localDescription);
                                hostStatus.textContent = 'Teklifi arkadaşına gönder.';
                            }
                        } else {
                            // Misafir için cevap hazır
                             if(answerTextGuest.value.length === 0) { // Sadece ilk kez doldur
                                answerTextGuest.value = JSON.stringify(peerConnection.localDescription);
                                copyAnswerBtn.classList.remove('hidden');
                                guestStatus.textContent = 'Cevabı arkadaşına gönder.';
                             }
                        }
                    }
                };

                // Ağ durumu değiştiğinde
// ... existing code ... */
                    if (peerConnection.connectionState === 'connected') {
                        hostStatus.textContent = 'Bağlandı!';
                        guestStatus.textContent = 'Bağlandı!';
                        // Oyun başlatma mantığı datachannel onopen'a taşındı
                    }
                    if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                        // alert('Bağlantı koptu veya kurulamadı.');
                        showGlobalMessage('Bağlantı koptu veya kurulamadı.');
                        resetToLobby();
                    }
// ... existing code ... */
                await peerConnection.setLocalDescription(offer);
                
                // Tüm ICE adaylarının toplanmasını bekleme mantığı
                // onicecandidate olayına taşındı.
                /*
                peerConnection.onicegatheringstatechange = () => {
                    if (peerConnection.iceGatheringState === 'complete') {
                        console.log("ICE Toplama tamamlandı. Teklif hazır.");
                        offerText.value = JSON.stringify(peerConnection.localDescription);
                        hostStatus.textContent = 'Teklifi arkadaşına gönder.';
                    }
                };
                */
            }
            
            // Host, misafirden gelen cevabı aldığında
// ... existing code ... */
                    await peerConnection.setLocalDescription(answer);
                    
                    // Cevap hazır olduğunda (ICE toplanınca)
                    // onicecandidate olayına taşındı.
                    /*
                    peerConnection.onicegatheringstatechange = () => {
                        if (peerConnection.iceGatheringState === 'complete') {
                            console.log("ICE Toplama tamamlandı. Cevap hazır.");
                            answerTextGuest.value = JSON.stringify(peerConnection.localDescription);
                            copyAnswerBtn.classList.remove('hidden');
                            guestStatus.textContent = 'Cevabı arkadaşına gönder.';
                        }
                    };
                    */
                    
                } catch (e) {
// ... existing code ... */
            function validateUsername() {
                username = usernameInput.value.trim();
                if (username.length < 2) {
                    // alert('Lütfen geçerli bir kullanıcı adı girin (en az 2 karakter).');
                    showGlobalMessage('Lütfen geçerli bir kullanıcı adı girin (en az 2 karakter).');
                    return false;
                }
// ... existing code ... */
                dataChannel.onclose = () => {
                    console.log('Data Channel KAPALI!');
                    // alert('Rakibin bağlantısı koptu.');
                    if (screens.lobby.classList.contains('active') == false) { // Sadece oyun ekranındaysa bu hatayı ver
                        showGlobalMessage('Rakibin bağlantısı koptu.');
                    }
                    resetToLobby();
                };
                
// ... existing code ... */
                }
            });
            
            createRoomBtn.addEventListener('click', initCreateRoom);
            joinRoomBtn.addEventListener('click', initJoinRoom);
            cancelConnectBtn.addEventListener('click', resetToLobby);
            
            // Global Mesaj Kapatma
            globalMessageClose.addEventListener('click', hideGlobalMessage);

            // Sinyal Kopyalama Butonları
            copyOfferBtn.addEventListener('click', () => copyToClipboard(offerText.value, copyOfferBtn));
// ... existing code ... */
                if (offerTextGuest.value) {
                    receiveOfferAndCreateAnswer(offerTextGuest.value);
                } else {
                    // alert('Lütfen önce arkadaşının teklif kodunu yapıştır.');
                    showGlobalMessage('Lütfen önce arkadaşının teklif kodunu yapıştır.');
                }
            });
// ... existing code ... */

