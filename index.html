<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amerikan Damasƒ± - Online Multiplayer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Socket.io CDN -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* Professional Animations */
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 
                           0 0 40px rgba(239, 68, 68, 0.3),
                           0 0 60px rgba(239, 68, 68, 0.1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.8), 
                           0 0 60px rgba(239, 68, 68, 0.5),
                           0 0 80px rgba(239, 68, 68, 0.3);
            }
        }
        
        @keyframes float-animation {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes slide-in {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes piece-glow {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.8),
                           0 0 30px rgba(255, 215, 0, 0.5);
            }
            50% { 
                box-shadow: 0 0 25px rgba(255, 215, 0, 1),
                           0 0 50px rgba(255, 215, 0, 0.7);
            }
        }
        
        @keyframes valid-move-pulse {
            0%, 100% { 
                background-color: rgba(34, 197, 94, 0.3);
                box-shadow: inset 0 0 20px rgba(34, 197, 94, 0.6);
            }
            50% { 
                background-color: rgba(34, 197, 94, 0.5);
                box-shadow: inset 0 0 30px rgba(34, 197, 94, 0.8);
            }
        }
        
        .animate-pulse-glow { animation: pulse-glow 2s infinite ease-in-out; }
        .animate-float { animation: float-animation 3s infinite ease-in-out; }
        .animate-slide-in { animation: slide-in 0.5s ease-out; }
        .animate-piece-glow { animation: piece-glow 1.5s infinite ease-in-out; }
        .animate-valid-move { animation: valid-move-pulse 1s infinite ease-in-out; }
        
        .title-glow { 
            text-shadow: 0 0 20px #ef4444, 
                        0 0 40px #ef4444, 
                        0 0 60px #ef4444;
        }
        
        .button-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button-red:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        }
        
        .button-red::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .button-red:hover::before {
            left: 100%;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: min(95vw, 95vh);
            height: min(95vw, 95vh);
            max-width: 600px;
            max-height: 600px;
            border: 8px solid #1e293b;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            overflow: hidden;
            touch-action: manipulation;
            margin: 0 auto;
            background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
            aspect-ratio: 1;
        }
        
        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .cell-black { 
            background: linear-gradient(135deg, #374151, #1f2937);
        }
        
        .cell-white { 
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
        }
        
        .cell:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .piece {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1rem, 4vw, 2rem);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            border: 2px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .piece-white { 
            background: linear-gradient(145deg, #ffffff, #f3f4f6); 
            color: #1f2937; 
            border-color: #d1d5db;
        }
        
        .piece-black { 
            background: linear-gradient(145deg, #1f2937, #111827); 
            color: #ffffff; 
            border-color: #4b5563;
        }
        
        .piece-king { 
            animation: piece-glow 2s infinite ease-in-out;
        }
        
        .piece-king-white { 
            background: linear-gradient(145deg, #fef3c7, #fbbf24); 
            border-color: #f59e0b;
            color: #78350f;
        }
        
        .piece-king-black { 
            background: linear-gradient(145deg, #4b5563, #374151); 
            border-color: #fbbf24;
            color: #fbbf24;
        }
        
        .piece.selected {
            animation: piece-glow 1s infinite ease-in-out;
            transform: scale(1.1);
        }
        
        .valid-move {
            background-color: rgba(34, 197, 94, 0.4) !important;
            box-shadow: inset 0 0 20px rgba(34, 197, 94, 0.8);
            animation: valid-move-pulse 1s infinite ease-in-out;
        }
        
        .current-turn-piece {
            animation: piece-glow 2s infinite ease-in-out;
        }
    </style>
    <script>
        // Socket.io baƒülantƒ±sƒ±
        const socket = io('https://mario-io-1.onrender.com');
        
        // Oyun durumu
        let gameState = {
            board: [],
            currentTurn: 'red',
            selectedPiece: null,
            myColor: null,
            isMyTurn: false,
            roomCode: null,
            isSearching: false,
            gameStarted: false
        };
        
        // UI elementl…ôri
        const loader = document.getElementById('loader');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const connectionStatus = document.getElementById('connection-status');
        const dereceliBtn = document.getElementById('dereceli-btn');
        const friendBtn = document.getElementById('friend-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const lobiStatusMessage = document.getElementById('lobi-status-message');
        const roomCodeOutput = document.getElementById('room-code-output');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const joinRoomInput = document.getElementById('join-room-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const boardElement = document.getElementById('board');
        const currentTurnDisplay = document.getElementById('current-turn-display');
        const turnText = document.getElementById('turn-text');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Sabitl…ôr
        const BOARD_SIZE = 8;

        // --- Socket.io Eventl…ôri ---
        
        socket.on('connect', () => {
            connectionStatus.textContent = 'Server…ô qo≈üuldu!';
            connectionStatus.classList.remove('text-yellow-400');
            connectionStatus.classList.add('text-green-500');
            showScreen('lobby');
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'Serverl…ô …ôlaq…ô k…ôsildi';
            connectionStatus.classList.remove('text-green-500');
            connectionStatus.classList.add('text-red-500');
            showModal('Serverl…ô …ôlaq…ô k…ôsildi. S…ôhif…ôni yenil…ôyin.');
        });

        socket.on('matchFound', (data) => {
            gameState.roomCode = data.roomCode;
            gameState.myColor = data.color;
            gameState.gameStarted = true;
            gameState.isSearching = false;
            gameState.board = createInitialBoard();
            
            lobiStatusMessage.textContent = `R…ôqib tapƒ±ldƒ±! Siz ${gameState.myColor === 'red' ? 'Qƒ±rmƒ±zƒ±' : 'Aƒü'} r…ôngind…ôsiniz.`;
            showScreen('game');
            updateGameUI();
        });

        socket.on('roomCreated', (data) => {
            gameState.roomCode = data.roomCode;
            gameState.myColor = 'red';
            roomCodeOutput.textContent = data.roomCode;
            lobiStatusMessage.textContent = `Otaq kodu: ${data.roomCode}. R…ôqib g√∂zl…ônilir...`;
        });

        socket.on('opponentJoined', (data) => {
            gameState.gameStarted = true;
            gameState.isMyTurn = gameState.myColor === 'red';
            gameState.board = createInitialBoard();
            lobiStatusMessage.textContent = 'R…ôqib qo≈üuldu! Oyun ba≈ülayƒ±r...';
            showScreen('game');
            updateGameUI();
        });

        socket.on('gameUpdate', (data) => {
            gameState.board = data.board;
            gameState.currentTurn = data.currentTurn;
            gameState.isMyTurn = gameState.currentTurn === gameState.myColor;
            updateGameUI();
        });

        socket.on('gameOver', (data) => {
            showModal(`Oyun bitdi! Qalib: ${data.winner === gameState.myColor ? 'Siz' : 'R…ôqib'}`);
            setTimeout(() => leaveGame(), 3000);
        });

        socket.on('error', (message) => {
            showModal(message);
            gameState.isSearching = false;
            showScreen('lobby');
        });

        // --- Yardƒ±m√ßƒ± Funksiyalar ---

        function showModal(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function showScreen(screen) {
            loader.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            cancelBtn.classList.add('hidden');

            if (screen === 'lobby') {
                lobbyScreen.classList.remove('hidden');
                lobiStatusMessage.textContent = 'Oyun rejimi se√ßin.';
                gameState.isSearching = false;
            } else if (screen === 'game') {
                gameScreen.classList.remove('hidden');
            } else if (screen === 'searching') {
                lobbyScreen.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                lobiStatusMessage.textContent = 'R…ôqib axtarƒ±lƒ±r... L√ºtf…ôn g√∂zl…ôyin.';
                gameState.isSearching = true;
            } else {
                loader.classList.remove('hidden');
            }
        }

        function createInitialBoard() {
            const board = [];
            for (let r = 0; r < BOARD_SIZE; r++) {
                board[r] = new Array(BOARD_SIZE).fill(0);
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if ((r + c) % 2 !== 0) {
                        if (r < 3) {
                            board[r][c] = 1; // Qƒ±rmƒ±zƒ± da≈ü
                        } else if (r > 4) {
                            board[r][c] = 2; // Aƒü da≈ü
                        }
                    }
                }
            }
            return board;
        }

        function generateRoomCode() {
            return String(Math.floor(1000 + Math.random() * 9000));
        }

        // --- Dama M…ôntiqi ---

        function isValidCell(r, c) { 
            return r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE; 
        }

        function getPiecePlayer(pieceValue) {
            if (pieceValue === 1 || pieceValue === 3) return 'red';
            if (pieceValue === 2 || pieceValue === 4) return 'white';
            return null;
        }

        function isKing(r, player) {
            return (player === 'white' && r === 0) || (player === 'red' && r === BOARD_SIZE - 1);
        }

        function findJumps(board, r, c, player) {
            const piece = board[r][c];
            const isKingPiece = piece === 3 || piece === 4;
            const jumps = [];
            const directions = isKingPiece ? [[-1, -1], [-1, 1], [1, -1], [1, 1]] :
                player === 'red' ? [[1, -1], [1, 1]] : [[-1, -1], [-1, 1]];

            for (const [dr, dc] of directions) {
                const capturedR = r + dr;
                const capturedC = c + dc;
                const landR = r + 2 * dr;
                const landC = c + 2 * dc;

                if (isValidCell(landR, landC) && board[landR][landC] === 0) {
                    const capturedPieceValue = board[capturedR][capturedC];
                    const capturedPlayer = getPiecePlayer(capturedPieceValue);

                    if (capturedPlayer && capturedPlayer !== player) {
                        jumps.push({ from: { r, c }, to: { r: landR, c: landC }, captured: { r: capturedR, c: capturedC } });
                    }
                }
            }
            return jumps;
        }

        function findValidMoves(board, r, c, player) {
            const moves = [];
            const piece = board[r][c];
            const isKingPiece = piece === 3 || piece === 4;
            
            // Yem…ô h…ôr…ôk…ôtl…ôrini yoxla
            const jumps = findJumps(board, r, c, player);
            if (jumps.length > 0) return jumps;
            
            // Adi h…ôr…ôk…ôtl…ôri yoxla
            const directions = isKingPiece ? [[-1, -1], [-1, 1], [1, -1], [1, 1]] :
                player === 'red' ? [[1, -1], [1, 1]] : [[-1, -1], [-1, 1]];

            for (const [dr, dc] of directions) {
                const newR = r + dr;
                const newC = c + dc;

                if (isValidCell(newR, newC) && board[newR][newC] === 0) {
                    moves.push({ from: { r, c }, to: { r: newR, c: newC } });
                }
            }
            return moves;

        function isValidMove(board, fromR, fromC, toR, toC, player) {
            const moves = findValidMoves(board, fromR, fromC, player);
            return moves.some(move => move.to.r === toR && move.to.c === toC);
        }
        // 2. Dostla Oyna (Otaq Yarat)
        createRoomBtn.onclick = async () => {
            if (!currentUserId) return showModal("Sistem…ô giri≈ü edilm…ôyib.");
            showScreen('loading');

            const roomCode = generateRoomCode();
            const roomRef = doc(db, ROOMS_COLLECTION, roomCode);

            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (roomDoc.exists()) throw new Error("Otaq kodu artƒ±q m√∂vcuddur. Yenid…ôn c…ôhd edin.");

                    const initialBoard = createInitialBoard();

                    transaction.set(roomRef, {
                        roomId: roomCode,
                        status: 'waiting_for_friend',
                        creator: { id: currentUserId, name: currentUserName },
                        opponent: null,
                        board: initialBoard,
                        turn: 'black',
                        playerBlackId: currentUserId,
                        playerWhiteId: null,
                        lastMoveTimestamp: serverTimestamp(),
                        timers: { white: TIMER_DURATION, black: TIMER_DURATION },
                        mandatoryCapture: null,
                    });
                });
                currentRoomId = roomCode;
                roomCodeOutput.textContent = roomCode;
                lobiStatusMessage.textContent = `Otaq yaratƒ±ldƒ±: ${roomCode}. R…ôqib g√∂zl…ônilir...`;
                listenToRoom(roomCode);
                // Lobiya ekranƒ±na qayƒ±dƒ±rƒ±q, lakin status mesajƒ± il…ô
                showScreen('lobby');
            } catch (error) {
                console.error("Otaq yaratmaq x…ôtasƒ±:", error);
                showModal(`Otaq yaratmaq m√ºmk√ºn olmadƒ±: ${error.message}`);
                showScreen('lobby');
            }
        };

        // Kodu Kopyala
        copyCodeBtn.onclick = () => {
            const code = roomCodeOutput.textContent;
            if (code && code !== '...') {
                try {
                    // Deprecated olsa da, iFrame √º√ß√ºn …ôn etibarlƒ± kopyalama metodu
                    const tempInput = document.createElement('input');
                    document.body.appendChild(tempInput);
                    tempInput.value = code;
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showModal(`Otaq kodu (${code}) kopyalandƒ±!`);
                } catch (err) {
                    showModal("Kopyalama x…ôtasƒ±: L√ºtf…ôn kodu …ôl il…ô kopyalayƒ±n.");
                }
            }
        };

        // 3. Koda Qo≈üul
        joinRoomBtn.onclick = () => {
            const roomCode = joinRoomInput.value.trim();
            if (roomCode.length !== 4) return showModal("Xahi≈ü edirik, 4 r…ôq…ômli otaq kodunu daxil edin.");
            if (!currentUserId) return showModal("Sistem…ô giri≈ü edilm…ôyib.");

            joinRoom(roomCode, false);
        };

        async function joinRoom(roomId, isRanked) {
            if (unsubscribeRoom) unsubscribeRoom();

            const roomRef = doc(db, ROOMS_COLLECTION, roomId);
            currentRoomId = roomId;

            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);

                    if (!roomDoc.exists()) {
                        currentRoomId = null;
                        throw new Error("Bel…ô bir otaq kodu tapƒ±lmadƒ±.");
                    }

                    const roomData = roomDoc.data();

                    const isWaiting = roomData.status === 'waiting_for_friend' || roomData.status === 'waiting_for_ranked_opponent';
                    const isMyRoom = roomData.playerBlackId === currentUserId || roomData.playerWhiteId === currentUserId;

                    if (!isWaiting && !isMyRoom) {
                        currentRoomId = null;
                        throw new Error("Otaq doludur v…ô ya oyun gedir.");
                    }

                    if (isWaiting && roomData.playerBlackId !== currentUserId) {
                        // R…ôqib kimi qo≈üulur
                        transaction.update(roomRef, {
                            opponent: { id: currentUserId, name: currentUserName },
                            status: 'playing',
                            playerWhiteId: currentUserId,
                            timers: { white: TIMER_DURATION, black: TIMER_DURATION }
                        });
                    }
                    // ∆èg…ôr otaq yaradƒ±cƒ±sƒ±dƒ±rsa (isMyRoom) sad…ôc…ô yenid…ôn qo≈üulur (reload)

                });

                listenToRoom(roomId);
            } catch (error) {
                console.error("Otaƒüa qo≈üulmaq x…ôtasƒ±:", error);
                showModal(error.message);
                showScreen('lobby');
            }
        }

        // Oyunu t…ôrk etm…ôk
        leaveGameBtn.onclick = () => leaveGame();

        async function leaveGame() {
            if (!currentRoomId || !currentUserId) return;
            showScreen('loading');

            if (unsubscribeRoom) {
                unsubscribeRoom();
                unsubscribeRoom = null;
            }
            clearInterval(timerInterval);
            timerInterval = null;

            const roomRef = doc(db, ROOMS_COLLECTION, currentRoomId);

            try {
                 await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;

                    const roomData = roomDoc.data();
                    const myColor = (roomData.playerBlackId === currentUserId) ? 'Qara' : 'Aƒü';
                    const opponentColor = myColor === 'Qara' ? 'Aƒü' : 'Qara';

                    if (roomData.status.startsWith('waiting')) {
                        // G√∂zl…ôy…ôn otaqdƒ±rsa, sil
                        transaction.delete(roomRef);
                    } else if (roomData.status === 'playing') {
                        // ∆èg…ôr m…ôn √ßƒ±xƒ±ramsa, dig…ôr oyun√ßu qalib g…ôlir
                        const winnerName = (opponentColor === 'Qara') ? roomData.creator?.name || 'Qara Oyun√ßu' : roomData.opponent?.name || 'Aƒü Oyun√ßu';

                        transaction.update(roomRef, {
                            status: 'finished',
                            winner: winnerName,
                            reason: `${currentUserName} (${myColor}) oyunu t…ôrk etdi. ${opponentColor} qalib g…ôldi.`,
                        });
                    }
                });
            } catch (error) {
                console.error("Oyundan √ßƒ±xma x…ôtasƒ±:", error);
            } finally {
                currentRoomId = null;
                selectedPiece = null;
                showScreen('lobby');
            }
        }

        // Otaqdakƒ± d…ôyi≈üiklikl…ôri dinl…ôm…ôk (onSnapshot)
        function listenToRoom(roomId) {
            if (unsubscribeRoom) unsubscribeRoom();

            const roomRef = doc(db, ROOMS_COLLECTION, roomId);
            roomCodeOutput.textContent = roomId;
            joinRoomInput.value = ''; // Otaq kodu daxil etm…ô yerini t…ômizl…ô

            unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (!docSnap.exists()) {
                    if (currentRoomId === roomId) { // Yalnƒ±z cari otaq silinibs…ô
                        showModal("R…ôqib oyunu t…ôrk etdi v…ô ya otaq silindi. Lobyey…ô qayƒ±dƒ±rsƒ±nƒ±z.");
                        currentRoomId = null;
                        clearInterval(timerInterval);
                        timerInterval = null;
                        showScreen('lobby');
                    }
                    return;
                }

                const data = docSnap.data();

                if (data.status === 'finished') {
                    const winnerMessage = data.reason ? data.reason : `Oyun Bitdi! Qalib: ${data.winner}`;
                    showModal(winnerMessage);
                    // Qalibiyy…ôt mesajƒ±ndan sonra avtomatik lobiy…ô qayƒ±t
                    if (currentRoomId === roomId) leaveGame();
                    return;
                }

                if (data.status.startsWith('waiting')) {
                    const waitingMessage = data.status === 'waiting_for_ranked_opponent' ? 'R…ôqib axtarƒ±lƒ±r...' : `Otaq kodu: ${roomId}. R…ôqib g√∂zl…ônilir...`;
                    lobiStatusMessage.textContent = waitingMessage;
                    showScreen(data.status === 'waiting_for_ranked_opponent' ? 'searching' : 'lobby');
                    return;
                }

                // Oyun oynanƒ±lƒ±r (status: 'playing')
                if (data.playerBlackId === currentUserId || data.playerWhiteId === currentUserId) {
                    showScreen('game');
                    updateGameUI(data);
                    if (!timerInterval) {
                        startTimerLoop(data.roomId);
                    }
                }
            }, (error) => {
                console.error("Firestore dinl…ôm…ô x…ôtasƒ±:", error);
                showModal("Serverl…ô …ôlaq…ô k…ôsildi. Yenid…ôn c…ôhd edin.");
                if (unsubscribeRoom) unsubscribeRoom();
                currentRoomId = null;
                showScreen('lobby');
            });
        }

        // UI-ƒ± yenil…ôm…ôk
        function updateGameUI(data) {
            const myColor = data.playerBlackId === currentUserId ? 'black' : 'white';
            const myTurn = data.turn === myColor;
            isMyTurn = myTurn;

            currentTurnDisplay.textContent = myTurn ? 'Sizin N√∂vb…ônizdir' : `R…ôqibd…ôdir (${data.turn === 'black' ? 'Qara' : 'Aƒü'})`;
            currentTurnDisplay.className = `text-lg font-bold p-2 rounded-lg ${myTurn ? 'bg-green-600' : 'bg-yellow-600'} text-white shadow-lg transition duration-300`;

            drawBoard(data.board, data.turn, data.mandatoryCapture);

            whiteTimerDisplay.textContent = formatTime(data.timers.white);
            blackTimerDisplay.textContent = formatTime(data.timers.black);

            const whiteTimerClass = data.turn === 'white' ? 'bg-red-500 animate-flicker' : 'bg-gray-700';
            const blackTimerClass = data.turn === 'black' ? 'bg-red-500 animate-flicker' : 'bg-gray-700';

            whiteTimerDisplay.className = `p-2 rounded-lg font-mono text-xl text-white shadow-md ${whiteTimerClass}`;
            blackTimerDisplay.className = `p-2 rounded-lg font-mono text-xl text-white shadow-md ${blackTimerClass}`;
        }

        // Boardu √ß…ôkm…ôk v…ô interaktiv etm…ôk
        function drawBoard(board, turnColor, mandatoryCaptureCoords) {
            boardElement.innerHTML = '';
            mandatoryCapture = mandatoryCaptureCoords;
            const myColor = data.playerBlackId === currentUserId ? 'black' : 'white';
            const isMyTurnColor = turnColor === myColor;

            const maxLength = getMaxJumpChainLength(board, turnColor);
            const piecesToGlow = new Set();

            if (maxLength > 0) {
                for (let r = 0; r < BOARD_SIZE; r++) {
                    for (let c = 0; c < BOARD_SIZE; c++) {
                        if (getPiecePlayer(board[r][c]) === turnColor) {
                            const chain = findLongestJumpChain(board, r, c, turnColor);
                            if (chain.length === maxLength) {
                                piecesToGlow.add(`${r},${c}`);
                            }
                        }
                    }
                }
            }

            // Determine if we need to flip the board (for black player)
            const shouldFlip = myColor === 'black';

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    // Calculate display coordinates (flipped for black player)
                    const displayR = shouldFlip ? BOARD_SIZE - 1 - r : r;
                    const displayC = shouldFlip ? BOARD_SIZE - 1 - c : c;
                    
                    const cell = document.createElement('div');
                    const isDark = (r + c) % 2 !== 0;

                    cell.className = `cell ${isDark ? 'bg-pink-300' : 'bg-pink-100'} transition duration-150 ease-in-out`;
                    cell.dataset.r = r;  // Store original coordinates in data attributes
                    cell.dataset.c = c;
                    cell.onclick = () => handleCellClick(r, c, board, turnColor);

                    const pieceValue = board[r][c];
                    if (pieceValue !== 0) {
                        const pieceElement = document.createElement('div');
                        const piecePlayer = getPiecePlayer(pieceValue);
                        const isKingPiece = pieceValue === 3 || pieceValue === 4;

                        pieceElement.className = `piece flex items-center justify-center ${
                            piecePlayer === 'white' ? 'piece-white' : 'piece-black'
                        } ${isKingPiece ? (piecePlayer === 'white' ? 'piece-king piece-king-white' : 'piece-king piece-king-black') : ''}`;

                        pieceElement.innerHTML = isKingPiece ? 'üëë' : '‚óè';

                        // M…ôcburi yem…ô animasiyasƒ±
                        const shouldGlow = piecesToGlow.has(`${r},${c}`) && isMyTurnColor;
                        if (shouldGlow) {
                            pieceElement.classList.add('animate-pulse-fast', 'ring-4', 'ring-offset-2', 'ring-red-600', 'shadow-2xl');
                            pieceElement.title = "M…ôcburi yem…ô!";
                        }

                        // Se√ßilmi≈ü da≈ü
                        if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) {
                            pieceElement.classList.add('ring-4', 'ring-blue-500', 'ring-offset-2');
                            cell.classList.add('bg-blue-300');
                        }

                        cell.appendChild(pieceElement);
                    }

                    // Vurma h…ôd…ôfi vurƒüulanmasƒ±
                    if (selectedPiece && board[r][c] === 0) {
                        if (isValidMove(board, selectedPiece.r, selectedPiece.c, r, c, turnColor)) {
                            cell.classList.add('bg-green-400', 'cursor-pointer', 'ring-2', 'ring-green-700');
                            cell.title = 'M√ºmk√ºn H…ôr…ôk…ôt';
                        }
                    }

                    // Add to board with correct positioning
                    boardElement.appendChild(cell);
                }
            }
        }

        // Xana klikl…ôm…ô hadis…ôsi
        async function handleCellClick(r, c, board, turnColor) {
            const myColor = turnColor; // Kimin n√∂vb…ôsidirs…ô, o da≈üƒ± idar…ô edir.
            const piecePlayer = getPiecePlayer(board[r][c]);

            if (turnColor !== (board.flat().find(p => getPiecePlayer(p) === 'black' ? p === 2 || p === 4 : p === 1 || p === 3) ? (board.flat().find(p => getPiecePlayer(p) === 'black' ? p === 2 || p === 4 : p === 1 || p === 3) % 2 === 0 ? 'black' : 'white') : null)) return showModal("N√∂vb…ô sizin deyil.");
            
            if (currentRoomId) {
                const roomDoc = await getDoc(doc(db, ROOMS_COLLECTION, currentRoomId));
                if (!roomDoc.exists() || roomDoc.data().turn !== myColor) return showModal("N√∂vb…ô sizin deyil.");
            }


            // 1. Da≈ü se√ßimi
            if (piecePlayer === myColor) {
                const maxLength = getMaxJumpChainLength(board, myColor);
                if (maxLength > 0) {
                    const currentPieceChain = findLongestJumpChain(board, r, c, myColor);
                    if (currentPieceChain.length < maxLength) {
                        return showModal("∆èn uzun yem…ô z…ôncirin…ô aid olan da≈üƒ± se√ßm…ôlisiniz!");
                    }
                }

                selectedPiece = { r, c };
                drawBoard(board, myColor, mandatoryCapture);
            }
            // 2. H…ôr…ôk…ôt etm…ôk
            else if (selectedPiece && piecePlayer === null) {
                const fromR = selectedPiece.r;
                const fromC = selectedPiece.c;

                if (isValidMove(board, fromR, fromC, r, c, myColor)) {
                    await makeMove(fromR, fromC, r, c, board, myColor);
                } else {
                    showModal("Qeyri-qanuni h…ôr…ôk…ôt.");
                }
                selectedPiece = null;
            }
        }

        async function handleTimeout(roomId, timedOutPlayer, board) {
            // ... (∆èvv…ôlki koddan handleTimeout m…ôntiqi)
            const roomRef = doc(db, ROOMS_COLLECTION, roomId);
            const timedOutColor = timedOutPlayer;
            const winningColor = timedOutPlayer === 'black' ? 'Aƒü' : 'Qara';

            try {
                 await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists() || roomDoc.data().status !== 'playing' || roomDoc.data().turn !== timedOutPlayer) {
                        return;
                    }

                    const data = roomDoc.data();
                    const allJumps = findAllMandatoryJumps(board, timedOutColor);

                    if (allJumps.length > 0) {
                        const maxLength = getMaxJumpChainLength(board, timedOutColor);
                        const possibleMoves = [];

                        for (let r = 0; r < BOARD_SIZE; r++) {
                            for (let c = 0; c < BOARD_SIZE; c++) {
                                if (getPiecePlayer(board[r][c]) === timedOutColor) {
                                    const chain = findLongestJumpChain(board, r, c, timedOutColor);
                                    if (chain.length === maxLength) {
                                        const jumps = findJumps(board, r, c, timedOutColor);
                                        jumps.forEach(jump => possibleMoves.push(jump));
                                    }
                                }
                            }
                        }

                        if (possibleMoves.length > 0) {
                            const randomJump = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                            const { from, to, captured } = randomJump;

                            let newBoard = JSON.parse(JSON.stringify(board));
                            newBoard[from.r][from.c] = 0;
                            newBoard[to.r][to.c] = board[from.r][from.c];
                            newBoard[captured.r][captured.c] = 0;

                            let nextTurn = timedOutPlayer === 'black' ? 'white' : 'black';
                            let nextMandatoryCapture = null;
                            const subsequentJumps = findJumps(newBoard, to.r, to.c, timedOutColor);

                             if (subsequentJumps.length > 0) {
                                nextTurn = timedOutPlayer;
                                nextMandatoryCapture = { r: to.r, c: to.c };
                            }

                            transaction.update(roomRef, {
                                board: newBoard,
                                turn: nextTurn,
                                timers: { ...data.timers, [timedOutPlayer]: TIMER_DURATION },
                                mandatoryCapture: nextMandatoryCapture,
                                lastMoveTimestamp: serverTimestamp(),
                            });
                            showModal(`${timedOutColor} oyun√ßunun vaxtƒ± bitdi. M…ôcburi yem…ô avtomatik edildi.`);
                            return;
                        }
                    }

                    const reason = `${timedOutColor} oyun√ßunun vaxtƒ± bitdi. Oyunu ${winningColor} qazandƒ±.`;
                    transaction.update(roomRef, {
                        status: 'finished',
                        winner: winningColor,
                        reason: reason,
                    });

                });
            } catch (error) {
                console.error("Timeout x…ôtasƒ±:", error);
            }
        }

        // Timer Loopunu Ba≈ülatmaq
        function startTimerLoop(roomId) {
            clearInterval(timerInterval);

            timerInterval = setInterval(async () => {
                if (!currentRoomId || !isInitialized) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    return;
                }

                const roomRef = doc(db, ROOMS_COLLECTION, roomId);

                try {
                    await runTransaction(db, async (transaction) => {
                        const roomDoc = await transaction.get(roomRef);
                        if (!roomDoc.exists() || roomDoc.data().status !== 'playing') {
                             clearInterval(timerInterval);
                             timerInterval = null;
                             return;
                        }

                        const data = roomDoc.data();
                        const turn = data.turn;
                        const lastMove = data.lastMoveTimestamp.toDate().getTime();
                        const now = Date.now();
                        const elapsedSeconds = Math.floor((now - lastMove) / 1000);

                        let currentTimer = data.timers[turn] - elapsedSeconds;

                        if (currentTimer <= 0) {
                            currentTimer = 0;
                            transaction.update(roomRef, {
                                timers: { ...data.timers, [turn]: 0 }
                            });
                            handleTimeout(roomId, turn, data.board);
                            clearInterval(timerInterval);
                            timerInterval = null;
                        } else {
                            transaction.update(roomRef, {
                                timers: { ...data.timers, [turn]: currentTimer }
                            });
                        }
                    });
                } catch (error) {
                    // Transaction x…ôtalarƒ± normaldƒ±r
                }
            }, 1000);
        }

        // --- Ba≈ülanƒüƒ±c v…ô Autentifikasiya ---

        async function initApp() {
            if (!firebaseConfig) {
                showModal("Firebase konfigurasiyasƒ± tapƒ±lmadƒ±.");
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            connectionStatus.textContent = 'Server…ô qo≈üulur...';
            connectionStatus.classList.remove('text-red-500');
            connectionStatus.classList.add('text-yellow-400', 'animate-pulse');

            const telegramUser = getTelegramUser();
            let authCompleted = false;

            onAuthStateChanged(auth, async (user) => {
                if (user && !authCompleted) {
                    authCompleted = true;

                    currentUserId = user.uid;
                    currentUserName = telegramUser ? telegramUser.name : `Anonim-${user.uid.substring(0, 4)}`;

                    userNameDisplay.textContent = currentUserName;
                    currentUserIdDisplay.textContent = currentUserId;

                    connectionStatus.textContent = 'Server…ô qo≈üuldu!';
                    connectionStatus.classList.remove('text-yellow-400', 'animate-pulse');
                    connectionStatus.classList.add('text-green-500');

                    showScreen('lobby');
                    isInitialized = true;

                } else if (!user && !authCompleted) {
                    if (initialAuthToken) {
                         try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });

             if (initialAuthToken) {
                 try {
                     await signInWithCustomToken(auth, initialAuthToken);
                 } catch (error) {
                     await signInAnonymously(auth);
                 }
             } else {
                 await signInAnonymously(auth);
             }

            window.addEventListener('beforeunload', () => {
                if (currentRoomId && !unsubscribeRoom) {
                    // Bu, h…ôr…ôk…ôt zamanƒ± i≈ül…ôm…ôy…ô bil…ôr, amma r…ôqib…ô x…ôb…ôr verm…ôk √º√ß√ºn Firestorda silinir.
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-2 font-inter overflow-x-hidden">

    <!-- Modal Mesaj Kutusu -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 text-white p-6 rounded-2xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold mb-4 text-red-400">Bildiri≈ü</h3>
            <p id="modal-message" class="mb-6 text-gray-300"></p>
            <button id="modal-close-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105">
                Baƒüla
            </button>
        </div>
    </div>

    <!-- Ba≈ülƒ±k ve Status -->
    <div class="mb-6 p-4 rounded-2xl bg-gray-800 shadow-2xl text-center animate-pulse-glow">
        <h1 class="text-2xl sm:text-4xl font-extrabold title-glow mb-2">
            AMERƒ∞KAN DAMASI
        </h1>
        <p id="connection-status" class="text-sm text-yellow-400 font-semibold transition-all duration-300">Server…ô qo≈üulur...</p>
    </div>

    <!-- Loading Ekranƒ± -->
    <div id="loader" class="text-center p-8 bg-gray-800 rounded-2xl shadow-xl max-w-sm w-full">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-red-500 mx-auto mb-4"></div>
        <p class="text-lg font-semibold">Y√ºkl…ônir...</p>
    </div>

    <!-- Lobi Ekranƒ± -->
    <div id="lobby-screen" class="hidden w-full max-w-md bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
        <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-red-400 animate-float">Oyun Lobisi</h2>
        <p id="lobi-status-message" class="text-center text-yellow-300 mb-8 font-semibold transition-all duration-300 text-sm sm:text-base">
            Oyun rejimi se√ßin.
        </p>

        <div class="space-y-4">
            <!-- 1. Dereceli E≈üle≈üme -->
            <button id="dereceli-btn" class="w-full button-red text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-xl text-lg">
                Dereceli Oyna
            </button>
            <button id="cancel-btn" class="hidden w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-xl">
                ƒ∞ptal Et
            </button>

            <!-- 2. Arkada≈üla Oyna -->
            <div class="bg-gray-700 p-5 rounded-xl shadow-inner space-y-4">
                <h3 class="text-xl font-bold text-blue-400">Arkada≈üla Oyna</h3>
                <button id="friend-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                    Oda Yarat
                </button>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <span class="text-sm font-semibold text-gray-300">Oda Kodu:</span>
                    <span id="room-code-output" class="text-xl sm:text-2xl font-mono text-green-400 bg-gray-900 px-3 py-2 rounded-lg shadow-inner select-all flex-1 text-center">...</span>
                    <button id="copy-code-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105">
                        Kopyala
                    </button>
                </div>
            </div>

            <!-- 3. Koda Baƒülan -->
            <div class="bg-gray-700 p-5 rounded-xl shadow-inner space-y-3">
                <input id="join-room-input" type="text" placeholder="Oda Kodu (4 R…ôq…ôm)" maxlength="4" 
                    class="w-full p-3 rounded-lg border-2 border-gray-600 bg-gray-900 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 text-center text-lg font-mono">
                <button id="join-room-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                    Odaya Baƒülan
                </button>
            </div>
        </div>
    </div>

    <!-- Oyun Ekranƒ± -->
    <div id="game-screen" class="hidden w-full flex flex-col items-center max-w-2xl">
        
        <!-- N√∂vb…ô G√∂st…ôricisi -->
        <div id="current-turn-display" class="w-full max-w-md mb-4 p-4 rounded-xl bg-gray-800 shadow-xl text-center">
            <p class="text-lg sm:text-xl font-bold">Sƒ±ra: <span id="turn-text" class="text-yellow-400">Y√ºkl…ônir...</span></p>
        </div>

        <!-- Dama Tahtasƒ± -->
        <div id="board" class="board mb-6">
            <!-- Ta≈ülar JavaScript ile √ßizilir -->
        </div>

        <!-- Oyundan √áƒ±k Butonu -->
        <button id="leave-game-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-xl">
            Oyundan √áƒ±x
        </button>

    </div>

</body>
</html>
