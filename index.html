<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’£ Emoji Bomb 1v1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ana Stiller ve Arka Plan */
        body {
            font-family: 'Inter', sans-serif;
            /* Gradient arka plan */
            background: linear-gradient(to bottom right, #1a1a1a, #333333);
            color: #f0f0f0;
            overflow: hidden; /* Tam ekran, kaydÄ±rma yok */
        }

        /* Ana ekran konteyneri */
        .screen {
            width: 100vw;
            height: 100vh;
            display: none; /* VarsayÄ±lan olarak gizli */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            box-sizing: border-box;
            text-align: center;
            position: absolute; /* EkranlarÄ±n Ã¼st Ã¼ste binmesi iÃ§in */
            top: 0;
            left: 0;
        }
        
        /* Aktif ekranÄ± gÃ¶ster */
        .screen.active {
            display: flex;
            z-index: 10; /* Aktif ekran Ã¶nde */
        }

        /* YÃ¼kleniyor EkranÄ± Animasyonu */
        @keyframes pulse-spin {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
        }
        .loader-anim {
            animation: pulse-spin 2.5s infinite ease-in-out;
        }
        
        /* BÃ¼yÃ¼k Buton Stilleri */
        .btn {
            @apply w-full max-w-xs text-xl font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-500 active:scale-95 disabled:opacity-50;
        }
        .btn-secondary {
            @apply bg-green-600 text-white hover:bg-green-500 active:scale-95 disabled:opacity-50;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-500 active:scale-95 disabled:opacity-50;
        }
        
        /* GiriÅŸ AlanlarÄ± */
        .input-field {
            @apply w-full max-w-xs text-lg bg-gray-700 text-white border-2 border-gray-600 rounded-lg p-4 text-center placeholder-gray-400 focus:outline-none focus:border-blue-500;
        }

        /* BaÄŸlantÄ± Metin AlanlarÄ± (Offer/Answer) */
        .signal-textarea {
            @apply w-full max-w-md h-24 text-xs bg-gray-800 text-gray-300 rounded-lg p-2 border border-gray-600 resize-none;
        }

        /* 3D Kart DÃ¶ndÃ¼rme Animasyonu */
        .card-container {
            perspective: 1000px;
            aspect-ratio: 1 / 1; /* Kare kartlar */
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-container.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            @apply rounded-lg shadow-md flex items-center justify-center;
        }
        .card-front {
            @apply bg-blue-500 text-3xl;
        }
        .card-back {
            @apply bg-gray-600 text-4xl;
            transform: rotateY(180deg);
        }
        /* KartÄ±n tÄ±klandÄ±ÄŸÄ±nÄ± ama Ã§evrilmediÄŸini gÃ¶steren stil */
        .card-container.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }


        /* SarsÄ±ntÄ± (Shake) Animasyonu - Bomba */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake {
            animation: shake 0.4s ease-in-out;
        }

        /* TitreÅŸim (Vibrate) Animasyonu - Az Kart KaldÄ±ÄŸÄ±nda */
        @keyframes vibrate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1.5deg); }
            75% { transform: rotate(-1.5deg); }
        }
        .vibrating {
            animation: vibrate 0.2s infinite;
        }
        
        /* Oyun Sonu EkranÄ± Overlay */
        #endScreen {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100; /* Oyun ekranÄ±nÄ±n Ã¼zerinde */
        }

        /* Global Mesaj */
        #globalMessage.show {
            display: block;
            animation: fadeInDown 0.3s ease-out;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white select-none">

    <div id="globalMessage" class="hidden fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg z-[200]">
        <p id="globalMessageText"></p>
        <button id="globalMessageClose" class="absolute top-2 right-3 text-2xl font-bold">&times;</button>
    </div>

    <div id="loader" class="screen active z-50">
        <div class="loader-anim text-center">
            <div class="text-7xl">ğŸ’£</div>
            <h1 class="text-4xl font-black mt-4">Emoji Bomb</h1>
        </div>
    </div>

    <div id="lobby" class="screen">
        <div class="w-full max-w-md space-y-4">
            <h1 class="text-5xl font-black text-center">ğŸ’£ Emoji Bomb</h1>
            <p class="text-lg text-gray-300 text-center">ArkadaÅŸÄ±nla 1v1 oyna! Oda kur veya bir odaya katÄ±l.</p>
            
            <input type="text" id="username" class="input-field" placeholder="KullanÄ±cÄ± AdÄ±" maxlength="15">
            
            <button id="createRoomBtn" class="btn btn-primary">ğŸ® Oda Kur</button>
            <button id="joinRoomBtn" class="btn btn-secondary">ğŸ” KatÄ±l</button>
        </div>
    </div>
    
    <div id="connectScreen" class="screen">
        <div class="w-full max-w-lg space-y-3">
            <h2 id="connectTitle" class="text-2xl font-bold">BaÄŸlantÄ± Kuruluyor...</h2>
            
            <div id="hostConnect" class="space-y-3 hidden">
                <p class="text-lg">Oda Kodu: <strong id="roomCodeDisplay" class="text-2xl text-yellow-400 tracking-widest"></strong></p>
                
                <label class="text-left w-full block">1. Bu Teklif Kodunu kopyala ve arkadaÅŸÄ±na gÃ¶nder:</label>
                <p class="text-xs text-gray-400 text-left"><i>(Not: Bu kodun Ã§ok uzun olmasÄ± normaldir.)</i></p>
                <textarea id="offerText" class="signal-textarea" readonly placeholder="Teklif kodu oluÅŸturuluyor..."></textarea>
                <button id="copyOfferBtn" class="btn btn-primary text-sm py-2">Teklifi Kopyala</button>
                
                <label class="text-left w-full block">2. ArkadaÅŸÄ±ndan gelen Cevap Kodunu buraya yapÄ±ÅŸtÄ±r:</label>
                <textarea id="answerTextHost" class="signal-textarea" placeholder="ArkadaÅŸÄ±nÄ±n cevap kodunu bekle..."></textarea>
                
                <p id="hostStatus" class="text-green-400">BaÄŸlantÄ± kuruluyor...</p>
            </div>
            
            <div id="guestConnect" class="space-y-3 hidden">
                <label class="text-left w-full block">1. ArkadaÅŸÄ±nÄ±n Teklif Kodunu buraya yapÄ±ÅŸtÄ±r:</label>
                <textarea id="offerTextGuest" class="signal-textarea" placeholder="ArkadaÅŸÄ±nÄ±n teklif kodunu yapÄ±ÅŸtÄ±r..."></textarea>
                
                <button id="createAnswerBtn" class="btn btn-secondary">Cevap OluÅŸtur</button>
                
                <label class="text-left w-full block">2. Bu Cevap Kodunu kopyala ve arkadaÅŸÄ±na geri gÃ¶nder:</label>
                <p class="text-xs text-gray-400 text-left"><i>(Not: Bu kodun Ã§ok uzun olmasÄ± normaldir.)</i></p>
                <textarea id="answerTextGuest" class="signal-textarea" readonly placeholder="Cevap kodu burada gÃ¶rÃ¼necek..."></textarea>
                <button id="copyAnswerBtn" class="btn btn-primary text-sm py-2 hidden">CevabÄ± Kopyala</button>

                <p id="guestStatus" class="text-green-400">BaÄŸlantÄ± bekleniyor...</p>
            </div>
            <button id="cancelConnectBtn" class="btn btn-danger text-base py-2">Ä°ptal Et</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="w-full max-w-3xl absolute top-0 left-1/2 -translate-x-1/2 p-4">
            <div class="flex justify-between items-center text-lg sm:text-2xl font-bold">
                <div id="player1Info" class="text-left">
                    <span id="player1Name">Oyuncu 1</span>
                    <div id="player1Lives" class="text-3xl">â¤ï¸â¤ï¸</div>
                </div>
                <div id="player2Info" class="text-right">
                    <span id="player2Name">Oyuncu 2</span>
                    <div id="player2Lives" class="text-3xl">â¤ï¸â¤ï¸</div>
                </div>
            </div>
            <p id="turnIndicator" class="text-center text-xl sm:text-2xl font-bold text-yellow-400 mt-4"></p>
        </div>
        
        <div id="gameGrid" class="w-full max-w-3xl grid grid-cols-4 gap-2 sm:gap-3 p-4 mt-24 sm:mt-32">
            </div>
    </div>
    
    <div id="endScreen" class="screen">
        <div class="text-center space-y-6">
            <h1 id="endMessage" class="text-6xl font-black">KazandÄ±n! ğŸ‰</h1>
            <button id="playAgainBtn" class="btn btn-primary">Tekrar Oyna</button>
            <button id="backToLobbyBtn" class="btn btn-secondary text-base py-3">Lobiye DÃ¶n</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM ReferanslarÄ± ---
            const screens = {
                loader: document.getElementById('loader'),
                lobby: document.getElementById('lobby'),
                connect: document.getElementById('connectScreen'),
                game: document.getElementById('gameScreen'),
                end: document.getElementById('endScreen'),
            };
            const globalMessage = document.getElementById('globalMessage');
            const globalMessageText = document.getElementById('globalMessageText');
            const globalMessageClose = document.getElementById('globalMessageClose');

            // Lobi
            const usernameInput = document.getElementById('username');
            const createRoomBtn = document.getElementById('createRoomBtn');
            const joinRoomBtn = document.getElementById('joinRoomBtn');

            // BaÄŸlantÄ± EkranÄ±
            const connectTitle = document.getElementById('connectTitle');
            const hostConnect = document.getElementById('hostConnect');
            const guestConnect = document.getElementById('guestConnect');
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            const offerText = document.getElementById('offerText');
            const copyOfferBtn = document.getElementById('copyOfferBtn');
            const answerTextHost = document.getElementById('answerTextHost');
            const hostStatus = document.getElementById('hostStatus');
            const offerTextGuest = document.getElementById('offerTextGuest');
            const createAnswerBtn = document.getElementById('createAnswerBtn');
            const answerTextGuest = document.getElementById('answerTextGuest');
            const copyAnswerBtn = document.getElementById('copyAnswerBtn');
            const guestStatus = document.getElementById('guestStatus');
            const cancelConnectBtn = document.getElementById('cancelConnectBtn');

            // Oyun EkranÄ±
            const gameGrid = document.getElementById('gameGrid');
            const player1Name = document.getElementById('player1Name');
            const player1Lives = document.getElementById('player1Lives');
            const player2Name = document.getElementById('player2Name');
            const player2Lives = document.getElementById('player2Lives');
            const turnIndicator = document.getElementById('turnIndicator');

            // Oyun Sonu EkranÄ±
            const endMessage = document.getElementById('endMessage');
            const playAgainBtn = document.getElementById('playAgainBtn');
            const backToLobbyBtn = document.getElementById('backToLobbyBtn');

            // --- WebRTC ve Oyun Durumu (State) ---
            let peerConnection;
            let dataChannel;
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }, // Google'Ä±n STUN sunucusu
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            let isHost = false;
            let username = '';
            let localPlayer = { name: '', lives: 2 };
            let remotePlayer = { name: 'Rakip', lives: 2 };
            let isMyTurn = false;
            let gameGridState = []; // KartlarÄ±n (bomba/gÃ¼venli) durumunu tutar
            let revealedCards = 0; // AÃ§Ä±lan gÃ¼venli kart sayÄ±sÄ±
            let totalSafeCards = 0;
            let bombsToPlace = 5; // Toplam bomba sayÄ±sÄ±
            const gridSize = 16; // 4x4 grid

            // --- Ses Efektleri (Tone.js) ---
            const sounds = {
                click: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, release: 0.1 } }).toDestination(),
                bomb: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 } }).toDestination(),
                win: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, release: 0.5 } }).toDestination(),
                lose: new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.4, release: 0.5 } }).toDestination(),
                connect: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, release: 0.1 } }).toDestination(),
            };
            sounds.bomb.volume.value = -10;
            sounds.click.volume.value = -15;

            // --- Temel Fonksiyonlar ---

            // YÃ¼klenme ekranÄ±nÄ± gizle ve lobiyi gÃ¶ster
            setTimeout(() => {
                showScreen('lobby');
            }, 1500); // 1.5 saniye sonra

            function showGlobalMessage(message, isError = true) {
                globalMessageText.textContent = message;
                if (isError) {
                    globalMessage.classList.add('bg-red-600');
                    globalMessage.classList.remove('bg-green-600');
                } else {
                    globalMessage.classList.remove('bg-red-600');
                    globalMessage.classList.add('bg-green-600');
                }
                globalMessage.classList.remove('hidden');
                globalMessage.classList.add('show');

                // 3 saniye sonra otomatik gizle
                setTimeout(hideGlobalMessage, 3000);
            }
            
            function hideGlobalMessage() {
                globalMessage.classList.add('hidden');
                globalMessage.classList.remove('show');
            }

            function showScreen(screenId) {
                Object.values(screens).forEach(screen => {
                    screen.classList.remove('active');
                });
                if (screens[screenId]) {
                    screens[screenId].classList.add('active');
                }
            }

            function copyToClipboard(text, btn) {
                if (!navigator.clipboard) {
                    // Fallback (eski tarayÄ±cÄ±lar)
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        ta.style.position = 'fixed'; // Ekran dÄ±ÅŸÄ±nda
                        ta.style.opacity = 0;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                    } catch(e) {
                         showGlobalMessage('Kopyalama baÅŸarÄ±sÄ±z. LÃ¼tfen manuel kopyalayÄ±n.');
                         return; // BaÅŸarÄ±sÄ±z olursa butonu deÄŸiÅŸtirmesin
                    }
                } else {
                    // Modern yÃ¶ntem
                    navigator.clipboard.writeText(text).catch(err => {
                        showGlobalMessage('Kopyalama baÅŸarÄ±sÄ±z. LÃ¼tfen manuel kopyalayÄ±n.');
                        return; // BaÅŸarÄ±sÄ±z olursa butonu deÄŸiÅŸtirmesin
                    });
                }

                // Buton metnini geÃ§ici olarak deÄŸiÅŸtir
                const originalText = btn.textContent;
                btn.textContent = 'KopyalandÄ±!';
                btn.disabled = true;
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1500);
            }

            // --- WebRTC SinyalleÅŸme FonksiyonlarÄ± ---

            function initWebRTC() {
                peerConnection = new RTCPeerConnection(config);

                // ICE adayÄ± (aÄŸ yolu) bulunduÄŸunda tetiklenir
                peerConnection.onicecandidate = event => {
                    // event.candidate null olduÄŸunda, ICE toplanmasÄ± tamamlanmÄ±ÅŸtÄ±r
                    // ve localDescription (offer/answer) hazÄ±rdÄ±r.
                    if (!event.candidate) {
                        console.log('ICE Toplama tamamlandÄ± (onicecandidate null).');
                        if (isHost) {
                            if(offerText.value.length === 0) { // Sadece ilk kez doldur
                                offerText.value = JSON.stringify(peerConnection.localDescription);
                                hostStatus.textContent = 'Teklifi arkadaÅŸÄ±na gÃ¶nder.';
                            }
                        } else {
                            // Misafir iÃ§in cevap hazÄ±r
                             if(answerTextGuest.value.length === 0) { // Sadece ilk kez doldur
                                answerTextGuest.value = JSON.stringify(peerConnection.localDescription);
                                copyAnswerBtn.classList.remove('hidden');
                                guestStatus.textContent = 'CevabÄ± arkadaÅŸÄ±na gÃ¶nder.';
                            }
                        }
                    }
                };

                // AÄŸ durumu deÄŸiÅŸtiÄŸinde
                peerConnection.onconnectionstatechange = () => {
                    console.log('BaÄŸlantÄ± Durumu:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        hostStatus.textContent = 'BaÄŸlandÄ±!';
                        guestStatus.textContent = 'BaÄŸlandÄ±!';
                        // Oyun baÅŸlatma mantÄ±ÄŸÄ± datachannel onopen'a taÅŸÄ±ndÄ±
                    }
                    if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                        showGlobalMessage('BaÄŸlantÄ± koptu veya kurulamadÄ±.');
                        resetToLobby();
                    }
                };
                
                // Misafir, host'tan bir data channel aldÄ±ÄŸÄ±nda
                peerConnection.ondatachannel = event => {
                    dataChannel = event.channel;
                    console.log('Misafir: Data channel alÄ±ndÄ±.');
                    setupDataChannelEvents();
                };
            }

            // Host: Teklif oluÅŸtur
            async function createOffer() {
                // Host data channel'Ä± oluÅŸturur
                dataChannel = peerConnection.createDataChannel('gameDataChannel');
                console.log('Host: Data channel oluÅŸturuldu.');
                setupDataChannelEvents();
                
                try {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    // ICE adaylarÄ±nÄ±n toplanmasÄ± onicecandidate olayÄ± ile takip edilecek
                } catch (e) {
                    console.error('Teklif oluÅŸturulamadÄ±:', e);
                    showGlobalMessage('Teklif oluÅŸturulamadÄ±. LÃ¼tfen tekrar deneyin.');
                    resetToLobby();
                }
            }

            // Host: Misafirden gelen cevabÄ± alÄ±r (EKSÄ°K KISIMDI)
            async function receiveAnswer(answerString) {
                if (!peerConnection) return;
                try {
                    const answer = JSON.parse(answerString);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    console.log('Host: Cevap alÄ±ndÄ± ve ayarlandÄ±.');
                    hostStatus.textContent = 'BaÄŸlantÄ± tamamlanÄ±yor...';
                } catch (e) {
                    console.error('Cevap alÄ±namadÄ±:', e);
                    showGlobalMessage('GeÃ§ersiz cevap kodu. LÃ¼tfen tekrar kopyalayÄ±n.');
                }
            }

            // Misafir: Host'tan gelen teklifi alÄ±r ve cevap oluÅŸturur
            async function receiveOfferAndCreateAnswer(offerString) {
                if (!peerConnection) initWebRTC(); // Misafir burada baÅŸlatÄ±r

                try {
                    const offer = JSON.parse(offerString);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    console.log('Misafir: Teklif alÄ±ndÄ± ve ayarlandÄ±.');
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    console.log('Misafir: Cevap oluÅŸturuldu.');
                    guestStatus.textContent = 'Cevap oluÅŸturuluyor...';
                    
                    // ICE adaylarÄ±nÄ±n toplanmasÄ± onicecandidate olayÄ± ile takip edilecek
                    
                } catch (e) {
                    console.error('Cevap oluÅŸturulamadÄ±:', e);
                    showGlobalMessage('GeÃ§ersiz teklif kodu. LÃ¼tfen tekrar kopyalayÄ±n.');
                }
            }

            // --- Lobi ve BaÄŸlantÄ± MantÄ±ÄŸÄ± (EKSÄ°K KISIMLARDI) ---
            
            function validateUsername() {
                username = usernameInput.value.trim();
                if (username.length < 2 || username.length > 15) {
                    showGlobalMessage('LÃ¼tfen geÃ§erli bir kullanÄ±cÄ± adÄ± girin (2-15 karakter).');
                    return false;
                }
                localPlayer.name = username;
                return true;
            }

            function initCreateRoom() {
                if (!validateUsername()) return;
                
                isHost = true;
                initWebRTC(); // Host burada baÅŸlatÄ±r
                createOffer();
                
                showScreen('connect');
                hostConnect.classList.remove('hidden');
                guestConnect.classList.add('hidden');
                connectTitle.textContent = 'Oda Kur';
                // GÃ¶rsel bir oda kodu (baÄŸlantÄ± iÃ§in kullanÄ±lmaz, sadece gÃ¶rsel)
                roomCodeDisplay.textContent = Math.floor(1000 + Math.random() * 9000).toString();
                offerText.value = '';
                answerTextHost.value = '';
                hostStatus.textContent = 'Teklif kodu oluÅŸturuluyor...';
            }

            function initJoinRoom() {
                if (!validateUsername()) return;
                
                isHost = false;
                // initWebRTC() burada Ã§aÄŸrÄ±lmaz, cevap oluÅŸtururken Ã§aÄŸrÄ±lÄ±r.
                
                showScreen('connect');
                hostConnect.classList.add('hidden');
                guestConnect.classList.remove('hidden');
                connectTitle.textContent = 'Odaya KatÄ±l';
                offerTextGuest.value = '';
                answerTextGuest.value = '';
                copyAnswerBtn.classList.add('hidden');
                guestStatus.textContent = 'ArkadaÅŸÄ±nÄ±n teklif kodunu bekliyor...';
            }
            
            function resetToLobby() {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (dataChannel) {
                    dataChannel.close();
                    dataChannel = null;
                }
                
                isHost = false;
                isMyTurn = false;
                showScreen('lobby');
                
                // BaÄŸlantÄ± ekranÄ± alanlarÄ±nÄ± temizle
                offerText.value = '';
                answerTextHost.value = '';
                offerTextGuest.value = '';
                answerTextGuest.value = '';
                hostConnect.classList.add('hidden');
                guestConnect.classList.add('hidden');
                copyAnswerBtn.classList.add('hidden');
            }

            // --- Data Channel ve Oyun MantÄ±ÄŸÄ± ---
            
            function setupDataChannelEvents() {
                if (!dataChannel) return;
                
                dataChannel.onopen = () => {
                    console.log('Data Channel AÃ‡IK!');
                    sounds.connect.triggerAttackRelease("C5", "8n", Tone.now());
                    // BaÄŸlantÄ± tamamlandÄ±, oyunu baÅŸlat
                    setTimeout(startGame, 500); // KÃ¼Ã§Ã¼k bir gecikme
                };
                
                dataChannel.onclose = () => {
                    console.log('Data Channel KAPALI!');
                    if (screens.game.classList.contains('active')) { // Sadece oyun ekranÄ±ndaysa bu hatayÄ± ver
                        showGlobalMessage('Rakibin baÄŸlantÄ±sÄ± koptu.');
                    }
                    resetToLobby();
                };
                
                dataChannel.onmessage = event => {
                    try {
                        const data = JSON.parse(event.data);
                        handleReceivedData(data);
                    } catch(e) {
                        console.error('GeÃ§ersiz veri alÄ±ndÄ±:', event.data);
                    }
                };
            }
            
            function sendGameData(data) {
                if (dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify(data));
                }
            }
            
            function handleReceivedData(data) {
                console.log('AlÄ±nan Veri:', data);
                switch(data.type) {
                    case 'HANDSHAKE':
                        // Rakibin adÄ±nÄ± al
                        remotePlayer.name = data.name;
                        updateGameUI(); // Rakip adÄ±nÄ± gÃ¼ncelle
                        
                        // Host ise, grid'i oluÅŸturup misafire gÃ¶nder
                        if (isHost) {
                            setupGameGrid(true); // Host grid'i kurar ve gÃ¶nderir
                        }
                        break;
                    
                    case 'GRID_SETUP':
                        // Misafir, host'tan gelen grid'i alÄ±r
                        gameGridState = data.grid;
                        bombsToPlace = data.bombs;
                        totalSafeCards = gridSize - bombsToPlace;
                        setupGameGrid(false); // Misafir grid'i sadece Ã§izer
                        break;
                        
                    case 'FLIP_CARD':
                        // Rakip bir kart aÃ§tÄ±
                        revealCard(data.index, gameGridState[data.index]);
                        break;
                        
                    case 'END_TURN':
                        // SÄ±ra bize geÃ§ti
                        isMyTurn = true;
                        updateGameUI();
                        break;
                    
                    case 'GAME_OVER':
                        // Rakip kazandÄ± (biz kaybettik)
                        endGame(false);
                        break;
                        
                    case 'PLAY_AGAIN_REQUEST':
                        // Rakip tekrar oynamak istiyor
                        showGlobalMessage('Rakip tekrar oynamak istiyor.', false);
                        playAgainBtn.textContent = 'Teklif Kabul Et';
                        playAgainBtn.onclick = () => {
                            sendGameData({ type: 'PLAY_AGAIN_CONFIRM' });
                            startGame(); // Oyunu yeniden baÅŸlat
                        };
                        break;
                        
                    case 'PLAY_AGAIN_CONFIRM':
                        // Teklifimiz kabul edildi
                        showGlobalMessage('Teklif kabul edildi. Yeni oyun baÅŸlÄ±yor!', false);
                        startGame(); // Oyunu yeniden baÅŸlat
                        break;
                }
            }

            function startGame() {
                console.log('Oyun baÅŸlÄ±yor!');
                showScreen('game'); // Sadece oyun ekranÄ±nÄ± gÃ¶ster
                screens.end.classList.remove('active'); // Oyun sonu ekranÄ±nÄ± gizle

                // Oyuncu durumlarÄ±nÄ± sÄ±fÄ±rla
                localPlayer.lives = 2;
                remotePlayer.lives = 2;
                revealedCards = 0;
                gameGridState = [];
                
                // Ä°simleri gÃ¶nder (El sÄ±kÄ±ÅŸma)
                sendGameData({ type: 'HANDSHAKE', name: localPlayer.name });

                if (isHost) {
                    isMyTurn = true;
                    // Host grid'i setupGameGrid'de kuracak (HANDSHAKE cevabÄ± gelince)
                } else {
                    isMyTurn = false;
                    // Misafir grid'i host'tan bekleyecek
                }
                
                updateGameUI();
                
                // Tekrar oyna butonunu sÄ±fÄ±rla
                playAgainBtn.textContent = 'Tekrar Oyna';
                playAgainBtn.onclick = () => {
                    sendGameData({ type: 'PLAY_AGAIN_REQUEST' });
                    playAgainBtn.textContent = 'Teklif GÃ¶nderildi...';
                    showGlobalMessage('Tekrar oynama teklifi gÃ¶nderildi.', false);
                };
            }
            
            // Grid'i kurar (Host ise) veya Ã§izer (Misafir ise)
            function setupGameGrid(isHostSetup) {
                gameGrid.innerHTML = ''; // Eski grid'i temizle
                
                if (isHostSetup) {
                    gameGridState = Array(gridSize).fill('SAFE');
                    totalSafeCards = gridSize - bombsToPlace;
                    let bombsPlaced = 0;
                    while (bombsPlaced < bombsToPlace) {
                        const index = Math.floor(Math.random() * gridSize);
                        if (gameGridState[index] === 'SAFE') {
                            gameGridState[index] = 'BOMB';
                            bombsPlaced++;
                        }
                    }
                    // Grid'i misafire gÃ¶nder
                    sendGameData({ type: 'GRID_SETUP', grid: gameGridState, bombs: bombsToPlace });
                }
                
                // Grid'i HTML olarak Ã§iz
                for (let i = 0; i < gridSize; i++) {
                    const card = document.createElement('div');
                    card.className = 'card-container';
                    card.dataset.index = i;
                    
                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-front">â“</div>
                            <div class="card-back ${gameGridState[i] === 'BOMB' ? 'bg-red-700' : 'bg-green-600'}">
                                ${gameGridState[i] === 'BOMB' ? 'ğŸ’£' : 'âœ…'}
                            </div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => handleCardClick(i, card));
                    gameGrid.appendChild(card);
                }
            }

            function handleCardClick(index, cardElement) {
                if (!isMyTurn || cardElement.classList.contains('flipped') || cardElement.classList.contains('disabled')) {
                    return; // SÄ±ra bende deÄŸilse veya kart zaten aÃ§Ä±ksa/iÅŸlemdeyse bir ÅŸey yapma
                }
                
                // KartÄ± geÃ§ici olarak kilitle
                cardElement.classList.add('disabled');
                
                // SÄ±rayÄ± hemen rakibe ver (tek tÄ±klama hakkÄ± var)
                isMyTurn = false;
                updateGameUI(); // GÃ¶stergeyi gÃ¼ncelle
                
                // TÄ±klama bilgisini rakibe gÃ¶nder
                sendGameData({ type: 'FLIP_CARD', index: index });
                
                // KartÄ± aÃ§
                revealCard(index, gameGridState[index]);
            }

            function revealCard(index, type) {
                const cardElement = gameGrid.querySelector(`.card-container[data-index='${index}']`);
                if (!cardElement || cardElement.classList.contains('flipped')) return;
                
                cardElement.classList.add('flipped', 'disabled'); // KartÄ± aÃ§ ve kilitle
                
                if (type === 'BOMB') {
                    // Bomba!
                    sounds.bomb.triggerAttackRelease("2n", Tone.now());
                    cardElement.classList.add('shake');
                    
                    localPlayer.lives--; // Kendi canÄ±mÄ±z azalÄ±r (Ã§Ã¼nkÃ¼ sÄ±rasÄ± olan tÄ±klar)
                    
                    // CanlarÄ± gÃ¼ncelle
                    updateGameUI();
                    
                    // Oyun bitti mi kontrol et
                    if (localPlayer.lives <= 0) {
                        sendGameData({ type: 'GAME_OVER' }); // Rakibe kazandÄ±ÄŸÄ±nÄ± bildir
                        endGame(false); // Kaybettik
                        return; // Oyun bitti, turu devretme
                    }

                } else {
                    // GÃ¼venli
                    sounds.click.triggerAttackRelease("C4", "8n", Tone.now());
                    revealedCards++;
                    
                    // TÃ¼m gÃ¼venli kartlar aÃ§Ä±ldÄ± mÄ±?
                    if (revealedCards >= totalSafeCards) {
                        sendGameData({ type: 'GAME_OVER' }); // Rakibe kazandÄ±ÄŸÄ±mÄ±zÄ± bildir
                        endGame(true); // KazandÄ±k
                        return; // Oyun bitti, turu devretme
                    }
                }
                
                // Az kart kaldÄ±ÄŸÄ±nda titret
                if (totalSafeCards - revealedCards <= 3) {
                    gameGrid.classList.add('vibrating');
                }
                
                // Turu rakibe devret (gecikmeli)
                setTimeout(() => {
                    sendGameData({ type: 'END_TURN' });
                }, 1000); // 1 saniye sonra
            }

            function updateGameUI() {
                // Ä°simler (Host P1, Misafir P2 varsayÄ±mÄ±)
                if (isHost) {
                    player1Name.textContent = localPlayer.name + " (Sen)";
                    player2Name.textContent = remotePlayer.name;
                    player1Lives.innerHTML = 'â¤ï¸'.repeat(localPlayer.lives) + 'ğŸ–¤'.repeat(2 - localPlayer.lives);
                    player2Lives.innerHTML = 'â¤ï¸'.repeat(remotePlayer.lives) + 'ğŸ–¤'.repeat(2 - remotePlayer.lives);
                } else {
                    player1Name.textContent = remotePlayer.name;
                    player2Name.textContent = localPlayer.name + " (Sen)";
                    player1Lives.innerHTML = 'â¤ï¸'.repeat(remotePlayer.lives) + 'ğŸ–¤'.repeat(2 - remotePlayer.lives);
                    player2Lives.innerHTML = 'â¤ï¸'.repeat(localPlayer.lives) + 'ğŸ–¤'.repeat(2 - localPlayer.lives);
                }
                
                // SÄ±ra gÃ¶stergesi
                if (isMyTurn) {
                    turnIndicator.textContent = "SÄ±ra Sende!";
                    turnIndicator.classList.add('text-yellow-400');
                    turnIndicator.classList.remove('text-gray-500');
                } else {
                    turnIndicator.textContent = "Rakip Oynuyor...";
                    turnIndicator.classList.remove('text-yellow-400');
                    turnIndicator.classList.add('text-gray-500');
                }
            }
            
            function endGame(didIWin) {
                gameGrid.classList.remove('vibrating'); // TitreÅŸimi durdur
                
                if (didIWin) {
                    endMessage.innerHTML = "KazandÄ±n! ğŸ‰";
                    sounds.win.triggerAttackRelease("C5", "0.5n", Tone.now());
                    sounds.win.triggerAttackRelease("G5", "0.5n", Tone.now() + 0.2);
                } else {
                    endMessage.innerHTML = "Kaybettin! ğŸ˜¥";
                    sounds.lose.triggerAttackRelease("C3", "0.5n", Tone.now());
                    sounds.lose.triggerAttackRelease("G2", "0.5n", Tone.now() + 0.2);
                }
                
                // TÃ¼m kartlarÄ± aÃ§ (EKSÄ°K KISIMDI)
                const allCards = gameGrid.querySelectorAll('.card-container');
                allCards.forEach(card => {
                    if (!card.classList.contains('flipped')) {
                        card.classList.add('flipped', 'disabled');
                    }
                });
                
                // Oyun sonu ekranÄ±nÄ± 2 saniye sonra gÃ¶ster
                setTimeout(() => {
                    showScreen('end');
                }, 2000);
            }

            
            // --- Event Listeners ---
            
            // Lobi ButonlarÄ±
            createRoomBtn.addEventListener('click', initCreateRoom);
            joinRoomBtn.addEventListener('click', initJoinRoom);
            cancelConnectBtn.addEventListener('click', resetToLobby);
            
            // Global Mesaj Kapatma
            globalMessageClose.addEventListener('click', hideGlobalMessage);

            // Sinyal Kopyalama ButonlarÄ±
            copyOfferBtn.addEventListener('click', () => copyToClipboard(offerText.value, copyOfferBtn));
            copyAnswerBtn.addEventListener('click', () => copyToClipboard(answerTextGuest.value, copyAnswerBtn));

            // Misafir: Cevap OluÅŸturma Butonu
            createAnswerBtn.addEventListener('click', () => {
                if (offerTextGuest.value) {
                    receiveOfferAndCreateAnswer(offerTextGuest.value);
                } else {
                    showGlobalMessage('LÃ¼tfen Ã¶nce arkadaÅŸÄ±nÄ±n teklif kodunu yapÄ±ÅŸtÄ±r.');
                }
            });

            // Host: Cevap Alma (EKSÄ°K KISIMDI)
            answerTextHost.addEventListener('input', () => {
                // Otomatik olarak yapÄ±ÅŸtÄ±rÄ±lan kodu al
                if (answerTextHost.value.length > 50) { // Basit bir kontrol
                    receiveAnswer(answerTextHost.value);
                }
            });

            // Oyun Sonu ButonlarÄ±
            backToLobbyBtn.addEventListener('click', resetToLobby);
            playAgainBtn.addEventListener('click', () => {
                // Bu butonun iÅŸlevi startGame() iÃ§inde dinamik olarak ayarlanÄ±yor
                sendGameData({ type: 'PLAY_AGAIN_REQUEST' });
                playAgainBtn.textContent = 'Teklif GÃ¶nderildi...';
                showGlobalMessage('Tekrar oynama teklifi gÃ¶nderildi.', false);
            });

        });
