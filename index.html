<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üí• Emoji Kart Bombasƒ± 1v1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        /* === KART STƒ∞LLERƒ∞: Cartoonish 3D Effect === */
        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Daha canlƒ± yaylanma effekti */
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 6px 0 #1b263b, 0 8px 15px rgba(0,0,0,0.4); /* 3D d…ôrinlik v…ô k√∂lg…ô */
            transition: transform 0.6s, box-shadow 0.2s;
        }
        
        .card.flipped {
            transform: rotateY(180deg);
            box-shadow: 0 2px 0 #1b263b, 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
            padding: 5px;
        }
        
        .front {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6); /* D…ôrin Mavi Gradient */
            color: white;
            font-size: 2.5rem;
            border: 5px solid #1a202c; /* Koyu √áer√ßeve */
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        .back {
            background: #ecf0f1; /* A√ßƒ±k Arka Plan */
            transform: rotateY(180deg);
            font-size: 3rem; /* Daha B√∂y√ºk Emoji */
            color: #333;
            font-family: 'Segoe UI Emoji', sans-serif;
            border: 5px solid #1a202c; /* Koyu √áer√ßeve */
        }
        
        /* Emoji √º√ß√ºn √∂zel stil */
        .emoji-display {
            font-size: 3rem;
            line-height: 1;
            text-align: center;
        }
        
        /* === KENDƒ∞ OYUNUNUZDAN ALINAN CSS STƒ∞LLERƒ∞ VE MOBƒ∞L UYUM === */
        
        :root {
            --primary-color: #3b82f6; /* Tailwind blue-500 */
            --secondary-color: #f59e0b; /* Amber */
            --success-color: #10b981; /* Emerald */
            --danger-color: #ef4444; /* Red */
            --bg-dark: #1f2937; /* Darker Gray */
            --bg-super-dark: #111827; /* Very Dark Gray */
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box; 
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body { 
            background-color: var(--bg-super-dark); 
            color: #e5e7eb; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: background-color 0.5s; 
        }

        /* Ana Ekran D√ºzeni */
        .screen { 
            width: 100%; 
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            padding: 0.5rem; 
            box-sizing: border-box; 
            text-align: center; 
            background-color: var(--bg-dark);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .screen.active { 
            display: flex; 
        }
        
        /* Language Selector (Daha ≈üƒ±k ve k√º√ß√ºk) */
        .language-selector {
            top: env(safe-area-inset-top, 10px); 
            right: env(safe-area-inset-right, 10px);
        }
        .language-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--primary-color);
            width: 35px;
            height: 35px;
            font-size: 1.2rem;
        }
        .language-options {
            border: 1px solid var(--primary-color);
            background: var(--bg-dark);
            border-radius: 8px;
        }
        .language-option:hover {
            background-color: #374151;
        }
        
        /* Utility */
        .btn {
            @apply px-8 py-4 rounded-3xl font-extrabold text-xl transition-all duration-300 flex items-center justify-center;
            min-width: 280px;
            margin: 0.75rem 0;
            box-shadow: 0 4px 0 #1c5299, 0 6px 15px rgba(0,0,0,0.3); /* Button 3D efekti */
        }
        .btn-primary { 
            @apply text-white; 
            background: linear-gradient(135deg, #3b82f6, #60a5fa); 
            border: none;
        }
        .btn-green {
            background: linear-gradient(135deg, #10b981, #34d399); 
            box-shadow: 0 4px 0 #067252, 0 6px 15px rgba(0,0,0,0.3);
        }
        .btn-red {
            background: linear-gradient(135deg, #ef4444, #f87171);
            box-shadow: 0 4px 0 #b91c1c, 0 6px 15px rgba(0,0,0,0.3);
        }
        .btn:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 6px 0 #1c5299, 0 10px 20px rgba(59, 130, 246, 0.6);
        }
        .btn:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 2px 0 #1c5299, 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Global Mesaj */
        #globalMessage.show { 
            background-color: var(--danger-color);
        }
        #globalMessage.success.show { 
            background-color: var(--success-color);
        }

        /* --- ANƒ∞MASYONLAR --- */
        @keyframes screenFadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        #lobby.active, #waitScreen.active, #gameScreen.active {
            animation: screenFadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animated-lobby-item {
            opacity: 0;
            animation: slideInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        .lobby-title { animation-delay: 0s; }
        .lobby-subtitle { animation-delay: 0.15s; }
        .rules-box { animation-delay: 0.3s; }
        .input-username-container { animation-delay: 0.45s; }
        .input-roomcode-container { animation-delay: 0.6s; }
        #createRoomBtn { animation-delay: 0.75s; }
        #joinRoomBtn { animation-delay: 0.9s; }
        
        /* Bekleme Ekranƒ± (WaitScreen) i√ßin d√∂nme animasyonu */
        .wait-spinner {
            font-size: 5rem; 
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }
        
        /* OYUN TAHTASI VE MOBƒ∞L UYUMLULUK */
        #gameScreen {
            justify-content: space-between;
        }
        #gameContent {
            background-color: #1f2937; 
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            padding: 1rem;
            max-width: 550px; 
            width: 100%;
            height: auto;
            min-height: 70%;
            flex-grow: 0;
            margin: 0.5rem 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem; /* Daha B√∂y√ºk bo≈üluq */
            perspective: 1000px;
            padding: 0.5rem;
        }

        .card.bomb-selected .card-face.front {
            background: linear-gradient(135deg, #ef4444, #f87171); 
            animation: pulse-red 0.5s infinite alternate;
            border-color: #991b1b;
        }
        @keyframes pulse-red {
            from { opacity: 1; box-shadow: 0 0 15px rgba(239, 68, 68, 0.8); }
            to { opacity: 0.8; box-shadow: 0 0 5px rgba(239, 68, 68, 0.5); }
        }
        .vibrate {
            animation: vibrate 0.1s linear infinite;
        }

        /* Oyun ƒ∞√ßi Durum Ekranlarƒ± */
        #gameScreen h1, #gameScreen h2 {
            font-family: 'Chakra Petch', sans-serif;
        }
        #myLives, #opponentLives {
            font-size: 2.5rem;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        #turnStatus {
            font-size: 2rem;
            color: var(--secondary-color); /* Sarƒ± ton */
            text-shadow: 0 0 8px rgba(245, 158, 11, 0.7);
            font-family: 'Chakra Petch', sans-serif;
            margin-top: 0.5rem;
        }
        #actionMessage {
            color: #d1d5db;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        #roleStatus {
            background-color: #374151;
            font-size: 0.9rem;
        }
        #endGameBtn {
            margin-top: 1rem;
            max-width: 300px; 
            width: 80%;
        }
        .status-header {
            background: linear-gradient(90deg, #111827, #374151, #111827);
            padding: 0.75rem 0;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            width: 100%;
        }
        
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Poppins:wght@700&family=Chakra+Petch:wght@700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 select-none">
    <div class="language-selector">
        <button id="language-button" class="language-button" onclick="toggleLanguageSelector()">
            <span id="current-language">üá¶üáø</span>
        </button>
        <div id="language-selector" class="language-options">
            <div class="language-option" onclick="setLanguage('az')">üá¶üáø Az…ôrbaycanca</div>
            <div class="language-option" onclick="setLanguage('tr')">üáπüá∑ T√ºrk√ße</div>
            <div class="language-option" onclick="setLanguage('en')">üá¨üáß English</div>
        </div>
    </div>
    
    <div id="globalMessage" class="hidden success w-11/12 max-w-md p-4 bg-green-600 text-white rounded-xl shadow-2xl transition duration-300">
        <p id="globalMessageText"></p>
    </div>

    <div id="lobby" class="screen active space-y-4">
        <h1 class="text-6xl font-black animated-lobby-item lobby-title mb-1 text-white" style="font-family: 'Chakra Petch', sans-serif; text-shadow: 0 0 15px rgba(59, 130, 246, 0.5);">
            üí• Emoji Bombasƒ±
        </h1>
        <p class="text-base text-gray-300 animated-lobby-item lobby-subtitle mb-4">
            1v1 √áox Oyun√ßulu Kart Bombasƒ± Oyunu
        </p>
        
        <div class="bg-gray-700 bg-opacity-50 border-l-4 border-blue-400 text-gray-200 p-4 rounded-xl shadow-lg animated-lobby-item rules-box w-full max-w-md">
            <p class="font-extrabold text-lg mb-2 text-blue-300">üìã Oyun Qaydalarƒ±:</p>
            <ul class="list-disc list-inside text-left text-sm space-y-1">
                <li>Gizli **Bombalar** olan kartlarƒ± a√ßmayƒ±n!</li>
                <li>R…ôqibinizin **3 canƒ±** var, siz d…ô 3 canla ba≈ülayƒ±rsƒ±nƒ±z.</li>
                <li>Canƒ± bit…ôn **oyunu uduzur**. H…ôr s…ôhv se√ßim can itirir!</li>
            </ul>
        </div>
        
        <div class="w-full animated-lobby-item input-username-container max-w-md">
            <p class="text-center text-lg font-bold mb-1 text-white">
                üë§ ƒ∞stifad…ô√ßi Adƒ±
            </p>
            <input type="text" id="username" class="w-full p-4 text-xl text-center rounded-xl shadow-inner text-gray-800 focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Adƒ±nƒ±zƒ± Daxil Edin" maxlength="15" style="background-color: #e5e7eb;">
        </div>
        
        <div class="w-full animated-lobby-item input-roomcode-container max-w-md">
            <p class="text-center text-lg font-bold mb-1 text-white mt-2">
                üö™ Otaq Kodu
            </p>
            <input type="text" id="roomCodeInput" class="w-full p-4 text-xl text-center rounded-xl shadow-inner text-gray-800 uppercase focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Otaq Kodu (Bo≈üsa yeni otaq yaradƒ±lƒ±r)" maxlength="6" style="background-color: #e5e7eb;">
        </div>
        
        <div class="flex flex-col space-y-4 w-full max-w-md mx-auto mt-6">
            <button id="createRoomBtn" class="btn btn-primary">
                <i class="fas fa-plus-circle mr-3"></i> Otaq Qur
            </button>
            <button id="joinRoomBtn" class="btn btn-green">
                <i class="fas fa-sign-in-alt mr-3"></i> Otaƒüa Qo≈üul
            </button>
        </div>
    </div>
    
    <div id="waitScreen" class="screen p-4">
        <div class="flex flex-col items-center justify-center h-full w-full max-w-lg">
            <div class="wait-spinner mb-8">
                <i class="fas fa-bomb text-blue-400"></i> 
            </div>
            <h2 id="waitTitle" class="text-4xl font-extrabold mb-8 text-white" style="font-family: 'Chakra Petch', sans-serif;">Otaq Hazƒ±rlanƒ±r...</h2>
            
            <div id="codeArea" class="w-full max-w-xs mb-8 p-4 bg-gray-700 rounded-2xl shadow-xl">
                <p class="text-sm text-gray-400 mb-2">Otaq kodunuzu dostunuzla payla≈üƒ±n:</p>
                <div id="roomCodeDisplay" class="text-4xl font-extrabold text-yellow-400 p-2 rounded-lg mb-4 text-center tracking-widest bg-gray-800 border-2 border-yellow-500"></div>
                <button id="copyCodeBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg transform transition active:scale-95">
                    <i class="fas fa-copy mr-2"></i> Kodu Kopyala
                </button>
            </div>
            
            <p id="waitStatus" class="text-xl text-gray-300 mb-10">R…ôqib qo≈üulmasƒ± g√∂zl…ônilir...</p>
            
            <button id="cancelBtn" class="btn btn-red w-full max-w-xs py-3 text-lg">
                <i class="fas fa-times-circle mr-2"></i> L…ôƒüv Et / Lobiye Qayƒ±t
            </button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="status-header">
            <div class="w-full flex justify-between items-center px-4">
                <div class="text-left">
                    <div id="myLives" class="text-4xl">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    <div class="text-sm text-blue-400 font-bold" id="myUsernameDisplay">SEN</div>
                </div>
                
                <div class="text-center flex flex-col items-center">
                    <h1 class="text-4xl font-bold m-0 p-0 text-red-500">üí£</h1>
                    <div id="levelInfo" class="text-base text-yellow-400 font-bold">Seviye: 1</div>
                </div>
                
                <div class="text-right">
                    <div id="opponentLives" class="text-4xl">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    <div id="opponentName" class="text-sm text-blue-400 font-bold">Rakip</div>
                </div>
            </div>
        </div>

        <div id="gameContent" class="space-y-4 shadow-xl">
            <h3 id="turnStatus" class="text-2xl font-bold"></h3>
            <p id="roleStatus" class="text-gray-300 text-sm bg-gray-700 p-2 rounded-lg max-w-xs mx-auto"></p>
            <div id="actionMessage" class="text-lg text-gray-400 font-semibold"></div>
            
            <div id="gameBoard" class="game-board w-full mx-auto">
                </div>
        </div>
        
        <button id="endGameBtn" class="btn btn-red text-sm py-3 px-6">üö™ Oyundan √áƒ±x <i class="fas fa-door-open ml-2"></i></button>
    </div>

    <script src="languages.js"></script>
    
    <script type="module">
        import { setupSocketHandlers, showScreen, UIElements, showGlobalMessage } from './game.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            window.languageManager.initLanguage();
        });
        
        window.toggleLanguageSelector = languageManager.toggleLanguageSelector;
        window.setLanguage = languageManager.setLanguage;

        // Socket.IO sunucu URL'si
        const LIVE_SERVER_URL = 'https://beta-github-io.onrender.com'; // Render √ºzerindeki Socket.IO sunucusu
        let socket;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        function validateInput() {
            const username = UIElements.usernameInput.value.trim();
            if (username.length < 2) {
                UIElements.showGlobalMessage('Z…ôhm…ôt olmasa etibarlƒ± bir istifad…ô√ßi adƒ± daxil edin.', true);
                return false;
            }
            return username;
        }

        function connectToServer() {
            try {
                console.log('Sunucuya baƒülanƒ±lƒ±yor:', LIVE_SERVER_URL);
                
                socket = io(LIVE_SERVER_URL, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    timeout: 20000,
                    forceNew: true
                });

                socket.on('connect', () => {
                    console.log('Sunucuya ba≈üarƒ±yla baƒülandƒ±');
                    reconnectAttempts = 0; // Baƒülantƒ± ba≈üarƒ±lƒ± olursa yeniden deneme sayacƒ±nƒ± sƒ±fƒ±rla
                    UIElements.showGlobalMessage('Sunucuya baƒülandƒ±. E≈üle≈ümeye hazƒ±rsƒ±nƒ±z.', false, true); // success mesajƒ±
                    showScreen('lobby');
                });
                
                socket.on('connect_error', (err) => {
                    console.error('Baƒülantƒ± Hatasƒ±:', err);
                    reconnectAttempts++;
                    
                    if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                        UIElements.showGlobalMessage('Sunucuya baƒülanƒ±lamadƒ±. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edip sayfayƒ± yenileyin.', true);
                    } else {
                        UIElements.showGlobalMessage(`Baƒülantƒ± hatasƒ±. Tekrar deneniyor (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`, true);
                    }
                    
                    showScreen('lobby');
                });
                
                socket.on('disconnect', (reason) => {
                    console.log('Baƒülantƒ± kesildi, sebep:', reason);
                    if (reason === 'io server disconnect') {
                        // Sunucu baƒülantƒ±yƒ± kestiƒüinde yeniden baƒülan
                        socket.connect();
                    }
                    UIElements.showGlobalMessage('Baƒülantƒ± kesildi. Yeniden baƒülanƒ±lƒ±yor...', true);
                });
                
                socket.on('reconnect', (attemptNumber) => {
                    console.log(`Yeniden baƒülantƒ± ba≈üarƒ±lƒ± (${attemptNumber}. deneme)`);
                    UIElements.showGlobalMessage('Sunucuya yeniden baƒülanƒ±ldƒ±.', false, true); // success mesajƒ±
                });
                
                socket.on('reconnect_failed', () => {
                    console.error('Yeniden baƒülantƒ± ba≈üarƒ±sƒ±z oldu');
                    UIElements.showGlobalMessage('Sunucuya baƒülanƒ±lamadƒ±. L√ºtfen sayfayƒ± yenileyin.', true);
                });

                // --- E≈üle≈üme Olaylarƒ± ---
                socket.on('roomCreated', (code) => {
                    document.getElementById('roomCodeDisplay').textContent = code;
                    document.getElementById('waitTitle').textContent = 'Otaƒüƒ±nƒ±z Quruldu! üéâ';
                    document.getElementById('codeArea').classList.remove('hidden');
                    document.getElementById('waitStatus').textContent = 'Otaq kodunu dostunuza g√∂nd…ôrin v…ô qo≈üulmasƒ±nƒ± g√∂zl…ôyin.';
                });
                
                socket.on('joinFailed', (message) => {
                    UIElements.showGlobalMessage(message, true);
                    showScreen('lobby');
                });
                
                socket.on('gameStart', ({ players, roomCode }) => {
                    const opponent = players.find(p => p.id !== socket.id);
                    const self = players.find(p => p.id === socket.id);
                    
                    setupSocketHandlers(socket, roomCode, self.isHost, opponent.username);
                });

            } catch (e) {
                console.error('Socket.IO genel hatasƒ±:', e);
                UIElements.showGlobalMessage('Kritik qo≈üulma x…ôtasƒ± ba≈ü verdi.', true);
            }
        }
        
        // --- Olay Dinleyicileri ---
        document.getElementById('createRoomBtn').addEventListener('click', () => {
            const username = validateInput();
            if (!username) return;
            
            showScreen('wait');
            document.getElementById('waitTitle').textContent = 'Otaq Qurulur...';
            document.getElementById('waitStatus').textContent = 'Z…ôhm…ôt olmasa g√∂zl…ôyin...';
            document.getElementById('codeArea').classList.add('hidden');
            socket.emit('createRoom', { username });
        });
        
        document.getElementById('joinRoomBtn').addEventListener('click', () => {
            const username = validateInput();
            if (!username) return;
            
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!roomCode) {
                UIElements.showGlobalMessage('Xahi≈ü olunur otaq kodunu daxil edin', true);
                return;
            }
            
            showScreen('wait');
            document.getElementById('waitTitle').textContent = `Otaƒüa Qo≈üulma: ${roomCode}`;
            document.getElementById('waitStatus').textContent = 'Qo≈üulunur...';
            document.getElementById('codeArea').classList.add('hidden');
            socket.emit('joinRoom', { username, roomCode });
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            if (socket && socket.connected) {
                socket.emit('leaveRoom', { roomCode: document.getElementById('roomCodeDisplay').textContent });
            }
            UIElements.resetGame();
        });
        
        document.getElementById('endGameBtn').addEventListener('click', UIElements.resetGame);
        
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            const textToCopy = document.getElementById('roomCodeDisplay').textContent;
            navigator.clipboard.writeText(textToCopy)
                .then(() => UIElements.showGlobalMessage('Otaq Kodu Kopyalandƒ±!', false, true))
                .catch(() => UIElements.showGlobalMessage('Kopyalama uƒüursuz oldu.', true));
        });

        document.addEventListener('DOMContentLoaded', connectToServer);
    </script>
</body>
</html>
