<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Domino 101 Pro - Realistic</title>

    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            background: #0f2027;
            background: linear-gradient(to right, #203a43, #2c5364);
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- REALISTIC DOMINO TILE STYLES --- */
        .domino-tile-3d {
            position: relative;
            background: #fdfbf7;
            /* Bone white */
            border-radius: 4px;
            box-shadow:
                inset 0 0 5px rgba(255, 255, 255, 0.8),
                /* Inner highlight */
                inset -2px -2px 4px rgba(0, 0, 0, 0.1),
                /* Inner shadow */
                1px 1px 0px #bbb,
                /* Fake 3D depth sides */
                2px 2px 0px #999,
                2px 4px 6px rgba(0, 0, 0, 0.4);
            /* Drop shadow */
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            z-index: 10;
        }

        .domino-tile-3d:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        }

        .domino-tile-3d.selected {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 0 15px #fbbf24, 4px 8px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #fbbf24;
            z-index: 50;
        }

        /* Different Sizes */
        .tile-hand {
            width: 44px;
            height: 88px;
            flex-direction: column;
        }

        .tile-board-h {
            width: 70px;
            height: 35px;
            flex-direction: row;
        }

        .tile-board-v {
            width: 35px;
            height: 70px;
            flex-direction: column;
        }

        /* Divider Line */
        .tile-divider-h {
            width: 2px;
            height: 80%;
            background: #d1d5db;
            position: absolute;
            left: 50%;
            top: 10%;
            transform: translateX(-50%);
            box-shadow: inset 1px 0 1px rgba(0, 0, 0, 0.1);
        }

        .tile-divider-v {
            width: 80%;
            height: 2px;
            background: #d1d5db;
            position: absolute;
            top: 50%;
            left: 10%;
            transform: translateY(-50%);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        /* PIPS (Dots) - Deep Inset Look */
        .pip {
            width: 7px;
            height: 7px;
            background: #111;
            border-radius: 50%;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.8), 0 1px 0 rgba(255, 255, 255, 0.5);
            /* Inset effect */
        }

        .pip-red {
            background: #d93025;
        }

        /* Optional: Color pips? Standard is black usually */

        .pip-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            padding: 4px;
            place-items: center;
        }

        /* --- BOARD TEXTURE --- */
        .wood-table {
            background-color: #2e7d32;
            background-image: url("https://www.transparenttextures.com/patterns/felt.png"), radial-gradient(circle, #388e3c, #1b5e20);
            box-shadow: inset 0 0 50px #000;
        }

        /* --- INDICATORS --- */
        .valid-zone {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(251, 191, 36, 0.3);
            border: 3px dashed #fbbf24;
            animation: spin-slow 8s linear infinite, pulse 2s infinite;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 1px 3px #000;
            cursor: pointer;
        }

        @keyframes spin-slow {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes pulse {
            50% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        /* Loading */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #fbbf24;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast-enter {
            transform: translateY(-20px);
            opacity: 0;
        }

        .toast-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const WS_URL = 'wss://beta-github-io.onrender.com';
        const API_URL = 'https://beta-github-io.onrender.com';

        /* --- DOMINO TILE COMPONENT (REALISTIC) --- */
        const Pips = ({ n }) => {
            const map = { 0: [], 1: [4], 2: [0, 8], 3: [0, 4, 8], 4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 2, 3, 5, 6, 8] };
            const active = map[n] || [];
            return (
                <div className="pip-grid">
                    {[0, 1, 2, 3, 4, 5, 6, 7, 8].map(i => (
                        <div key={i} className="pip" style={{ opacity: active.includes(i) ? 1 : 0 }} />
                    ))}
                </div>
            );
        };

        const Tile = ({ vals, onClick, selected, isBoard, dir = 'right' }) => {
            // isBoard = true ise masa ta≈üƒ±, false ise el ta≈üƒ±
            // dir = 'left'|'right'|'up'|'down'

            const isVert = isBoard ? (dir === 'up' || dir === 'down') : true; // El ta≈üƒ± her zaman dikey
            const className = `domino-tile-3d flex items-center justify-center ${isBoard ? (isVert ? 'tile-board-v' : 'tile-board-h') : 'tile-hand'
                } ${selected ? 'selected' : ''}`;

            return (
                <div className={className} onClick={onClick}>
                    <div className="flex-1 w-full h-full"><Pips n={vals[0]} /></div>
                    <div className={isVert ? 'tile-divider-v' : 'tile-divider-h'}></div>
                    <div className="flex-1 w-full h-full"><Pips n={vals[1]} /></div>
                </div>
            );
        };

        const Toast = ({ msg, type }) => (
            <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-2xl font-bold text-white flex gap-3 items-center toast-enter-active
                ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'}`}>
                <span>{type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                {msg}
            </div>
        );

        /* --- MAIN APP --- */
        const App = () => {
            const [page, setPage] = useState('lobby');
            const [ws, setWs] = useState(null);
            const [me, setMe] = useState(null);
            const [game, setGame] = useState(null);
            const [opp, setOpp] = useState(null);
            const [lead, setLead] = useState([]);
            const [notif, setNotif] = useState(null);
            const [searching, setSearching] = useState(false);

            // Game Interaction
            const [selTile, setSelTile] = useState(null);
            const [validMoves, setValidMoves] = useState([]);

            // Pan/Zoom
            const [view, setView] = useState({ x: 0, y: 0, s: 1 });
            const touch = useRef({ x: 0, y: 0, d: 0 });

            const notify = (msg, type = 'info') => { setNotif({ msg, type }); setTimeout(() => setNotif(null), 3000); };

            useEffect(() => {
                const init = async () => {
                    let u = { username: 'Guest', telegramId: 'g' + Date.now() };
                    if (tg?.initDataUnsafe?.user) {
                        const t = tg.initDataUnsafe.user;
                        u = { telegramId: String(t.id), username: t.first_name, photoUrl: t.photo_url };
                    }

                    try {
                        const r = await fetch(API_URL + '/api/auth/telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(u) });
                        const d = await r.json();
                        if (d.success) setMe(d.player); else setMe(u);
                    } catch (e) { setMe(u); }

                    connectWS(u.telegramId);
                };
                init();
            }, []);

            const connectWS = (tid) => {
                const s = new WebSocket(WS_URL);
                s.onopen = () => {
                    setWs(s);
                    s.send(JSON.stringify({ type: 'reconnect', telegramId: tid }));
                };
                s.onmessage = (e) => handleMsg(JSON.parse(e.data));
                s.onclose = () => setTimeout(() => connectWS(tid), 3000);
            };

            const send = (type, data = {}) => {
                if (ws?.readyState === 1) ws.send(JSON.stringify({ type, telegramId: me.telegramId, ...data }));
            };

            const handleMsg = (d) => {
                if (d.type === 'reconnectSuccess' || d.type === 'gameStart') {
                    setGame(d.gameState);
                    const op = Object.values(d.gameState.players).find(p => p.name !== me.username); // Simple Find
                    // Better: find by ID key != me.telegramId
                    const opId = Object.keys(d.gameState.players).find(k => k !== me.telegramId);
                    if (opId) setOpp(d.gameState.players[opId]);

                    setPage('game');
                    setSearching(false);
                }
                if (d.type === 'gameUpdate') {
                    setGame(p => ({ ...p, ...d.gameState }));
                    setSelTile(null);
                    setValidMoves([]);
                }
                if (d.type === 'matchFound') {
                    setOpp(d.opponent);
                    notify('Rakib Tapƒ±ldƒ±!', 'success');
                }
                if (d.type === 'gameEnd') {
                    setPage('result');
                    setGame(cur => ({ ...cur, winnerInfo: d }));
                }
                if (d.type === 'error') notify(d.message, 'error');
            };

            // --- GAME RULES LOGIC ---
            const getValidMoves = (tile) => {
                if (!game?.board.length) return ['start']; // ƒ∞lk hamle
                // Basit mantƒ±k: Server array of arrays yolluyor [[1,2], [2,3]]
                const L = game.board[0][0];
                const R = game.board[game.board.length - 1][1];
                const m = [];
                // Tile [a,b]
                if (tile[0] === L || tile[1] === L) m.push('left');
                if (tile[0] === R || tile[1] === R) m.push('right');
                return m;
            };

            const canPlayAny = (hand) => {
                if (!game?.board.length) return true;
                const L = game.board[0][0];
                const R = game.board[game.board.length - 1][1];
                return hand.some(t => t[0] === L || t[1] === L || t[0] === R || t[1] === R);
            };

            const handleTileClick = (idx) => {
                if (game.currentPlayer !== me.telegramId) return notify('Sƒ±ra sizde deƒüil!', 'error');
                const tile = game.players[me.telegramId].hand[idx];
                const moves = getValidMoves(tile);
                if (!moves.length) return notify('Bu ta≈ü uygun deƒüil!', 'error');
                setSelTile(idx);
                setValidMoves(moves);
            };

            const play = (pos) => {
                send('playTile', { tileIndex: selTile, position: pos });
            };

            const draw = () => {
                if (game.currentPlayer !== me.telegramId) return notify('Sƒ±ra sizde deƒüil!', 'error');

                // GLOBAL RULE: Elinde oynayacak ta≈ü varsa pazara gidemezsin!
                const myHand = game.players[me.telegramId].hand;
                if (canPlayAny(myHand)) {
                    return notify('Elinizde oynanabilir ta≈ü varken pazara gidemezsiniz! Kurallar b√∂yle.', 'error');
                }

                send('drawFromMarket');
            };

            // --- RENDER HELPERS ---
            const renderBoard = () => {
                if (!game?.board) return null;
                // Simple straight line layout for robustness
                // Center calculated dynamically
                let items = [];
                let x = 0; const W = 70;
                game.board.forEach((t, i) => {
                    items.push({ val: t, x, y: 0 });
                    x += W;
                });
                // Center it
                const offset = - (x - W) / 2;
                return items.map(it => ({ ...it, x: it.x + offset }));
            };

            // --- PAN ZOOM HANDLERS ---
            const onTouchStart = (e) => {
                if (e.touches.length === 1) touch.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                if (e.touches.length === 2) touch.current.d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            };
            const onTouchMove = (e) => {
                if (e.touches.length === 1) {
                    const dx = e.touches[0].clientX - touch.current.x;
                    const dy = e.touches[0].clientY - touch.current.y;
                    touch.current.x = e.touches[0].clientX; touch.current.y = e.touches[0].clientY;
                    setView(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
                }
                if (e.touches.length === 2) {
                    const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    const s = d / touch.current.d;
                    touch.current.d = d;
                    setView(v => ({ ...v, s: Math.min(2, Math.max(0.5, v.s * s)) }));
                }
            };

            // --- PAGES ---

            if (page === 'lobby') return (
                <div className="h-screen flex flex-col items-center justify-center text-white relative p-6">
                    {/* Background Detail */}
                    <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(circle, #fff 1px, transparent 1px)', backgroundSize: '30px 30px' }}></div>

                    {me && <div className="z-10 text-center mb-8">
                        <img src={me.photoUrl || 'https://via.placeholder.com/100'} className="w-24 h-24 rounded-full border-4 border-yellow-400 shadow-xl mx-auto mb-4" />
                        <h1 className="text-3xl font-black">{me.username}</h1>
                        <div className="text-yellow-400 font-bold">{me.elo} ELO</div>
                    </div>}

                    <div className="z-10 w-full max-w-sm space-y-4">
                        <button onClick={() => { setSearching(true); setPage('searching'); send('findMatch', me); }}
                            className="w-full py-4 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl font-black text-xl shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 transition-all">
                            ‚öîÔ∏è OYUN BUL
                        </button>
                        <div className="flex gap-4">
                            <input placeholder="Oda Kodu" className="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 text-center placeholder-gray-400" id="codeIn" />
                            <button onClick={() => {
                                const c = document.getElementById('codeIn').value.toUpperCase();
                                if (c) send('joinRoom', { roomCode: c });
                            }} className="bg-blue-600 px-6 rounded-xl font-bold">Gƒ∞R</button>
                        </div>
                        <button onClick={() => { send('createRoom', me); notify('Oda yaradƒ±ldƒ±...', 'success'); }} className="block w-full text-sm text-gray-400 underline">√ñzel Oda Yarat</button>
                    </div>
                    {notif && <Toast msg={notif.msg} type={notif.type} />}
                </div>
            );

            if (page === 'searching') return (
                <div className="h-screen flex flex-col items-center justify-center text-white p-6">
                    {opp ? (
                        <div className="text-center animate-pulse">
                            <div className="text-3xl font-bold text-green-400 mb-6">RAKƒ∞B TAPILDI!</div>
                            <img src={opp.photoUrl} className="w-32 h-32 rounded-full border-4 border-green-500 shadow-2xl mx-auto" />
                            <div className="text-2xl font-bold mt-4">{opp.username || opp.name}</div>
                        </div>
                    ) : (
                        <div className="text-center">
                            <div className="loader mx-auto mb-8"></div>
                            <h2 className="text-2xl font-bold">Rakib Aranƒ±r...</h2>
                            <button onClick={() => { setPage('lobby'); send('cancelSearch'); }} className="mt-8 text-red-400 font-bold border border-red-400 px-6 py-2 rounded-full">L…ôƒüv Et</button>
                        </div>
                    )}
                </div>
            );

            if (page === 'result') return (
                <div className="h-screen bg-black/90 flex flex-col items-center justify-center text-white p-6 text-center z-50">
                    <h1 className={`text-6xl font-black mb-4 ${game?.winnerInfo?.isWinner ? 'text-green-500' : 'text-red-500'}`}>
                        {game?.winnerInfo?.isWinner ? 'QAZANDIN!' : 'M∆èƒûLUB'}
                    </h1>
                    <p className="text-xl text-gray-300 mb-8">{game?.winnerInfo?.message}</p>
                    <div className="text-4xl font-mono font-bold mb-12">
                        {game?.winnerInfo?.eloChange > 0 ? '+' : ''}{game?.winnerInfo?.eloChange} ELO
                    </div>
                    <button onClick={() => { setPage('lobby'); setGame(null); }} className="bg-white text-black px-10 py-4 rounded-full font-bold text-xl hover:scale-110 transition-transform">TAMAM</button>
                </div>
            );

            if (page === 'game' && game) return (
                <div className="fixed inset-0 wood-table flex flex-col overflow-hidden">
                    {notif && <Toast msg={notif.msg} type={notif.type} />}

                    {/* Header */}
                    <div className="bg-black/40 backdrop-blur p-2 flex justify-between items-center z-20 shadow-lg">
                        <div className="flex items-center gap-3">
                            <img src={opp?.photoUrl} className="w-10 h-10 rounded-full border-2 border-white/20" />
                            <div>
                                <div className="text-white font-bold text-sm leading-tight">{opp?.name || 'Rakib'}</div>
                                <div className="text-xs text-yellow-400">üî• {game.players[opp?.telegramId]?.handCount || 7} das</div>
                            </div>
                        </div>
                        <div className={`px-4 py-1 rounded-full text-xs font-black tracking-wider ${game.currentPlayer === me.telegramId ? 'bg-yellow-500 text-black animate-pulse' : 'bg-white/10 text-white/50'}`}>
                            {game.currentPlayer === me.telegramId ? 'Sƒ∞Zƒ∞N SIRANIZ' : 'RAKƒ∞B D√ú≈û√úN√úR...'}
                        </div>
                    </div>

                    {/* Board Area */}
                    <div className="flex-1 relative overflow-hidden"
                        onTouchStart={onTouchStart} onTouchMove={onTouchMove}>

                        <div className="absolute top-1/2 left-1/2 transition-transform duration-75"
                            style={{ transform: `translate(-50%, -50%) translate(${view.x}px, ${view.y}px) scale(${view.s})` }}>

                            <div className="relative">
                                {renderBoard()?.map((b, i) => (
                                    <div key={i} className="absolute" style={{ left: b.x, top: b.y, transform: 'translate(-50%,-50%)' }}>
                                        <Tile vals={b.val} isBoard={true} dir={'right'} />
                                    </div>
                                ))}

                                {/* Indicators */}
                                {validMoves.length > 0 && renderBoard() && (
                                    <>
                                        {validMoves.includes('left') &&
                                            <div className="valid-zone left-[-50px]"
                                                style={{ left: (renderBoard()[0]?.x) - 50, top: 0, transform: 'translate(-50%,-50%)' }}
                                                onClick={() => play('left')}>SOL</div>}

                                        {validMoves.includes('right') &&
                                            <div className="valid-zone"
                                                style={{ left: (renderBoard()[renderBoard().length - 1]?.x) + 50, top: 0, transform: 'translate(-50%,-50%)' }}
                                                onClick={() => play('right')}>SAƒû</div>}

                                        {validMoves.includes('start') &&
                                            <div className="valid-zone" style={{ left: 0, top: 0, transform: 'translate(-50%,-50%)' }} onClick={() => play('left')}>BA≈ûLA</div>}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Hand Area */}
                    <div className="bg-gradient-to-t from-black/90 to-transparent pb-6 pt-10 px-4 z-20 flex flex-col items-center">
                        <div className="flex items-end justify-center gap-1 mb-4 h-[100px]">
                            {game.players[me.telegramId].hand.map((t, i) => (
                                <div key={i} className="transition-all hover:-translate-y-2">
                                    <Tile vals={t} onClick={() => handleTileClick(i)} selected={selTile === i} />
                                </div>
                            ))}
                        </div>

                        <div className="w-full flex justify-between items-center max-w-md">
                            <button onClick={() => { if (confirm('√áƒ±kmak istiyor musunuz? Kaybedeceksiniz.')) send('leaveGame'); }}
                                className="text-red-400 font-bold text-xs bg-red-900/20 px-4 py-2 rounded-full border border-red-900/50">√áIXI≈û</button>

                            <button onClick={draw}
                                disabled={game.currentPlayer !== me.telegramId || game.market === 0}
                                className={`font-bold px-6 py-3 rounded-full shadow-lg transition-all flex items-center gap-2
                                    ${(game.currentPlayer === me.telegramId && game.market > 0)
                                        ? canPlayAny(game.players[me.telegramId].hand)
                                            ? 'bg-gray-600 text-gray-400 cursor-not-allowed opacity-50' // Has moves -> Disabled visually
                                            : 'bg-blue-600 text-white active:scale-95' // No moves -> Enabled
                                        : 'bg-gray-700 text-gray-500 opacity-50'}`}>
                                üé≤ BAZAR ({game.market})
                            </button>
                        </div>
                    </div>
                </div>
            );

            return <div className="h-screen bg-slate-900 flex items-center justify-center text-white"><div className="loader"></div></div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
