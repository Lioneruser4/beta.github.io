<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’£ Emoji Bomb 1v1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ana Stiller ve Arka Plan */
        body {
            font-family: 'Inter', sans-serif;
            /* Gradient arka plan */
            background: linear-gradient(to bottom right, #1a1a1a, #333333);
            color: #f0f0f0;
            overflow: hidden; /* Tam ekran, kaydÄ±rma yok */
        }

        /* Ana ekran konteyneri */
        .screen {
            width: 100vw;
            height: 100vh;
            display: none; /* VarsayÄ±lan olarak gizli */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            box-sizing: border-box;
            text-align: center;
        }
        
        /* Aktif ekranÄ± gÃ¶ster */
        .screen.active {
            display: flex;
        }

        /* YÃ¼kleniyor EkranÄ± Animasyonu */
        @keyframes pulse-spin {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
        }
        .loader-anim {
            animation: pulse-spin 2.5s infinite ease-in-out;
        }
        
        /* BÃ¼yÃ¼k Buton Stilleri */
        .btn {
            @apply w-full max-w-xs text-xl font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-500 active:scale-95;
        }
        .btn-secondary {
            @apply bg-green-600 text-white hover:bg-green-500 active:scale-95;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-500 active:scale-95;
        }
        
        /* GiriÅŸ AlanlarÄ± */
        .input-field {
            @apply w-full max-w-xs text-lg bg-gray-700 text-white border-2 border-gray-600 rounded-lg p-4 text-center placeholder-gray-400 focus:outline-none focus:border-blue-500;
        }

        /* BaÄŸlantÄ± Metin AlanlarÄ± (Offer/Answer) */
        .signal-textarea {
            @apply w-full max-w-md h-24 text-xs bg-gray-800 text-gray-300 rounded-lg p-2 border border-gray-600 resize-none;
        }

        /* 3D Kart DÃ¶ndÃ¼rme Animasyonu */
        .card-container {
            perspective: 1000px;
            aspect-ratio: 1 / 1; /* Kare kartlar */
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-container.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            @apply rounded-lg shadow-md flex items-center justify-center;
        }
        .card-front {
            @apply bg-blue-500 text-3xl;
        }
        .card-back {
            @apply bg-gray-600 text-4xl;
            transform: rotateY(180deg);
        }

        /* SarsÄ±ntÄ± (Shake) Animasyonu - Bomba */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake {
            animation: shake 0.4s ease-in-out;
        }

        /* TitreÅŸim (Vibrate) Animasyonu - Az Kart KaldÄ±ÄŸÄ±nda */
        @keyframes vibrate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1.5deg); }
            75% { transform: rotate(-1.5deg); }
        }
        .vibrating {
            animation: vibrate 0.2s infinite;
        }
        
        /* Oyun Sonu EkranÄ± Overlay */
        #endScreen {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100;
        }

        /* Global Mesaj */
        #globalMessage.show {
            display: block;
            animation: fadeInDown 0.3s ease-out;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white select-none">

    <div id="globalMessage" class="hidden fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg z-50">
        <p id="globalMessageText"></p>
        <button id="globalMessageClose" class="absolute top-2 right-3 text-2xl font-bold">&times;</button>
    </div>

    <div id="loader" class="screen active">
        <div class="loader-anim text-center">
            <div class="text-7xl">ğŸ’£</div>
            <h1 class="text-4xl font-black mt-4">Emoji Bomb</h1>
        </div>
    </div>

    <div id="lobby" class="screen">
        <div class="w-full max-w-md space-y-4">
            <h1 class="text-5xl font-black text-center">ğŸ’£ Emoji Bomb</h1>
            <p class="text-lg text-gray-300 text-center">ArkadaÅŸÄ±nla 1v1 oyna! Oda kur veya bir odaya katÄ±l.</p>
            
            <input type="text" id="username" class="input-field" placeholder="KullanÄ±cÄ± AdÄ±">
            
            <button id="createRoomBtn" class="btn btn-primary">ğŸ® Oda Kur</button>
            <button id="joinRoomBtn" class="btn btn-secondary">ğŸ” KatÄ±l</button>
        </div>
    </div>
    
    <div id="connectScreen" class="screen">
        <div class="w-full max-w-lg space-y-3">
            <h2 id="connectTitle" class="text-2xl font-bold">BaÄŸlantÄ± Kuruluyor...</h2>
            
            <div id="hostConnect" class="space-y-3 hidden">
                <p class="text-lg">Oda Kodu: <strong id="roomCodeDisplay" class="text-2xl text-yellow-400 tracking-widest"></strong></p>
                
                <label class="text-left w-full block">1. Bu Teklif Kodunu kopyala ve arkadaÅŸÄ±na gÃ¶nder:</label>
                <p class="text-xs text-gray-400 text-left"><i>(Not: Bu kodun Ã§ok uzun olmasÄ± normaldir.)</i></p>
                <textarea id="offerText" class="signal-textarea" readonly></textarea>
                <button id="copyOfferBtn" class="btn btn-primary text-sm py-2">Teklifi Kopyala</button>
                
                <label class="text-left w-full block">2. ArkadaÅŸÄ±ndan gelen Cevap Kodunu buraya yapÄ±ÅŸtÄ±r:</label>
                <textarea id="answerTextHost" class="signal-textarea" placeholder="ArkadaÅŸÄ±nÄ±n cevap kodunu bekle..."></textarea>
                <button id="applyAnswerBtn" class="btn btn-secondary text-sm py-2">CevabÄ± Uygula</button>
                
                <p id="hostStatus" class="text-green-400">BaÄŸlantÄ± kuruluyor...</p>
            </div>
            
            <div id="guestConnect" class="space-y-3 hidden">
                <label class="text-left w-full block">1. ArkadaÅŸÄ±nÄ±n Teklif Kodunu buraya yapÄ±ÅŸtÄ±r:</label>
                <textarea id="offerTextGuest" class="signal-textarea" placeholder="ArkadaÅŸÄ±nÄ±n teklif kodunu yapÄ±ÅŸtÄ±r..."></textarea>
                
                <button id="createAnswerBtn" class="btn btn-secondary">Cevap OluÅŸtur</button>
                
                <label class="text-left w-full block">2. Bu Cevap Kodunu kopyala ve arkadaÅŸÄ±na geri gÃ¶nder:</label>
                <p class="text-xs text-gray-400 text-left"><i>(Not: Bu kodun Ã§ok uzun olmasÄ± normaldir.)</i></p>
                <textarea id="answerTextGuest" class="signal-textarea" readonly></textarea>
                <button id="copyAnswerBtn" class="btn btn-primary text-sm py-2 hidden">CevabÄ± Kopyala</button>

                <p id="guestStatus" class="text-green-400">BaÄŸlantÄ± bekleniyor...</p>
            </div>
            <button id="cancelConnectBtn" class="btn btn-danger text-base py-2">Ä°ptal Et</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="w-full max-w-3xl absolute top-0 left-1/2 -translate-x-1/2 p-4">
            <div class="flex justify-between items-center text-lg sm:text-2xl font-bold">
                <div id="player1Info" class="text-left">
                    <span id="player1Name">Oyuncu 1</span>
                    <div id="player1Lives" class="text-3xl">â¤ï¸â¤ï¸</div>
                </div>
                <div id="player2Info" class="text-right">
                    <span id="player2Name">Oyuncu 2</span>
                    <div id="player2Lives" class="text-3xl">â¤ï¸â¤ï¸</div>
                </div>
            </div>
            <p id="turnIndicator" class="text-center text-xl sm:text-2xl font-bold text-yellow-400 mt-4"></p>
        </div>
        
        <div id="gameGrid" class="w-full max-w-3xl grid gap-2 sm:gap-3 p-4 mt-32">
            </div>
    </div>
    
    <div id="endScreen" class="screen absolute top-0 left-0">
        <div class="text-center space-y-6">
            <h1 id="endMessage" class="text-6xl font-black">KazandÄ±n! ğŸ‰</h1>
            <button id="playAgainBtn" class="btn btn-primary">Tekrar Oyna</button>
            <button id="backToLobbyBtn" class="btn btn-secondary text-base py-3">Lobiye DÃ¶n</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ReferanslarÄ± ---
            const screens = {
                loader: document.getElementById('loader'),
                lobby: document.getElementById('lobby'),
                connect: document.getElementById('connectScreen'),
                game: document.getElementById('gameScreen'),
                end: document.getElementById('endScreen'),
            };
            const globalMessage = document.getElementById('globalMessage');
            const globalMessageText = document.getElementById('globalMessageText');
            const globalMessageClose = document.getElementById('globalMessageClose');

            const usernameInput = document.getElementById('username');
            const createRoomBtn = document.getElementById('createRoomBtn');
            const joinRoomBtn = document.getElementById('joinRoomBtn');

            const connectTitle = document.getElementById('connectTitle');
            const hostConnect = document.getElementById('hostConnect');
            const guestConnect = document.getElementById('guestConnect');
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            const offerText = document.getElementById('offerText');
            const copyOfferBtn = document.getElementById('copyOfferBtn');
            const answerTextHost = document.getElementById('answerTextHost');
            const applyAnswerBtn = document.getElementById('applyAnswerBtn');
            const hostStatus = document.getElementById('hostStatus');
            const offerTextGuest = document.getElementById('offerTextGuest');
            const createAnswerBtn = document.getElementById('createAnswerBtn');
            const answerTextGuest = document.getElementById('answerTextGuest');
            const copyAnswerBtn = document.getElementById('copyAnswerBtn');
            const guestStatus = document.getElementById('guestStatus');
            const cancelConnectBtn = document.getElementById('cancelConnectBtn');

            const gameGrid = document.getElementById('gameGrid');
            const player1NameEl = document.getElementById('player1Name');
            const player2NameEl = document.getElementById('player2Name');
            const player1LivesEl = document.getElementById('player1Lives');
            const player2LivesEl = document.getElementById('player2Lives');
            const turnIndicator = document.getElementById('turnIndicator');
            const endMessage = document.getElementById('endMessage');
            const playAgainBtn = document.getElementById('playAgainBtn');
            const backToLobbyBtn = document.getElementById('backToLobbyBtn');

            // --- Oyun Durumu (State) ---
            let peerConnection;
            let dataChannel;
            let isHost = false;
            let username = '';
            let roomCode = '';
            let gameStarted = false;

            // Oyunun dahili durumu
            const EMOJIS = ["ğŸ", "ğŸŠ", "ğŸ‹", "ğŸ¥", "ğŸ‡", "ğŸ‰", "ğŸ“", "ğŸ"];
            let cards = [];
            let lives = { player1: 2, player2: 2 };
            let myTurn = false;
            let player1Username = '';
            let player2Username = '';
            let flippedCards = [];
            let matchCount = 0;
            let totalPairs = 0;
            let bombsToPlace = 0; // Bu kÄ±sÄ±m oyun mantÄ±ÄŸÄ± ile ilgili

            // WebRTC YapÄ±landÄ±rmasÄ± (STUN sunucularÄ±)
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                ]
            };


            // --- Temel Fonksiyonlar ---

            function showGlobalMessage(message, isError = true) {
                globalMessageText.textContent = message;
                globalMessage.classList.remove('bg-red-600', 'bg-green-600');
                if (isError) {
                    globalMessage.classList.add('bg-red-600');
                } else {
                    globalMessage.classList.add('bg-green-600');
                }
                globalMessage.classList.remove('hidden');
                globalMessage.classList.add('show');

                // 3 saniye sonra otomatik gizle
                setTimeout(hideGlobalMessage, 3000);
            }
            
            function hideGlobalMessage() {
                globalMessage.classList.add('hidden');
                globalMessage.classList.remove('show');
            }

            function showScreen(screenId) {
                Object.values(screens).forEach(screen => {
                    screen.classList.remove('active');
                });
                screens[screenId].classList.add('active');
            }

            function copyToClipboard(text, btn) {
                if (!text) {
                    showGlobalMessage('Kopyalanacak metin boÅŸ.');
                    return;
                }
                const originalText = btn.textContent;
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);

                    btn.textContent = 'KopyalandÄ±!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 1500);
                } catch(e) {
                    showGlobalMessage('Kopyalama baÅŸarÄ±sÄ±z. LÃ¼tfen manuel kopyalayÄ±n.');
                }
            }

            function generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            function validateUsername() {
                username = usernameInput.value.trim();
                if (username.length < 2) {
                    showGlobalMessage('LÃ¼tfen geÃ§erli bir kullanÄ±cÄ± adÄ± girin (en az 2 karakter).');
                    return false;
                }
                return true;
            }
            
            function resetToLobby() {
                if (dataChannel) {
                    dataChannel.close();
                }
                if (peerConnection) {
                    peerConnection.close();
                }
                dataChannel = null;
                peerConnection = null;
                isHost = false;
                gameStarted = false;
                roomCode = '';
                
                hostConnect.classList.add('hidden');
                guestConnect.classList.add('hidden');
                offerText.value = '';
                answerTextHost.value = '';
                offerTextGuest.value = '';
                answerTextGuest.value = '';
                copyAnswerBtn.classList.add('hidden');
                
                showScreen('lobby');
            }


            // --- WebRTC SinyalleÅŸme FonksiyonlarÄ± ---

            // WebRTC baÄŸlantÄ±sÄ±nÄ± baÅŸlatÄ±r
            async function startConnection(is_Host) {
                isHost = is_Host;
                peerConnection = new RTCPeerConnection(config);

                // Ortak ICE AdayÄ± Toplama OlayÄ±
                peerConnection.onicecandidate = event => {
                    // event.candidate null olduÄŸunda, ICE toplanmasÄ± tamamlanmÄ±ÅŸtÄ±r
                    // ve localDescription (offer/answer) hazÄ±rdÄ±r.
                    if (!event.candidate) {
                        console.log('ICE Toplama tamamlandÄ± (onicecandidate null).');
                        if (isHost) {
                            if(offerText.value.length === 0) { // Sadece ilk kez doldur
                                offerText.value = JSON.stringify(peerConnection.localDescription);
                                hostStatus.textContent = 'Teklifi arkadaÅŸÄ±na gÃ¶nder ve cevabÄ± bekle.';
                            }
                        } else {
                            // Misafir iÃ§in cevap hazÄ±r
                            if(answerTextGuest.value.length === 0 && peerConnection.localDescription) { // Sadece ilk kez doldur
                                answerTextGuest.value = JSON.stringify(peerConnection.localDescription);
                                copyAnswerBtn.classList.remove('hidden');
                                guestStatus.textContent = 'CevabÄ± kopyala ve arkadaÅŸÄ±na geri gÃ¶nder.';
                            }
                        }
                    }
                };

                // AÄŸ durumu deÄŸiÅŸtiÄŸinde
                peerConnection.onconnectionstatechange = () => {
                    console.log('BaÄŸlantÄ± Durumu:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        showGlobalMessage('BaÄŸlantÄ± BaÅŸarÄ±lÄ±!', false);
                        if (isHost) {
                            hostStatus.textContent = 'BaÄŸlandÄ±! Oyun baÅŸlÄ±yor...';
                        } else {
                            guestStatus.textContent = 'BaÄŸlandÄ±! Oyun baÅŸlÄ±yor...';
                        }
                        // Not: startGame, datachannel.onopen'da Ã§aÄŸrÄ±lacak.
                    }
                    if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                        showGlobalMessage('BaÄŸlantÄ± koptu veya kurulamadÄ±. Lobiye dÃ¶nÃ¼lÃ¼yor.');
                        resetToLobby();
                    }
                };
                
                if (isHost) {
                    // Host: DataChannel oluÅŸturur
                    dataChannel = peerConnection.createDataChannel('gameChannel');
                    dataChannel.onopen = onDataChannelOpen;
                    dataChannel.onmessage = onDataChannelMessage;
                    dataChannel.onclose = onDataChannelClose;
                    
                    try {
                        // Host: Teklif (Offer) oluÅŸtur
                        const offer = await peerConnection.createOffer();
                        await peerConnection.setLocalDescription(offer);
                        // Teklif kodu onicecandidate'da offerText'e yazÄ±lacak
                    } catch (e) {
                        console.error("Teklif oluÅŸturulamadÄ±:", e);
                        showGlobalMessage('Teklif oluÅŸturulurken bir hata oluÅŸtu.');
                        resetToLobby();
                    }

                } else {
                    // Guest: Uzak peer'dan gelen DataChannel'Ä± dinler
                    peerConnection.ondatachannel = event => {
                        dataChannel = event.channel;
                        dataChannel.onopen = onDataChannelOpen;
                        dataChannel.onmessage = onDataChannelMessage;
                        dataChannel.onclose = onDataChannelClose;
                        console.log('Data Channel ALINDI (Misafir)');
                    };
                    // Misafir teklif kodu yapÄ±ÅŸtÄ±rÄ±lana kadar bekler
                }
            }
            
            // Host, misafirden gelen cevabÄ± uygular
            async function applyAnswer(answerText) {
                if (!peerConnection || !answerText) {
                    showGlobalMessage('GeÃ§ersiz cevap kodu.');
                    return;
                }
                
                try {
                    const remoteDesc = JSON.parse(answerText);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteDesc));
                    hostStatus.textContent = 'Cevap uygulandÄ±. BaÄŸlantÄ± bekleniyor...';
                } catch (e) {
                    console.error("Cevap uygulanamadÄ±:", e);
                    showGlobalMessage('GeÃ§ersiz cevap kodu veya hata oluÅŸtu.');
                }
            }

            // Misafir, hosttan gelen teklifi alÄ±r ve cevap oluÅŸturur
            async function receiveOfferAndCreateAnswer(offerText) {
                if (!peerConnection || !offerText) {
                    showGlobalMessage('GeÃ§ersiz teklif kodu.');
                    return;
                }
                
                try {
                    const remoteDesc = JSON.parse(offerText);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteDesc));

                    // Cevap (Answer) oluÅŸtur
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    // Cevap kodu onicecandidate'da answerTextGuest'e yazÄ±lacak
                    
                    guestStatus.textContent = 'Cevap oluÅŸturuluyor...';
                    
                } catch (e) {
                    console.error("Teklif alÄ±namadÄ± veya cevap oluÅŸturulamadÄ±:", e);
                    showGlobalMessage('GeÃ§ersiz teklif kodu veya hata oluÅŸtu.');
                }
            }

            // --- DataChannel OlaylarÄ± ---

            function onDataChannelOpen() {
                console.log('Data Channel AÃ‡IK! BaÄŸlandÄ±.');
                gameStarted = true;

                // Host, rakibin adÄ±nÄ± gÃ¶nderir
                const myRole = isHost ? 'player1' : 'player2';
                const message = JSON.stringify({
                    type: 'START',
                    role: myRole,
                    username: username,
                    isHost: isHost // Rakibin benim kim olduÄŸumu bilmesi iÃ§in
                });
                dataChannel.send(message);

                // Oyun baÅŸlatma mantÄ±ÄŸÄ±
                startGame(isHost); 
            }

            function onDataChannelMessage(event) {
                // Rakip mesajÄ± iÅŸleme
                try {
                    const msg = JSON.parse(event.data);
                    handleRemoteMessage(msg);
                } catch (e) {
                    console.error('Mesaj iÅŸlenirken hata:', e);
                }
            }

            function onDataChannelClose() {
                console.log('Data Channel KAPALI!');
                if (gameStarted) { 
                    showGlobalMessage('Rakibin baÄŸlantÄ±sÄ± koptu. Lobiye dÃ¶nÃ¼lÃ¼yor.');
                    resetToLobby();
                }
            }

            function handleRemoteMessage(msg) {
                switch (msg.type) {
                    case 'START':
                        // Rakibin adÄ±nÄ± al
                        if (isHost && msg.role === 'player2') {
                            player2Username = msg.username;
                            player2NameEl.textContent = player2Username;
                            showGlobalMessage(`Rakip (${player2Username}) baÄŸlandÄ±! Oyun BaÅŸlÄ±yor.`, false);
                            sendGameConfig(); // Host, oyun konfigÃ¼rasyonunu (kartlarÄ±) gÃ¶nderir.
                            updateTurnIndicator();
                        } else if (!isHost && msg.role === 'player1') {
                            player1Username = msg.username;
                            player1NameEl.textContent = player1Username;
                            updateTurnIndicator();
                        }
                        break;
                    case 'CONFIG':
                        if (!isHost) {
                            // Misafir, hosttan gelen kart konfigÃ¼rasyonunu alÄ±r
                            cards = msg.cards;
                            totalPairs = msg.totalPairs;
                            bombsToPlace = msg.bombsToPlace;
                            createGameGrid();
                            showGlobalMessage('Oyun bilgileri alÄ±ndÄ±. Ä°yi ÅŸanslar!', false);
                            updateTurnIndicator();
                        }
                        break;
                    case 'FLIP':
                        handleRemoteFlip(msg.index);
                        break;
                    case 'TURN_END':
                        myTurn = true;
                        updateTurnIndicator();
                        break;
                    case 'LIFE_UPDATE':
                        lives = msg.lives;
                        updateLivesDisplay();
                        checkForGameEnd();
                        break;
                    case 'REMATCH':
                        // Yeniden eÅŸleÅŸme mantÄ±ÄŸÄ± (basitÃ§e lobiye dÃ¶ndÃ¼r)
                        // GerÃ§ek bir yeniden eÅŸleÅŸme iÃ§in WebRTC baÄŸlantÄ±sÄ±nÄ±n da yeniden kurulmasÄ± gerekir.
                        showGlobalMessage('Rakip yeniden oynamak istiyor. Lobiye dÃ¶nÃ¼lÃ¼yor.');
                        resetToLobby();
                        break;
                    case 'LOBBY':
                        showGlobalMessage('Rakip lobiye dÃ¶ndÃ¼. Lobiye dÃ¶nÃ¼lÃ¼yor.');
                        resetToLobby();
                        break;
                }
            }
            
            // Host, kart dizilimini misafire gÃ¶nderir
            function sendGameConfig() {
                if (dataChannel && dataChannel.readyState === 'open') {
                    const configMsg = JSON.stringify({
                        type: 'CONFIG',
                        cards: cards,
                        totalPairs: totalPairs,
                        bombsToPlace: bombsToPlace
                    });
                    dataChannel.send(configMsg);
                }
            }


            // --- Lobi Ä°ÅŸlemleri ---

            function initCreateRoom() {
                if (!validateUsername()) return;
                
                isHost = true;
                roomCode = generateRoomCode();
                player1Username = username; // Player 1 Host olur
                
                connectTitle.textContent = 'Oda Kuruluyor (Host)';
                hostConnect.classList.remove('hidden');
                guestConnect.classList.add('hidden');
                roomCodeDisplay.textContent = roomCode;
                
                startConnection(true);
                showScreen('connect');
            }

            function initJoinRoom() {
                if (!validateUsername()) return;
                
                isHost = false;
                player2Username = username; // Player 2 Guest olur
                
                connectTitle.textContent = 'Odaya KatÄ±lÄ±nÄ±yor (Guest)';
                hostConnect.classList.add('hidden');
                guestConnect.classList.remove('hidden');
                
                startConnection(false);
                showScreen('connect');
            }
            
            // --- Oyun MantÄ±ÄŸÄ± FonksiyonlarÄ± ---

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function initializeGameVariables() {
                lives = { player1: 2, player2: 2 };
                player1NameEl.textContent = player1Username || 'Oyuncu 1';
                player2NameEl.textContent = player2Username || 'Oyuncu 2';
                updateLivesDisplay();
                flippedCards = [];
                matchCount = 0;
                gameGrid.innerHTML = '';
            }

            function startGame(isHost) {
                initializeGameVariables();
                
                // Host oyun konfigÃ¼rasyonunu hazÄ±rlar ve oyunu baÅŸlatÄ±r
                if (isHost) {
                    player1NameEl.textContent = player1Username; // Host kendisi
                    player2NameEl.textContent = player2Username || 'Rakip Bekleniyor...';
                    
                    let gameEmojis = shuffle([...EMOJIS, ...EMOJIS]);
                    bombsToPlace = 2; // Ã–rnek olarak 2 bomba
                    // BombayÄ± emojiler arasÄ±na yerleÅŸtir
                    for (let i = 0; i < bombsToPlace; i++) {
                        gameEmojis.splice(Math.floor(Math.random() * gameEmojis.length), 0, 'ğŸ’£');
                    }
                    cards = gameEmojis.map((emoji, index) => ({
                        id: index,
                        emoji: emoji,
                        isFlipped: false,
                        isMatched: false,
                        isBomb: emoji === 'ğŸ’£'
                    }));
                    
                    totalPairs = EMOJIS.length;
                    myTurn = true; // Host baÅŸlar
                    createGameGrid();
                    updateTurnIndicator();

                    // Host, rakibin START mesajÄ±nÄ± aldÄ±ktan sonra CONFIG'i gÃ¶nderecek.
                    // Bu mantÄ±k onDataChannelOpen'a ve handleRemoteMessage'a taÅŸÄ±ndÄ±.

                } else {
                    // Misafir, hosttan config mesajÄ± gelene kadar bekler.
                    myTurn = false; 
                    player1NameEl.textContent = player1Username || 'Rakip';
                    player2NameEl.textContent = player2Username; // Guest kendisi
                    updateTurnIndicator();
                }

                showScreen('game');
            }

            function createGameGrid() {
                gameGrid.innerHTML = '';
                gameGrid.style.gridTemplateColumns = `repeat(4, 1fr)`; // Ã–rn: 4x4
                
                cards.forEach(card => {
                    const cardContainer = document.createElement('div');
                    cardContainer.classList.add('card-container');
                    cardContainer.dataset.index = card.id;

                    const cardInner = document.createElement('div');
                    cardInner.classList.add('card-inner');

                    const cardFront = document.createElement('div');
                    cardFront.classList.add('card-front', 'text-5xl');
                    cardFront.textContent = 'â“'; 

                    const cardBack = document.createElement('div');
                    cardBack.classList.add('card-back', 'text-5xl');
                    cardBack.textContent = card.emoji;

                    cardInner.appendChild(cardFront);
                    cardInner.appendChild(cardBack);
                    cardContainer.appendChild(cardInner);
                    gameGrid.appendChild(cardContainer);

                    cardContainer.addEventListener('click', () => handleCardClick(card.id));
                });
            }

            function updateLivesDisplay() {
                player1LivesEl.innerHTML = 'â¤ï¸'.repeat(lives.player1);
                player2LivesEl.innerHTML = 'â¤ï¸'.repeat(lives.player2);
                
                // Canlar azaldÄ±ÄŸÄ±nda titreme efekti ekleme
                if (lives.player1 < 2) { player1LivesEl.classList.add('vibrating'); } else { player1LivesEl.classList.remove('vibrating'); }
                if (lives.player2 < 2) { player2LivesEl.classList.add('vibrating'); } else { player2LivesEl.classList.remove('vibrating'); }
            }

            function updateTurnIndicator() {
                const myName = isHost ? player1Username : player2Username;
                const opponentName = isHost ? player2Username : player1Username;
                
                if (myTurn) {
                    turnIndicator.textContent = `SÄ±ra Sende! (${myName})`;
                    turnIndicator.classList.remove('text-red-400');
                    turnIndicator.classList.add('text-yellow-400');
                } else {
                    turnIndicator.textContent = `Rakip Oynuyor... (${opponentName})`;
                    turnIndicator.classList.remove('text-yellow-400');
                    turnIndicator.classList.add('text-red-400');
                }
            }

            // Kart tÄ±klama olayÄ±
            function handleCardClick(index) {
                if (!myTurn || flippedCards.length >= 2 || cards[index].isFlipped) {
                    return;
                }

                // KartÄ± Ã§evir
                flipCard(index, true); 

                if (flippedCards.length === 2) {
                    myTurn = false; // SÄ±ra bitti
                    updateTurnIndicator();
                    setTimeout(checkForMatch, 1000);
                }
            }

            // KartÄ± Ã§evirme gÃ¶rseli ve durumu gÃ¼ncelleme
            function flipCard(index, sendSignal = false) {
                const card = cards[index];
                if (card.isFlipped) return;

                card.isFlipped = true;
                const cardEl = gameGrid.querySelector(`[data-index="${index}"]`);
                if (cardEl) {
                    cardEl.classList.add('flipped');
                    // TÄ±klamayÄ± engelle (zaten flippedCards kontrolÃ¼ var ama iyi olur)
                    cardEl.style.pointerEvents = 'none'; 
                }
                
                // Bomba mÄ±?
                if (card.isBomb) {
                    if (cardEl) cardEl.classList.add('shake');
                } else {
                    flippedCards.push(index);
                }

                if (sendSignal && dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({ type: 'FLIP', index: index }));
                }
            }

            // Rakip tarafÄ±ndan Ã§evrilen kartÄ± iÅŸleme
            function handleRemoteFlip(index) {
                flipCard(index, false); 
                
                if (flippedCards.length === 2) {
                    // Rakip 2. kartÄ± Ã§evirdi, 1 saniye sonra eÅŸleÅŸme kontrolÃ¼ yap
                    setTimeout(checkForMatch, 1000);
                }
            }

            function checkForMatch() {
                if (flippedCards.length !== 2) {
                    // Bomba bulunduysa veya bir hata olduysa
                    handleEndTurn(false);
                    return;
                }
                
                const [idx1, idx2] = flippedCards;
                const card1 = cards[idx1];
                const card2 = cards[idx2];
                const currentLives = isHost ? lives.player1 : lives.player2;
                
                if (card1.emoji === card2.emoji) {
                    // EÅŸleÅŸme bulundu
                    card1.isMatched = true;
                    card2.isMatched = true;
                    matchCount++;
                    
                    // KartlarÄ± kalÄ±cÄ± olarak aÃ§Ä±k bÄ±rak
                    gameGrid.querySelector(`[data-index="${idx1}"]`).classList.add('shadow-green-500');
                    gameGrid.querySelector(`[data-index="${idx2}"]`).classList.add('shadow-green-500');

                    checkForGameEnd();
                    handleEndTurn(true); // AynÄ± oyuncu devam eder
                } else {
                    // EÅŸleÅŸme yok, kartlarÄ± geri Ã§evir
                    setTimeout(() => {
                        const el1 = gameGrid.querySelector(`[data-index="${idx1}"]`);
                        const el2 = gameGrid.querySelector(`[data-index="${idx2}"]`);
                        
                        el1.classList.remove('flipped');
                        el2.classList.remove('flipped');
                        cards[idx1].isFlipped = false;
                        cards[idx2].isFlipped = false;
                        el1.style.pointerEvents = 'auto'; 
                        el2.style.pointerEvents = 'auto'; 

                        handleEndTurn(false); // SÄ±ra rakibe geÃ§er
                    }, 500); 
                }

                // BombayÄ± temizle (Sadece gÃ¶rselden sarsÄ±ntÄ±yÄ± kaldÄ±r)
                if (cards.some(c => c.isBomb && c.isFlipped)) {
                    cards.filter(c => c.isBomb).forEach(c => {
                        const el = gameGrid.querySelector(`[data-index="${c.id}"]`);
                        if (el) el.classList.remove('shake');
                        // Bomba kartlarÄ±nÄ± kapat ve tÄ±klanabilir yap
                        el.classList.remove('flipped');
                        c.isFlipped = false;
                        el.style.pointerEvents = 'auto';
                    });
                    
                    // Bomba varsa Can KaybÄ±
                    if (currentLives > 0) {
                        if (isHost) {
                            lives.player1--;
                        } else {
                            lives.player2--;
                        }
                        updateLivesDisplay();
                        sendLifeUpdate();
                        checkForGameEnd();
                    }
                    
                    // Bomba bulunduÄŸunda sÄ±ra otomatik deÄŸiÅŸir (maÃ§ bulunsun veya bulunmasÄ±n)
                    handleEndTurn(false);
                    return;
                }
            }
            
            function handleEndTurn(isMatchFound) {
                flippedCards = []; // SÄ±fÄ±rla
                
                if (!isMatchFound) {
                    // SÄ±rayÄ± rakibe geÃ§ir
                    myTurn = false;
                    updateTurnIndicator();
                    sendTurnEndSignal();
                } else {
                    // EÅŸleÅŸme bulundu, aynÄ± oyuncu devam eder
                    myTurn = true;
                    updateTurnIndicator();
                }
            }
            
            // Rakibe sÄ±ra deÄŸiÅŸimini bildir
            function sendTurnEndSignal() {
                if (dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({ type: 'TURN_END' }));
                }
            }

            // Rakibe can bilgisini gÃ¶nder
            function sendLifeUpdate() {
                 if (dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({ type: 'LIFE_UPDATE', lives: lives }));
                }
            }

            function checkForGameEnd() {
                const currentLives = isHost ? lives.player1 : lives.player2;
                const opponentLives = isHost ? lives.player2 : lives.player1;
                
                if (matchCount === totalPairs) {
                    // TÃ¼m Ã§iftler bulundu, daha az canÄ± olan (veya canlar eÅŸitse) kazanÄ±r
                    if (currentLives > opponentLives) {
                        endGame(true, "Tebrikler, tÃ¼m Ã§iftleri buldun ve daha Ã§ok canÄ±n var! ğŸ‰");
                    } else if (opponentLives > currentLives) {
                         endGame(false, `Tebrikler, tÃ¼m Ã§iftleri buldun ama rakibin daha Ã§ok canÄ± var! ğŸ˜­`);
                    } else {
                        endGame(true, "Berabere kaldÄ±nÄ±z! (Canlar EÅŸit) ğŸ¤"); // Ã‡iftler bittiÄŸinde ben kazanÄ±rÄ±m (basitÃ§e)
                    }
                    return;
                }
                
                if (currentLives <= 0) {
                    endGame(false, "CanÄ±n Bitti! Kaybettin. ğŸ˜­");
                    return;
                }
                
                if (opponentLives <= 0) {
                    endGame(true, "Rakibinin CanÄ± Bitti! KazandÄ±n! ğŸ‰");
                    return;
                }
            }
            
            function endGame(isWinner, message) {
                showScreen('end');
                endMessage.innerHTML = message;
                gameStarted = false;
                
                // Oyun bitiÅŸ mesajÄ±nÄ± rakibe de gÃ¶nder (opsiyonel)
                // dataChannel.send(JSON.stringify({ type: 'GAME_END', isWinner: !isWinner })); 
            }


            // --- Olay Dinleyicileri ---
            
            // YÃ¼kleme EkranÄ±ndan Lobiye GeÃ§iÅŸ
            setTimeout(() => {
                showScreen('lobby');
            }, 1000); // 1 saniye sonra lobiye geÃ§

            // Lobi ButonlarÄ±
            createRoomBtn.addEventListener('click', initCreateRoom);
            joinRoomBtn.addEventListener('click', initJoinRoom);
            
            // BaÄŸlantÄ± ButonlarÄ±
            cancelConnectBtn.addEventListener('click', resetToLobby);
            
            // Host SinyalleÅŸme
            copyOfferBtn.addEventListener('click', () => copyToClipboard(offerText.value, copyOfferBtn));
            applyAnswerBtn.addEventListener('click', () => {
                const answer = answerTextHost.value.trim();
                if (answer) {
                    applyAnswer(answer);
                } else {
                    showGlobalMessage('LÃ¼tfen arkadaÅŸÄ±nÄ±n cevap kodunu yapÄ±ÅŸtÄ±rÄ±n.');
                }
            });
            
            // Guest SinyalleÅŸme
            createAnswerBtn.addEventListener('click', () => {
                const offer = offerTextGuest.value.trim();
                if (offer) {
                    receiveOfferAndCreateAnswer(offer);
                } else {
                    showGlobalMessage('LÃ¼tfen Ã¶nce arkadaÅŸÄ±nÄ±n teklif kodunu yapÄ±ÅŸtÄ±r.');
                }
            });
            copyAnswerBtn.addEventListener('click', () => copyToClipboard(answerTextGuest.value, copyAnswerBtn));

            // Oyun Sonu ButonlarÄ±
            playAgainBtn.addEventListener('click', () => {
                // BasitÃ§e lobiye dÃ¶n, tekrar eÅŸleÅŸmek gerekir.
                dataChannel.send(JSON.stringify({ type: 'REMATCH' }));
                resetToLobby();
            });
            backToLobbyBtn.addEventListener('click', () => {
                dataChannel.send(JSON.stringify({ type: 'LOBBY' }));
                resetToLobby();
            });

            // Global Mesaj Kapatma
            globalMessageClose.addEventListener('click', hideGlobalMessage);
        });
    </script>
</body>
</html>
