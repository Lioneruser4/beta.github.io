<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üåê Onlayn Domino - üåê Online Domino</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        bone: {
                            face: '#fdfdfd',
                            side: '#e2e2e2',
                            shadow: '#00000040'
                        }
                    },
                }
            }
        }
    </script>

    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #a855f7;
            --accent-color: #ec4899;
            --glass-bg: rgba(20, 20, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: 
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(168, 85, 247, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 100%, rgba(236, 72, 153, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #0f172a 50%, #1e293b 75%, #0f172a 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 200% 200%;
            background-attachment: fixed;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow: hidden;
            color: var(--text-color);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%, 100% 50%, 50% 100%, 0% 0%; }
            50% { background-position: 100% 50%, 0% 50%, 50% 100%, 100% 100%; }
        }

        .container {
            width: 100%;
            max-width: 550px;
            position: relative;
            z-index: 1;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        .game-board-area {
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 10px;
            margin: 20px 0;
            height: 40vh;
            min-height: 300px;
            position: relative;
        }

        .hand-area {
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 10px;
            min-height: 150px;
            overflow-x: auto;
        }

        .pip-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 100%; height: 100%; padding: 2px; }
        .pip { background-color: #111; border-radius: 50%; width: 5px; height: 5px; margin: auto; box-shadow: inset 0 1px 1px rgba(255,255,255,0.2); }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .valid-zone {
            position: relative;
            animation: pulse-glow 1.5s infinite ease-in-out;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(251, 191, 36, 0.8); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            padding: 20px;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
            color: #ffffff;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root" class="container"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // Telegram WebApp Initialization
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // API Base URL
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:10000' : 'https://beta-github-io.onrender.com';

        // --- Bƒ∞LE≈ûENLER ---
        
        // 1. Domino Noktalarƒ± (Pips)
        const RenderPips = ({ number }) => {
            const layouts = {
                0: [], 1: [4], 2: [0, 8], 3: [0, 4, 8],
                4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 2, 3, 5, 6, 8]
            };
            const activePips = layouts[number] || [];
            return (
                <div className="pip-grid">
                    {[...Array(9)].map((_, i) => (
                        <div key={i} className="pip" style={{ opacity: activePips.includes(i) ? 1 : 0 }}></div>
                    ))}
                </div>
            );
        };

        // 2. Domino Ta≈üƒ± (3D Tasarƒ±m)
        const DominoTile = ({ values, onClick, disabled, isSelected, vertical = true, scale = 1, isGhost = false, animateIn = false }) => {
            const shadowClass = 'shadow-[0_4px_0px_#c7c7c7,0_6px_6px_rgba(0,0,0,0.4)]';
            const activeShadowClass = 'shadow-[0_2px_0px_#c7c7c7,0_3px_3px_rgba(0,0,0,0.4)]';

            const baseClasses = `
                relative flex overflow-hidden bg-bone-face border border-gray-300 rounded-md
                transition-all duration-300 select-none
                ${vertical ? 'flex-col w-9 h-[4.5rem] sm:w-10 sm:h-20' : 'flex-row w-[4.5rem] h-9 sm:w-20 sm:h-10'}
                ${isGhost ? 'opacity-0 pointer-events-none' : shadowClass}
                ${isSelected ? `-translate-y-4 ${activeShadowClass} ring-2 ring-yellow-500 z-10` : ''}
                ${!disabled && !isGhost ? `cursor-pointer active:translate-y-1 ${activeShadowClass} hover:brightness-110` : ''}
                ${disabled ? 'brightness-90 cursor-default' : ''}
            `;

            return (
                <div 
                    onClick={onClick}
                    className={baseClasses}
                    style={{ transform: isSelected ? 'translateY(-15px) scale(1.1)' : `scale(${scale})` }}
                >
                    <div className={`flex-1 flex items-center justify-center ${vertical ? 'border-b' : 'border-r'} border-gray-300`}>
                        <RenderPips number={values[0]} />
                    </div>
                    <div className="flex-1 flex items-center justify-center">
                        <RenderPips number={values[1]} />
                    </div>
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-gray-400 border border-gray-500 shadow-inner z-10"></div>
                </div>
            );
        };

        // 4. Yƒ±lan D√ºzeninde Oyun Tahtasƒ± (YENƒ∞)
        const DominoBoard = ({ board, selectedTileIndex }) => {
            const boardRef = useRef(null);
            const [layout, setLayout] = useState([]);

            useEffect(() => {
                if (!boardRef.current) return;

                const calculateLayout = () => {
                    if (board.length === 0) {
                        setLayout([]);
                        return;
                    }

                    const containerWidth = boardRef.current.offsetWidth;
                    const containerHeight = boardRef.current.offsetHeight;
                    const TILE_WIDTH = 40; // sm:w-10
                    const TILE_HEIGHT = 80; // sm:h-20

                    let x = containerWidth / 2;
                    let y = containerHeight / 2;
                    let direction = 'right'; // 'right', 'down', 'left', 'up'
                    
                    const newLayout = [];
                    let currentSegmentLength = 0;

                    board.forEach((tile, index) => {
                        const isDouble = tile[0] === tile[1];
                        const tileW = isDouble ? TILE_WIDTH : TILE_HEIGHT;
                        const tileH = isDouble ? TILE_HEIGHT : TILE_WIDTH;

                        newLayout.push({ tile, x, y, isDouble, direction });

                        // Bir sonraki pozisyonu hesapla
                        if (direction === 'right') {
                            x += tileW;
                            if (x + TILE_HEIGHT > containerWidth - 20) { // Kenara yakla≈ütƒ±, d√∂n
                                direction = 'down';
                                y += tileH / 2 + TILE_WIDTH / 2;
                            }
                        } else if (direction === 'down') {
                            y += tileW;
                            if (y + TILE_HEIGHT > containerHeight - 20) {
                                direction = 'left';
                                x -= tileH / 2 + TILE_WIDTH / 2;
                            }
                        } else if (direction === 'left') {
                            x -= tileW;
                            if (x - TILE_HEIGHT < 20) {
                                direction = 'up';
                                y -= tileH / 2 + TILE_WIDTH / 2;
                            }
                        } else if (direction === 'up') {
                            y -= tileW;
                            if (y - TILE_HEIGHT < 20) {
                                direction = 'right';
                                x += tileH / 2 + TILE_WIDTH / 2;
                            }
                        }
                    });
                    setLayout(newLayout);
                };

                calculateLayout();
                window.addEventListener('resize', calculateLayout);
                return () => window.removeEventListener('resize', calculateLayout);
            }, [board]);

            const getRotationClass = (dir, isDouble) => {
                if (isDouble) return (dir === 'right' || dir === 'left') ? 'rotate-90' : '';
                return (dir === 'down' || dir === 'up') ? 'rotate-90' : '';
            };

            return (
                <div ref={boardRef} className="w-full h-full relative">
                    {board.length === 0 ? (
                        <div className="absolute inset-0 flex items-center justify-center">
                            <div className="text-white/30 text-xl font-bold border-4 border-dashed border-white/10 rounded-3xl p-6">
                                {selectedTileIndex !== null ? 'üëá Ta≈üƒ± Buraya Koy' : 'Ta≈ü Se√ß ve Ba≈üla'}
                            </div>
                        </div>
                    ) : (
                        layout.map(({ tile, x, y, isDouble, direction }, index) => (
                            <div key={index} className="absolute transition-all duration-500" style={{ left: `${x}px`, top: `${y}px`, transform: 'translate(-50%, -50%)' }}>
                                <div className={getRotationClass(direction, isDouble)}>
                                    <DominoTile values={tile} disabled={true} scale={0.9} />
                                </div>
                            </div>
                        ))
                    )}
                </div>
            );
        };

        // 3. Bildirim Toast
        const Toast = ({ message, type }) => {
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600', warning: 'bg-yellow-600' };
            return ReactDOM.createPortal(
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 px-6 py-2 rounded-full shadow-lg text-white font-medium text-sm animate-slide-up flex items-center gap-2 ${colors[type] || colors.info}`}>
                    <span>{type === 'success' ? '‚úì' : type === 'error' ? '!' : 'i'}</span>
                    {message}
                </div>
            );
        };

        // --- ANA OYUN ---

        const DominoGame = () => {
            const [screen, setScreen] = useState('loading'); // loading, lobby, game, leaderboard
            const [connected, setConnected] = useState(false);
            const [playerData, setPlayerData] = useState(null); // Telegram user data
            const [leaderboard, setLeaderboard] = useState([]);
            const [roomCode, setRoomCode] = useState('');
            const [joinCode, setJoinCode] = useState('');
            const [gameState, setGameState] = useState(null);
            const [searchTime, setSearchTime] = useState(0);
            
            const [selectedTileIndex, setSelectedTileIndex] = useState(null);
            const [validMoves, setValidMoves] = useState([]);
            const [notification, setNotification] = useState(null);
            const [searching, setSearching] = useState(false);
            const [showJoinModal, setShowJoinModal] = useState(false);

            const [opponent, setOpponent] = useState(null);
            
            const myPlayerIdRef = useRef(null); // Sayfa yenilense bile ID'yi tutmak i√ßin
            const wsRef = useRef(null);
            const boardScrollRef = useRef(null);
            const searchTimerRef = useRef(null);

            // Oyun state'ini temizlemek i√ßin merkezi bir fonksiyon
            const resetGameClientState = () => {
                setGameState(null);
                setRoomCode('');
                setSearching(false);
                setSelectedTileIndex(null);
                setValidMoves([]);
                setOpponent(null);
                setJoinCode('');
            };

            useEffect(() => {
                initializeTelegramAuth();
                connectToServer();
                return () => { if (wsRef.current) wsRef.current.close(); };
            }, []);

            // Telegram Auth
            const initializeTelegramAuth = async () => {
                setScreen('loading');
                try {
                    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        // Telegram WebApp - Otomatik giri≈ü
                        const user = tg.initDataUnsafe.user;
                        const telegramData = {
                            telegramId: user.id.toString(),
                            username: user.username || user.first_name || 'User',
                            firstName: user.first_name || '',
                            lastName: user.last_name || '',
                            photoUrl: user.photo_url || null
                        };

                        console.log('üì° Telegram kullanƒ±cƒ±sƒ±:', telegramData);

                        // MongoDB'ye kaydet/g√ºncelle
                        const response = await fetch(`${API_URL}/api/auth/telegram`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(telegramData)
                        });

                        const data = await response.json();
                        if (data.success) {
                            setPlayerData({
                                ...data.player,
                                isGuest: false,
                                photoUrl: telegramData.photoUrl || data.player.photoUrl
                            });
                            console.log('‚úÖ Telegram Auth ba≈üarƒ±lƒ±:', data.player);
                        } else {
                            throw new Error('Auth failed');
                        }
                    } else {
                        // Normal tarayƒ±cƒ± - Guest mode
                        const guestData = { 
                            isGuest: true, 
                            username: 'Guest' + Math.floor(Math.random() * 9999),
                            firstName: '',
                            lastName: '',
                            photoUrl: null,
                            level: 0,
                            elo: 0,
                            telegramId: null
                        };
                        setPlayerData(guestData);
                        console.log('üë• Guest mode:', guestData);
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                    setPlayerData({ 
                        isGuest: true, 
                        username: 'Guest' + Math.floor(Math.random() * 9999), 
                        firstName: '',
                        lastName: '',
                        photoUrl: null,
                        level: 0, 
                        elo: 0,
                        telegramId: null
                    });
                } finally {
                    setTimeout(() => setScreen('lobby'), 500); // Animasyon i√ßin k√º√ß√ºk bir gecikme
                }
            };

            // Leaderboard y√ºkle
            const loadLeaderboard = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/leaderboard`);
                    const data = await response.json();
                    if (data.success) {
                        setLeaderboard(data.leaderboard);
                    }
                } catch (error) {
                    console.error('Leaderboard error:', error);
                }
            };

            const connectToServer = () => {
                let wsUrl = 'wss://beta-github-io.onrender.com';
                // Test i√ßin Localhost kontrol√º
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    wsUrl = `ws://${window.location.hostname}:10000`;
                }

                const ws = new WebSocket(wsUrl);

                ws.onopen = () => { 
                    setConnected(true); 
                    // showNotification('Sunucuya Baƒülandƒ±', 'success'); 
                };
                ws.onclose = () => {
                    setConnected(false); 
                    showNotification('Baƒülantƒ± koptu, yeniden deneniyor...', 'error');
                    
                    // *** YENƒ∞: Baƒülantƒ± koptuƒüunda arama durumunu sƒ±fƒ±rla ***
                    setSearching(false);
                    if (searchTimerRef.current) {
                        clearInterval(searchTimerRef.current);
                        searchTimerRef.current = null;
                    }
                    setSearchTime(0);
                    setTimeout(connectToServer, 3000);
                };
                ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        handleServerMessage(data);
                    } catch(err) { console.error(err); }
                };
                wsRef.current = ws;
            };

            const handleServerMessage = (data) => {
                console.log('üì® Server mesajƒ±:', data.type, data);
                
                switch(data.type) {
                    case 'connected':
                        // Sunucuya baƒülandƒ±k. Eƒüer devam eden bir oyunumuz varsa, yeniden baƒülanma isteƒüi g√∂nderelim.
                        const storedPlayerId = localStorage.getItem('dominoPlayerId');
                        const storedRoomCode = localStorage.getItem('dominoRoomCode');
                        if (storedPlayerId && storedRoomCode) {
                            console.log(`‚ôªÔ∏è Kayƒ±tlƒ± oyun bulundu. Yeniden baƒülanma isteƒüi: ${storedPlayerId}`);
                            sendMessage({
                                type: 'reconnectGame',
                                playerId: storedPlayerId,
                                roomCode: storedRoomCode
                            });
                        }
                        break;
                    case 'roomCreated':
                        setRoomCode(data.roomCode);
                        setScreen('waitingLobby');
                        break;
                    case 'gameStart':
                        console.log('üéÆ Oyun ba≈ülƒ±yor...', data.gameState);
                        setGameState(data.gameState);
                        setScreen('game');
                        localStorage.setItem('dominoPlayerId', data.gameState.playerId);
                        localStorage.setItem('dominoRoomCode', data.roomCode);
                        setSelectedTileIndex(null);
                        setValidMoves([]);
                        setSearching(false);
                        // Timer durdur
                        if (searchTimerRef.current) {
                            clearInterval(searchTimerRef.current);
                            searchTimerRef.current = null;
                        }
                        setSearchTime(0);
                        break;
                    case 'gameUpdate':
                        console.log('üîÑ Oyun g√ºncelleniyor...', data.gameState);
                        if (data.gameState && data.gameState.board) {
                            setGameState(prevState => ({
                                ...prevState,
                                ...data.gameState,
                                playerId: prevState.playerId // playerId'yi koru
                            }));
                            setSelectedTileIndex(null);
                            setValidMoves([]);
                        }
                        break;
                    case 'error':
                        showNotification(data.message, 'error');
                        setSearching(false);
                        if (searchTimerRef.current) {
                            clearInterval(searchTimerRef.current);
                            searchTimerRef.current = null;
                        }
                        setSearchTime(0);
                        break;
                    case 'gameEnd':
                        localStorage.removeItem('dominoPlayerId');
                        localStorage.removeItem('dominoRoomCode');

                        // OYUN SONU BEKLEMESƒ∞Nƒ∞ KALDIR VE ANINDA LOBƒ∞YE D√ñN
                        resetGameClientState(); // T√ºm oyun state'ini temizle
                        setScreen('lobby');
                        break;
                    case 'searchCancelled':
                        showNotification('Arama iptal edildi', 'info');
                        setSearching(false);
                        if (searchTimerRef.current) {
                            clearInterval(searchTimerRef.current);
                            searchTimerRef.current = null;
                        }
                        setSearchTime(0);
                        break;
                    case 'searchStatus':
                        break;
                    case 'matchFound':
                        showNotification(`Rakip Bulundu: ${data.opponent?.name}`, 'success');
                        setSearching(false);
                        setOpponent(data.opponent || null);
                        if (searchTimerRef.current) {
                            clearInterval(searchTimerRef.current);
                            searchTimerRef.current = null;
                        }
                        setSearchTime(0);
                        break;
                    case 'opponentDisconnected':
                        showNotification('Rakibin baƒülantƒ±sƒ± koptu, bekleniyor...', 'warning');
                        break;
                    case 'opponentReconnected':
                        showNotification('Rakip yeniden baƒülandƒ±!', 'success');
                        break;
                    // *** YENƒ∞: Anlƒ±k puan g√ºncellemesi i√ßin ***
                    case 'statsUpdate':
                        console.log('üìä Oyuncu verileri g√ºncellendi:', data.player);
                        setPlayerData(prevData => ({ ...prevData, ...data.player }));
                        break;
                }
            };

            const sendMessage = (msg) => {
                if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                    wsRef.current.send(JSON.stringify(msg));
                }
            };

            const showNotification = (msg, type = 'info') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification(null), 2500);
            };

            // --- OYUN MANTIƒûI ---

            const myPlayerId = gameState?.playerId; // Bu artƒ±k sabit kalmalƒ±
            const isMyTurn = gameState?.currentPlayer === myPlayerId;
            const myHand = gameState?.players?.[myPlayerId]?.hand || [];
            const marketSize = gameState?.market?.length || 0;
            const canDrawFromMarket = marketSize > 0;

            // calculateValidMoves fonksiyonu - EKSƒ∞KTƒ∞!
            const calculateValidMoves = (tile) => {
                if (!gameState || gameState.board.length === 0) return ['start'];
                
                const leftEnd = gameState.board[0][0];
                const rightEnd = gameState.board[gameState.board.length - 1][1];
                const moves = [];
                
                if (tile[0] === leftEnd || tile[1] === leftEnd) moves.push('left');
                if (tile[0] === rightEnd || tile[1] === rightEnd) moves.push('right');
                
                return moves;
            };
            
            // Se√ßim Yapma
            const handleTileClick = (index, tile) => {
                if (!isMyTurn) return;
                
                // Zaten se√ßiliyse se√ßimi kaldƒ±r
                if (selectedTileIndex === index) {
                    setSelectedTileIndex(null);
                    setValidMoves([]);
                    return;
                }

                // Ge√ßerli hamleleri hesapla
                if (gameState.board.length === 0) {
                    // ƒ∞lk hamle her yere yapƒ±labilir
                    setSelectedTileIndex(index);
                    setValidMoves(['start']); 
                } else {
                    const leftEnd = gameState.board[0][0];
                    const rightEnd = gameState.board[gameState.board.length - 1][1];
                    const moves = [];

                    // Basit mantƒ±k: E≈üle≈üiyor mu?
                    if (tile[0] === leftEnd || tile[1] === leftEnd) moves.push('left');
                    if (tile[0] === rightEnd || tile[1] === rightEnd) moves.push('right');

                    if (moves.length > 0) {
                        setSelectedTileIndex(index);
                        setValidMoves(moves);
                    } else {
                        showNotification('Bu ta≈ü uygun deƒüil', 'warning');
                    }
                }
            };

            // Ta≈üƒ± Oynama
            const playTile = (position) => {
                if (selectedTileIndex === null) return;
                
                // Server 'left' veya 'right' bekliyor.
                // Eƒüer tahta bo≈üsa server genelde fark etmez ama 'left' g√∂nderelim.
                const posToSend = position === 'start' ? 'left' : position;

                sendMessage({
                    type: 'playTile',
                    tileIndex: selectedTileIndex,
                    position: posToSend
                });
                
                // Se√ßimi temizle (Optimistik UI)
                setSelectedTileIndex(null);
                setValidMoves([]);
            };

            const passTurn = () => {
                sendMessage({ type: 'pass' });
            };

            const drawFromMarket = () => {
                if (!isMyTurn || !canDrawFromMarket) return;
                // YENƒ∞ KONTROL: Elinde oynanabilir ta≈ü varsa pazardan √ßekmeyi engelle
                const canPlayFromHand = myHand.some(tile => calculateValidMoves(tile).length > 0);
                if (gameState.board.length > 0 && canPlayFromHand) { // Tahta bo≈ü deƒüilken kontrol et
                    showNotification('Elinde oynanabilir ta≈ü varken pazardan √ßekemezsin!', 'warning');
                    return;
                }

                sendMessage({ type: 'drawFromMarket' });
                showNotification('üé≤ Pazardan ta≈ü √ßekiliyor...', 'info');
            };

            const leaveGameClient = () => {
                // Kullanƒ±cƒ±dan onay iste
                const confirmed = window.confirm(
                    'Oyundan √ßƒ±kmak istediƒüine emin misin?\n\n' +
                    'Bu eli terk edersen ELO puanƒ± kaybedebilirsin ve el otomatik olarak rakibine yazƒ±lacaktƒ±r.'
                );
                if (!confirmed) return;

                // Sunucuya haber ver
                sendMessage({ type: 'leaveGame' });

                // Lokal state temizle ve lobiye d√∂n
                resetGameClientState();
                localStorage.removeItem('dominoPlayerId');
                localStorage.removeItem('dominoRoomCode');
                setScreen('lobby');
            };

            // --- EKRAN RENDERLAMA ---

            const renderSearchingModal = () => {
                if (!searching) return null;
                const minutes = Math.floor(searchTime / 60);
                const seconds = searchTime % 60;
                const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                return (
                    <div className="modal active">
                        <div className="modal-content">
                            <h2>üîç Rakip Aranƒ±yor</h2>
                            <div className="searching">
                                <div className="spinner" style={{border: '4px solid rgba(255,255,255,0.1)', borderLeftColor: '#818cf8', borderRadius: '50%', width: '60px', height: '60px', animation: 'spin 1s linear infinite', margin: '20px auto'}}></div>
                                <p style={{fontSize: '1.1em', color: '#a5b4fc'}}>Uygun rakip bulunuyor...</p>
                                <p id="searchTimer" style={{fontSize: '2em', fontWeight: '800', color: 'white', marginTop: '15px', fontVariantNumeric: 'tabular-nums'}}>{timeString}</p>
                            </div>
                            <button className="modal-btn cancel-btn" onClick={() => {
                                setSearching(false);
                                if (searchTimerRef.current) {
                                    clearInterval(searchTimerRef.current);
                                    searchTimerRef.current = null;
                                }
                                setSearchTime(0);
                                sendMessage({ type: 'cancelSearch' });
                            }} style={{marginTop: '20px'}}>Vazge√ß</button>
                        </div>
                    </div>
                );
            };

            // --- LOBBY EKRANI ---
            if (screen === 'loading') {
                return (
                    <div className="glass-panel" style={{padding: '30px 20px', textAlign: 'center'}}>
                        <div style={{margin: '0 auto 20px', border: '3px solid rgba(255,255,255,0.1)', borderTopColor: '#818cf8', borderRadius: '50%', width: '40px', height: '40px', animation: 'spin 1s infinite'}}></div>
                        <p>Y√ºkleniyor...</p>
                    </div>
                );
            }

            if (screen === 'lobby') {
                return (
                    <div id="lobby" className="glass-panel screen active" style={{padding: '30px 20px', animation: 'fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)'}}>
                        {notification && <Toast message={notification.message} type={notification.type} />}
                        {renderSearchingModal()}

                        <div className="header" style={{textAlign: 'center', marginBottom: '30px'}}>
                            <div className="logo" style={{fontSize: '4.5em', display: 'inline-block', filter: 'drop-shadow(0 0 15px rgba(255,255,255,0.2))', animation: 'float 3s ease-in-out infinite'}}>üé≤</div>
                            <h1 style={{fontSize: '2.2em', background: 'linear-gradient(to right, #fff, #94a3b8)', WebkitBackgroundClip: 'text', backgroundClip: 'text', WebkitTextFillColor: 'transparent', fontWeight: '800', marginBottom: '5px', letterSpacing: '-1px'}}>
                                Online Domino
                            </h1>
                            <p className="subtitle" style={{color: '#94a3b8', fontSize: '0.9em', fontWeight: '400', letterSpacing: '0.5px'}}>Next-Gen Multiplayer</p>
                        </div>

                        <div className="connection-status" style={{textAlign: 'center', padding: '10px', marginBottom: '25px', borderRadius: '12px', fontWeight: '600', fontSize: '0.85em', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', backdropFilter: 'blur(5px)'}}>
                            {connected ? (
                                <div className="connected" style={{background: 'rgba(34, 197, 94, 0.15)', color: '#4ade80', border: '1px solid rgba(34, 197, 94, 0.3)', padding: 'inherit', borderRadius: 'inherit', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <div className="status-dot" style={{width: '8px', height: '8px', background: '#4ade80', borderRadius: '50%', boxShadow: '0 0 10px #4ade80'}}></div>
                                    <span>Baƒülƒ±</span>
                                </div>
                            ) : (
                                <div className="disconnected" style={{background: 'rgba(239, 68, 68, 0.15)', color: '#f87171', border: '1px solid rgba(239, 68, 68, 0.3)', padding: 'inherit', borderRadius: 'inherit', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <div className="status-spinner" style={{width: '14px', height: '14px', border: '2px solid rgba(255,255,255,0.3)', borderTopColor: '#fff', borderRadius: '50%', animation: 'spin 1s linear infinite'}}></div>
                                    <span>Baƒülanƒ±yor...</span>
                                </div>
                            )}
                        </div>

                        <div className="button-container" style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                            <button className="game-button ranked-btn" style={{padding: '18px 25px', fontSize: '1.1em', fontWeight: '700', border: 'none', borderRadius: '18px', cursor: 'pointer', transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)', position: 'relative', overflow: 'hidden', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', textTransform: 'uppercase', letterSpacing: '0.5px', color: 'white', boxShadow: '0 4px 15px rgba(239, 68, 68, 0.4)', background: 'linear-gradient(135deg, #ef4444 0%, #b91c1c 100%)'}}
                                onClick={() => {
                                    if(!playerData || playerData.isGuest) return showNotification('Dereceli ma√ß i√ßin Telegram ile giri≈ü yapmalƒ±sƒ±nƒ±z.', 'error');
                                    if(searching) return;
                                    setSearching(true);
                                    setSearchTime(0);
                                    searchTimerRef.current = setInterval(() => setSearchTime(prev => prev + 1), 1000);
                                    sendMessage({ type: 'findMatch', ...playerData, playerName: playerData.username });
                                }}
                                disabled={!connected || searching || playerData?.isGuest}
                            >
                                <span>üèÜ</span>
                                <span>Dereceli Ma√ß</span>
                            </button>
                            <button className="game-button friend-btn" style={{padding: '18px 25px', fontSize: '1.1em', fontWeight: '700', border: 'none', borderRadius: '18px', cursor: 'pointer', transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)', position: 'relative', overflow: 'hidden', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', textTransform: 'uppercase', letterSpacing: '0.5px', color: 'white', boxShadow: '0 4px 15px rgba(14, 165, 233, 0.4)', background: 'linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%)'}}
                                onClick={() => {
                                    if(!playerData) return;
                                    sendMessage({ type: 'createRoom', ...playerData, playerName: playerData.username });
                                }}
                                disabled={!connected}
                            >
                                <span>üë•</span>
                                <span>Dostunla Oyna</span>
                            </button>
                            <button className="game-button join-btn" style={{padding: '18px 25px', fontSize: '1.1em', fontWeight: '700', border: 'none', borderRadius: '18px', cursor: 'pointer', transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)', position: 'relative', overflow: 'hidden', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', textTransform: 'uppercase', letterSpacing: '0.5px', color: 'white', boxShadow: '0 4px 15px rgba(16, 185, 129, 0.4)', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}
                                onClick={() => setShowJoinModal(true)}
                                disabled={!connected}
                            >
                                <span>üöÄ</span>
                                <span>Odaya Katƒ±l</span>
                            </button>
                            <button className="game-button leaderboard-btn" style={{padding: '18px 25px', fontSize: '1.1em', fontWeight: '700', border: 'none', borderRadius: '18px', cursor: 'pointer', transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)', position: 'relative', overflow: 'hidden', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', textTransform: 'uppercase', letterSpacing: '0.5px', color: 'white', boxShadow: '0 4px 15px rgba(139, 92, 246, 0.4)', background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'}}
                                onClick={() => { setScreen('leaderboard'); loadLeaderboard(); }}
                            >
                                <span>üìä</span>
                                <span>Liderlik Tablosu</span>
                            </button>
                        </div>
                    </div>
                );
            }

            // --- LEADERBOARD EKRANI (YENƒ∞) ---
            if (screen === 'leaderboard') {
                return (
                    <div id="leaderboard" className="glass-panel screen active" style={{padding: '30px 20px', animation: 'fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)'}}>
                        {notification && <Toast message={notification.message} type={notification.type} />}
                        
                        <div className="leaderboard-header" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                            <h2 className="leaderboard-title" style={{fontSize: '1.8em', fontWeight: '800', background: 'linear-gradient(to right, #fbbf24, #f59e0b)', WebkitBackgroundClip: 'text', backgroundClip: 'text', WebkitTextFillColor: 'transparent'}}>üèÜ Liderlik Tablosu</h2>
                            <button className="modal-btn cancel-btn" onClick={() => setScreen('lobby')} style={{padding: '8px 15px', flex: '0', border: 'none', borderRadius: '14px', cursor: 'pointer', fontSize: '1em', fontWeight: '600', transition: '0.2s', background: '#334155', color: '#cbd5e1'}}>Geri</button>
                        </div>

                        <div className="leaderboard-content" style={{maxHeight: '400px', overflowY: 'auto'}}>
                            {leaderboard.length === 0 ? (
                                <div className="text-center text-gray-400 py-8">
                                    <p className="text-xl">üìä Skor tablosu y√ºkleniyor...</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {leaderboard.map((player, index) => (
                                        <div key={player._id} className={`flex items-center gap-4 p-4 rounded-xl ${
                                            index === 0 ? 'bg-gradient-to-r from-yellow-500/20 to-amber-500/20 border-2 border-yellow-500' :
                                            index === 1 ? 'bg-gradient-to-r from-gray-400/20 to-gray-500/20 border-2 border-gray-400' :
                                            index === 2 ? 'bg-gradient-to-r from-orange-600/20 to-orange-700/20 border-2 border-orange-600' :
                                            'bg-white/5 border border-white/10'
                                        }`}>
                                            <div className="text-3xl font-black text-white w-10 text-center">
                                                {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`}
                                            </div>
                                            
                                            {player.photoUrl && (
                                                <img src={player.photoUrl} alt={player.username} className="w-12 h-12 rounded-full border-2 border-white/30" />
                                            )}
                                            
                                            <div className="flex-1">
                                                <div className="text-white font-bold text-lg">{player.username || player.firstName}</div>
                                                <div className="flex gap-2 text-sm">
                                                    <span className="text-green-400">‚úì {player.wins}</span>
                                                    <span className="text-red-400">‚úó {player.losses}</span>
                                                    <span className="text-yellow-400">üî• {player.winStreak}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="text-right">
                                                <div className="bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-3 py-1 rounded-full text-sm font-bold mb-1">
                                                    {player.elo} ELO
                                                </div>
                                                <div className="bg-gradient-to-r from-yellow-500 to-amber-600 text-black px-3 py-1 rounded-full text-xs font-bold">
                                                    LVL {Math.min(player.level || 0, 10)}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // --- OYUN EKRANI ---
            if (screen === 'game' && gameState) {
                // Tahtada g√∂rsel olarak ta≈ülarƒ± d√∂nd√ºrmek gerekir mi?
                // Sunucu genellikle [[1,6], [6,2]] diye sƒ±ralƒ± atar.
                // Biz sadece √ßiziyoruz.
                
                // Elimizdeki ta≈ü sayƒ±sƒ± 7'den fazla mƒ±?
                const isHandCrowded = myHand.length > 7;

                return (
                    <div className="fixed inset-0 flex flex-col h-full w-full">
                         {notification && <Toast message={notification.message} type={notification.type} />}
                        
                        {/* √úST PANEL: Rakip */}
                        <div className="h-16 bg-gradient-to-b from-black/60 to-transparent flex items-center justify-between px-4 z-20">
                            <div className="flex items-center gap-3">
                                {opponent?.photoUrl ? (
                                    <img
                                        src={opponent.photoUrl}
                                        alt={opponent.name || opponent.username || 'Rakip'}
                                        className="w-10 h-10 rounded-full border-2 border-yellow-400 shadow-lg object-cover"
                                    />
                                ) : (
                                    <div className="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center shadow-lg">
                                        üë§
                                    </div>
                                )}
                                <div>
                                    <div className="text-white text-sm font-bold shadow-black drop-shadow-md">
                                        {opponent?.name || opponent?.username || 'Rakip'}
                                    </div>
                                    <div className="text-xs text-gray-300 bg-black/40 px-2 py-0.5 rounded-full inline-block">
                                        üé≤ {(() => {
                                            const oppName = opponent?.name || opponent?.username;
                                            const oppEntry = Object.values(gameState.players).find(p => p.name === oppName);
                                            return (oppEntry && oppEntry.hand ? oppEntry.hand.length : 0);
                                        })()} Ta≈ü
                                    </div>
                                </div>
                            </div>
                            <div className="text-center">
                                {isMyTurn ? (
                                    <div className="bg-yellow-500 text-black text-xs font-bold px-4 py-1 rounded-full animate-pulse shadow-glow">‚ö° SENƒ∞N SIRAN ‚ö°</div>
                                ) : (
                                    <div className="text-gray-400 text-xs font-medium bg-black/40 px-3 py-1 rounded-full">‚è≥ Rakip Oynuyor...</div>
                                )}
                            </div>
                        </div>

                        {/* ORTA PANEL: Masa ve Board */}
                        <div className="flex-1 relative overflow-hidden flex items-center justify-center w-full">
                            <div className="absolute inset-0 flex items-center justify-center">
                                {/* YENƒ∞ YILAN D√úZENƒ∞ TAHTASI */}
                                <DominoBoard board={gameState.board} />
                            </div>

                            {/* Oynama B√∂lgeleri (Eski Sistem) */}
                            {validMoves.includes('left') && selectedTileIndex !== null && gameState.board.length > 0 && (
                                <div onClick={() => playTile('left')} className="absolute left-4 top-1/2 -translate-y-1/2 w-16 h-32 rounded-2xl cursor-pointer flex items-center justify-center valid-zone">
                                    <div className="w-12 h-24 bg-yellow-400/10 rounded-lg border-2 border-dashed border-yellow-400"></div>
                                </div>
                            )}
                            {validMoves.includes('right') && selectedTileIndex !== null && gameState.board.length > 0 && (
                                <div onClick={() => playTile('right')} className="absolute right-4 top-1/2 -translate-y-1/2 w-16 h-32 rounded-2xl cursor-pointer flex items-center justify-center valid-zone">
                                    <div className="w-12 h-24 bg-yellow-400/10 rounded-lg border-2 border-dashed border-yellow-400"></div>
                                </div>
                            </div>

                                    {/* ƒ∞LK HAMLE (ORTAYA) */}
                                    {validMoves.includes('start') && selectedTileIndex !== null && (
                                        <div className="absolute inset-0 flex items-center justify-center bg-black/70 z-30 animate-slide-up" onClick={() => playTile('start')}>
                                            <div className="bg-gradient-to-r from-yellow-400 to-amber-500 text-black font-bold px-8 py-4 rounded-2xl animate-glow-pulse cursor-pointer shadow-glow transform scale-110">
                                                ‚ú® OYUNA BA≈ûLA
                                            </div>
                                        </div>
                                    )}
                        </div>

                        {/* ALT PANEL: Oyuncu Eli */}
                        <div className="bg-gradient-to-t from-black/90 via-table-dark to-transparent pb-6 pt-2 px-2 z-20">
                            
                            {/* Kontrol Butonlarƒ± */}
                            <div className="flex justify-between items-center px-4 mb-2">
                                <div className="flex items-center gap-3">
                                    <span className="text-white text-xs font-bold tracking-widest opacity-70">
                                        üé¥ ELƒ∞Nƒ∞Z ({myHand.length})
                                    </span>
                                    <span className="text-yellow-400 text-xs font-bold bg-black/40 px-2 py-1 rounded-full">
                                        üé≤ PAZAR: {marketSize}
                                    </span>
                                </div>
                                <div className="flex gap-2 items-center">
                                    {isMyTurn && canDrawFromMarket && (
                                        <button 
                                            onClick={drawFromMarket}
                                            className="bg-blue-500/80 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-lg transition-all"
                                        >
                                            üé≤ √áEK
                                        </button>
                                    )}
                                    <button
                                        onClick={leaveGameClient}
                                        className="bg-red-600/80 hover:bg-red-600 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-lg transition-all"
                                    >
                                        üè≥Ô∏è √áƒ±k
                                    </button>
                                </div>
                            </div>

                            {/* Ta≈ü Dizilimi */}
                            <div className="w-full mx-auto overflow-x-auto p-2 hide-scrollbar">
                                <div className="flex justify-center gap-2 flex-wrap">
                                    {myHand.map((tile, index) => {
                                        const canPlay = isMyTurn && (gameState.board.length === 0 || calculateValidMoves(tile).length > 0);
                                        
                                        return (
                                            <DominoTile 
                                                key={index}
                                                values={tile}
                                                onClick={() => handleTileClick(index, tile)}
                                                disabled={!isMyTurn}
                                                isSelected={selectedTileIndex === index}
                                                vertical={true} 
                                            />
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showJoinModal) {
                return (
                    <div className="modal active">
                        <div className="modal-content">
                            <h2>üöÄ Odaya Katƒ±l</h2>
                            <p style={{color: '#94a3b8', marginBottom: '10px'}}>Oda kodunu giriniz:</p>
                            <div className="input-group" style={{marginBottom: '20px'}}>
                                <input type="text" value={joinCode} onChange={e => setJoinCode(e.target.value.toUpperCase())} placeholder="KOD" maxLength="4" style={{width: '100%', padding: '16px', fontSize: '1.5em', border: '2px solid #334155', background: '#0f172a', borderRadius: '16px', textAlign: 'center', letterSpacing: '5px', color: 'white', transition: '0.3s', outline: 'none'}} />
                            </div>
                            <div className="modal-buttons" style={{display: 'flex', gap: '12px'}}>
                                <button className="modal-btn primary-btn" onClick={() => { sendMessage({ type: 'joinRoom', roomCode: joinCode, ...playerData, playerName: playerData.username }); setShowJoinModal(false); }} style={{flex: '1', padding: '14px', border: 'none', borderRadius: '14px', cursor: 'pointer', fontSize: '1em', fontWeight: '600', transition: '0.2s', background: '#6366f1', color: 'white'}}>KATIL</button>
                                <button className="modal-btn cancel-btn" onClick={() => setShowJoinModal(false)} style={{flex: '1', padding: '14px', border: 'none', borderRadius: '14px', cursor: 'pointer', fontSize: '1em', fontWeight: '600', transition: '0.2s', background: '#334155', color: '#cbd5e1'}}>ƒ∞PTAL</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DominoGame />);
    </script>
</body>
</html>
