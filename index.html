<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>💣 Emoji Bomb 1v1</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
body { font-family:'Inter',sans-serif; background:linear-gradient(to bottom right,#1a1a1a,#333); color:#f0f0f0; overflow:hidden; }
.screen { width:100vw; height:100vh; display:none; flex-direction:column; align-items:center; justify-content:center; padding:1.5rem; text-align:center; }
.screen.active { display:flex; }
.btn { @apply w-full max-w-xs text-xl font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 ease-in-out; }
.btn-primary { @apply bg-blue-600 text-white hover:bg-blue-500 active:scale-95; }
.btn-secondary { @apply bg-green-600 text-white hover:bg-green-500 active:scale-95; }
.btn-danger { @apply bg-red-600 text-white hover:bg-red-500 active:scale-95; }
.input-field { @apply w-full max-w-xs text-lg bg-gray-700 text-white border-2 border-gray-600 rounded-lg p-4 text-center placeholder-gray-400 focus:outline-none focus:border-blue-500; }
.signal-textarea { @apply w-full max-w-md h-24 text-xs bg-gray-800 text-gray-300 rounded-lg p-2 border border-gray-600 resize-none; }
</style>
</head>
<body>

<!-- Global Mesaj -->
<div id="globalMessage" class="hidden fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg z-50">
    <p id="globalMessageText"></p>
    <button id="globalMessageClose" class="absolute top-2 right-3 text-2xl font-bold">&times;</button>
</div>

<!-- 1. Yükleniyor -->
<div id="loader" class="screen active">
    <div class="text-center text-7xl">💣</div>
    <h1 class="text-4xl font-black mt-4">Emoji Bomb</h1>
</div>

<!-- 2. Lobi -->
<div id="lobby" class="screen">
    <div class="w-full max-w-md space-y-4">
        <h1 class="text-5xl font-black text-center">💣 Emoji Bomb</h1>
        <input type="text" id="username" class="input-field" placeholder="Kullanıcı Adı">
        <button id="createRoomBtn" class="btn btn-primary">🎮 Oda Kur</button>
        <button id="joinRoomBtn" class="btn btn-secondary">🔍 Katıl</button>
    </div>
</div>

<!-- 3. Bağlantı -->
<div id="connectScreen" class="screen">
    <div class="w-full max-w-lg space-y-3">
        <h2 id="connectTitle" class="text-2xl font-bold">Bağlantı Kuruluyor...</h2>
        <div id="hostConnect" class="space-y-3 hidden">
            <p>Oda Kodu: <strong id="roomCodeDisplay" class="text-yellow-400 tracking-widest text-2xl"></strong></p>
            <label>1. Bu Teklif Kodunu arkadaşına gönder:</label>
            <textarea id="offerText" class="signal-textarea" readonly></textarea>
            <button id="copyOfferBtn" class="btn btn-primary py-2 text-sm">Kopyala</button>
            <label>2. Arkadaşından gelen Cevap Kodunu buraya yapıştır:</label>
            <textarea id="answerTextHost" class="signal-textarea" placeholder="Cevap kodu bekleniyor..."></textarea>
            <p id="hostStatus" class="text-green-400">Bağlantı bekleniyor...</p>
        </div>
        <div id="guestConnect" class="space-y-3 hidden">
            <label>1. Arkadaşının Teklif Kodunu buraya yapıştır:</label>
            <textarea id="offerTextGuest" class="signal-textarea" placeholder="Teklif kodunu yapıştır..."></textarea>
            <button id="createAnswerBtn" class="btn btn-secondary">Cevap Oluştur</button>
            <label>2. Cevabı kopyalayıp arkadaşına gönder:</label>
            <textarea id="answerTextGuest" class="signal-textarea" readonly></textarea>
            <button id="copyAnswerBtn" class="btn btn-primary py-2 text-sm hidden">Kopyala</button>
            <p id="guestStatus" class="text-green-400">Bağlantı bekleniyor...</p>
        </div>
        <button id="cancelConnectBtn" class="btn btn-danger py-2">İptal Et</button>
    </div>
</div>

<!-- 4. Oyun -->
<div id="gameScreen" class="screen">
    <div class="w-full max-w-3xl absolute top-0 left-1/2 -translate-x-1/2 p-4 flex justify-between">
        <div id="player1Info">Oyuncu 1<br><span id="player1Lives">❤️❤️</span></div>
        <div id="player2Info">Oyuncu 2<br><span id="player2Lives">❤️❤️</span></div>
    </div>
    <div id="gameGrid" class="w-full max-w-3xl grid gap-2 p-4 mt-32 grid-cols-4"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const screens = {
        loader: document.getElementById('loader'),
        lobby: document.getElementById('lobby'),
        connect: document.getElementById('connectScreen'),
        game: document.getElementById('gameScreen')
    };
    const globalMessage = document.getElementById('globalMessage');
    const globalMessageText = document.getElementById('globalMessageText');
    const globalMessageClose = document.getElementById('globalMessageClose');

    const usernameInput = document.getElementById('username');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');

    const hostConnect = document.getElementById('hostConnect');
    const guestConnect = document.getElementById('guestConnect');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const offerText = document.getElementById('offerText');
    const answerTextHost = document.getElementById('answerTextHost');
    const hostStatus = document.getElementById('hostStatus');
    const offerTextGuest = document.getElementById('offerTextGuest');
    const answerTextGuest = document.getElementById('answerTextGuest');
    const guestStatus = document.getElementById('guestStatus');
    const createAnswerBtn = document.getElementById('createAnswerBtn');
    const copyOfferBtn = document.getElementById('copyOfferBtn');
    const copyAnswerBtn = document.getElementById('copyAnswerBtn');
    const cancelConnectBtn = document.getElementById('cancelConnectBtn');

    let username = '';
    let peerConnection;
    let dataChannel;
    const config = { iceServers:[{urls:'stun:stun.l.google.com:19302'}] };

    function showGlobalMessage(msg,isError=true){
        globalMessageText.textContent=msg;
        globalMessage.className=isError?'fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg z-50':'fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md p-4 bg-green-600 text-white rounded-lg shadow-lg z-50';
        globalMessage.classList.remove('hidden');
        setTimeout(()=>globalMessage.classList.add('hidden'),3000);
    }
    globalMessageClose.addEventListener('click',()=>globalMessage.classList.add('hidden'));
    function showScreen(id){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[id].classList.add('active'); }

    function validateUsername(){
        username=usernameInput.value.trim();
        if(username.length<2){ showGlobalMessage('En az 2 karakter girin.'); return false; }
        return true;
    }

    function generateRoomCode(){ return Math.floor(10000+Math.random()*90000).toString(); }

    function initCreateRoom(){
        if(!validateUsername()) return;
        showScreen('connect');
        hostConnect.classList.remove('hidden');
        guestConnect.classList.add('hidden');
        const roomCode=generateRoomCode();
        roomCodeDisplay.textContent=roomCode;
        peerConnection=new RTCPeerConnection(config);
        dataChannel=peerConnection.createDataChannel('gameChannel');
        dataChannel.onopen=()=>{ showScreen('game'); console.log('DataChannel açık'); };
        dataChannel.onmessage=(e)=>{ console.log('Mesaj geldi:',e.data); };
        peerConnection.onicecandidate=e=>{ if(!e.candidate){ offerText.value=JSON.stringify(peerConnection.localDescription); hostStatus.textContent='Teklifi gönder.'; } };
        peerConnection.createOffer().then(o=>peerConnection.setLocalDescription(o));
    }

    function initJoinRoom(){
        if(!validateUsername()) return;
        showScreen('connect');
        hostConnect.classList.add('hidden');
        guestConnect.classList.remove('hidden');
    }

    createAnswerBtn.addEventListener('click',()=>{
        const offerCode=offerTextGuest.value.trim();
        if(!offerCode){ showGlobalMessage('Teklif kodu gir.'); return; }
        peerConnection=new RTCPeerConnection(config);
        peerConnection.ondatachannel=e=>{ dataChannel=e.channel; dataChannel.onopen=()=>{ showScreen('game'); console.log('DataChannel açık'); }; dataChannel.onmessage=e=>console.log('Mesaj:',e.data); };
        peerConnection.onicecandidate=e=>{ if(!e.candidate){ answerTextGuest.value=JSON.stringify(peerConnection.localDescription); copyAnswerBtn.classList.remove('hidden'); guestStatus.textContent='Cevabı gönder.'; } };
        const offer=JSON.parse(offerCode);
        peerConnection.setRemoteDescription(offer).then(()=>peerConnection.createAnswer().then(a=>peerConnection.setLocalDescription(a)));
    });

    copyOfferBtn.addEventListener('click',()=>navigator.clipboard.writeText(offerText.value));
    copyAnswerBtn.addEventListener('click',()=>navigator.clipboard.writeText(answerTextGuest.value));
    cancelConnectBtn.addEventListener('click',()=>showScreen('lobby'));

});
</script>

</body>
</html>
