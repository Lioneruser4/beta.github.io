<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1b4d3e">
    <title>Domino 101 Pro - Ranked & Casual</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background: #0f2b23 url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23153d31' fill-opacity='0.4'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            user-select: none;
        }
        .bone { background: #fdfdfd; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 0 #c7c7c7, 0 8px 16px rgba(0,0,0,0.5); }
        .pip { background: #000; border-radius: 50%; box-shadow: inset 0 2px 4px rgba(255,255,255,0.3); }
        .double { border: 3px solid #fbbf24; }
        .valid-zone { background: rgba(251, 191, 36, 0.2); border: 3px dashed #fbbf24; border-radius: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:10000' : 'https://beta-github-io.onrender.com';

        const RenderPips = ({ number }) => {
            const layouts = {0:[],1:[4],2:[0,8],3:[0,4,8],4:[0,2,6,8],5:[0,2,4,6,8],6:[0,2,3,5,6,8]};
            const pips = layouts[number] || [];
            return (
                <div className="grid grid-cols-3 gap-1 w-full h-full p-2">
                    {[...Array(9)].map((_, i) => (
                        <div key={i} className={`pip w-3 h-3 ${pips.includes(i) ? 'opacity-100' : 'opacity-0'}`} />
                    ))}
                </div>
            );
        };

        const DominoTile = ({ tile, onClick, selected, disabled, vertical = true }) => {
            const isDouble = tile[0] === tile[1];
            return (
                <div onClick={disabled ? null : onClick}
                     className={`bone relative cursor-pointer transition-all ${selected ? 'ring-4 ring-yellow-400 -translate-y-6 shadow-2xl' : ''} ${disabled ? 'opacity-70' : 'hover:brightness-110 active:translate-y-1'}`}
                     style={{ width: vertical ? '64px' : '128px', height: vertical ? '128px' : '64px' }}>
                    <div className={`flex ${vertical ? 'flex-col' : 'flex-row'} h-full`}>
                        <div className={`flex-1 flex items-center justify-center ${vertical ? 'border-b-2' : 'border-r-2'} border-gray-400`}>
                            <RenderPips number={tile[0]} />
                        </div>
                        <div className="flex-1 flex items-center justify-center">
                            <RenderPips number={tile[1]} />
                        </div>
                    </div>
                    {isDouble && <div className="absolute inset-0 double pointer-events-none"></div>}
                </div>
            );
        };

        const App = () => {
            const [screen, setScreen] = useState('loading');
            const [player, setPlayer] = useState(null);
            const [game, setGame] = useState(null);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [validMoves, setValidMoves] = useState([]);
            const [notification, setNotification] = useState(null);
            const ws = useRef(null);

            useEffect(() => {
                init();
                return () => ws.current?.close();
            }, []);

            const init = async () => {
                let user = { isGuest: true, username: 'Qonaq' + Math.floor(Math.random()*9999), elo: 0, level: 0 };
                if (tg?.initDataUnsafe?.user) {
                    const u = tg.initDataUnsafe.user;
                    try {
                        const res = await fetch(`${API_URL}/api/auth/telegram`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                telegramId: u.id.toString(),
                                username: u.username || u.first_name || 'User',
                                firstName: u.first_name || '',
                                lastName: u.last_name || '',
                                photoUrl: u.photo_url || ''
                            })
                        });
                        const data = await res.json();
                        if (data.success) user = { ...data.player, isGuest: false };
                    } catch (e) { console.error(e); }
                }
                setPlayer(user);
                connectWebSocket(user);
                setScreen('lobby');
            };

            const connectWebSocket = (p) => {
                const protocol = location.hostname === 'localhost' ? 'ws' : 'wss';
                const url = `${protocol}://${location.hostname === 'localhost' ? 'localhost:10000' : 'beta-github-io.onrender.com'}`;
                ws.current = new WebSocket(url);

                ws.current.onopen = () => console.log('WS Bağlandı');
                ws.current.onmessage = (e) => {
                    const msg = JSON.parse(e.data);
                    console.log('Gələn:', msg.type, msg);

                    if (msg.type === 'gameStart') { setGame(msg.gameState); setScreen('game'); setSelectedIdx(null); }
                    if (msg.type === 'gameUpdate') { setGame(prev => ({...prev, ...msg.gameState})); setSelectedIdx(null); setValidMoves([]); }
                    if (msg.type === 'gameEnd') { showNotif(msg.winnerName + ' Qazandı!', 'success'); setTimeout(() => setScreen('lobby'), 4000); }
                    if (msg.type === 'opponentLeft') { showNotif('Rəqib çıxdı! Sən qazandın (+15 ELO)', 'success'); setTimeout(() => setScreen('lobby'), 4000); }
                    if (msg.type === 'error') showNotif(msg.message, 'error');
                };
                ws.current.onclose = () => setTimeout(() => connectWebSocket(p), 3000);
            };

            const send = (obj) => ws.current?.readyState === WebSocket.OPEN && ws.current.send(JSON.stringify(obj));
            const showNotif = (text, type = 'info') => { setNotification({text, type}); setTimeout(() => setNotification(null), 3000); };

            const handleTileClick = (idx) => {
                if (!game || game.currentPlayer !== game.playerId) return;
                if (selectedIdx === idx) { setSelectedIdx(null); setValidMoves([]); return; }

                const tile = game.players[game.playerId].hand[idx];
                const board = game.board || [];
                const left = board.length ? board[0][0] : null;
                const right = board.length ? board[board.length-1][1] : null;

                const moves = [];
                if (!board.length || tile[0] === left || tile[1] === left) moves.push('left');
                if (!board.length || tile[0] === right || tile[1] === right) moves.push('right');

                setSelectedIdx(moves.length > 0 ? idx : null);
                setValidMoves(moves);
            };

            const playTile = (pos) => {
                if (selectedIdx === null) return;
                send({ type: 'playTile', tileIndex: selectedIdx, position: pos });
                setSelectedIdx(null); setValidMoves([]);
            };

            if (screen === 'lobby') return (
                <div className="min-h-screen flex flex-col items-center justify-center text-white p-6">
                    <h1 className="text-6xl font-bold mb-8">Domino 101</h1>
                    <div className="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-sm w-full text-center">
                        <h2 className="text-2xl mb-4">Salam, {player.username}!</h2>
                        {!player.isGuest && <p className="mb-6 text-xl">Səviyyə {player.level} • {player.elo} ELO</p>}
                        <button onClick={() => { send({type: 'findMatch', ...player}); setScreen('searching'); }}
                                className="w-full bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-400 hover:to-amber-500 text-black font-bold text-xl py-5 rounded-2xl shadow-2xl">
                            Dərəcəli Maç Ara / Ranked Match
                        </button>
                    </div>
                    {notification && <div className={`fixed top-4 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full text-xl font-bold ${notification.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
                        {notification.text}
                    </div>}
                </div>
            );

            if (screen === 'searching') return (
                <div className="min-h-screen flex flex-col items-center justify-center text-white">
                    <h2 className="text-5xl mb-8">Rəqib Axtarılır...</h2>
                    <button onClick={() => { send({type: 'cancelSearch'}); setScreen('lobby'); }}
                            className="bg-red-600 hover:bg-red-700 px-12 py-6 rounded-2xl text-2xl font-bold">
                        Ləğv Et / Cancel
                    </button>
                </div>
            );

            if (screen === 'game' && game) {
                const myHand = game.players[game.playerId]?.hand || [];
                const opponent = Object.values(game.players).find(p => p.id !== game.playerId);
                const board = game.board || [];
                const isMyTurn = game.currentPlayer === game.playerId;
                const leftEnd = board.length ? board[0][0] : null;
                const rightEnd = board.length ? board[board.length-1][1] : null;

                return (
                    <div className="min-h-screen flex flex-col text-white">
                        <div className="p-4 bg-black/60 text-center">
                            <p className="text-xl">{opponent?.name || 'Rəqib'} • {opponent?.hand?.length || 0} daş</p>
                            <p className={`text-2xl font-bold ${isMyTurn ? 'text-yellow-400' : 'text-gray-400'}`}>
                                {isMyTurn ? 'Sənin Növbən / Your Turn' : 'Rəqib Oynayır / Opponent Turn'}
                            </p>
                        </div>

                        <div className="flex-1 overflow-x-auto py-8">
                            <div className="flex items-center justify-center gap-4 min-w-max">
                                {board.length === 0 && selectedIdx !== null && 
                                    <button onClick={() => playTile('left')} className="valid-zone w-32 h-32 flex items-center justify-center text-3xl font-bold">BAŞLA</button>
                                }
                                {board.map((t, i) => (
                                    <DominoTile key={i} tile={t} vertical={t[0] !== t[1]} disabled />
                                ))}
                                {selectedIdx !== null && board.length > 0 && (
                                    <>
                                        {validMoves.includes('left') && <button onClick={() => playTile('left')} className="valid-zone w-32 h-32">SOL</button>}
                                        {validMoves.includes('right') && <button onClick={() => playTile('right')} className="valid-zone w-32 h-32">SAĞ</button>}
                                    </>
                                )}
                            </div>
                        </div>

                        <div className="p-4 bg-black/80">
                            <div className="flex justify-center gap-4 flex-wrap">
                                {myHand.map((tile, i) => (
                                    <DominoTile key={i} tile={tile} selected={selectedIdx === i} onClick={() => handleTileClick(i)} disabled={!isMyTurn} />
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return <div className="flex items-center justify-center h-screen text-4xl text-white">Yüklənir...</div>;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
