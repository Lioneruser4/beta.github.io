<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💣 Emoji Bomb 1v1 - Odalı Eşleşme</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ana Stiller */
        body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom right, #1a1a1a, #333333); color: #f0f0f0; overflow: hidden; }
        .screen { width: 100vw; height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; box-sizing: border-box; text-align: center; }
        .screen.active { display: flex; }
        .btn { @apply w-full max-w-xs text-xl font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 ease-in-out; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-500 active:scale-95; }
        .btn-secondary { @apply bg-green-600 text-white hover:bg-green-500 active:scale-95; }
        .btn-danger { @apply bg-red-600 text-white hover:bg-red-500 active:scale-95; }
        .input-field { @apply w-full max-w-xs text-lg bg-gray-700 text-white border-2 border-gray-600 rounded-lg p-4 text-center placeholder-gray-400 focus:outline-none focus:border-blue-500; }
        #globalMessage.show { display: block; animation: fadeInDown 0.3s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        /* Oyun Kartı Stilleri (Basitçe) */
        .game-card { @apply bg-gray-700 aspect-square rounded-lg flex items-center justify-center text-5xl cursor-pointer hover:bg-gray-600 transition-colors; }
    </style>
</head>
<body class="bg-gray-900 text-white select-none">

    <div id="globalMessage" class="hidden fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg z-50">
        <p id="globalMessageText"></p>
        <button id="globalMessageClose" class="absolute top-2 right-3 text-2xl font-bold">&times;</button>
    </div>

    <div id="loader" class="screen active">
        <div class="text-center">
            <div class="text-7xl">📡</div>
            <h1 class="text-4xl font-black mt-4">Sunucuya Bağlanıyor...</h1>
            <p id="connectionStatus" class="mt-2 text-yellow-400">Yükleniyor...</p>
        </div>
    </div>

    <div id="lobby" class="screen">
        <div class="w-full max-w-md space-y-6">
            <h1 class="text-5xl font-black text-center">💣 Emoji Bomb</h1>
            
            <input type="text" id="username" class="input-field" placeholder="Kullanıcı Adı">
            
            <div class="space-y-3">
                <button id="createRoomBtn" class="btn btn-primary">➕ Yeni Oda Kur</button>
                <p id="currentRoomCode" class="text-2xl font-bold text-yellow-400 hidden">Oda Kodun: <span id="roomCodeDisplay"></span></p>
            </div>
            
            <div class="space-y-3">
                <input type="text" id="joinRoomCode" class="input-field" placeholder="Oda Kodu Gir">
                <button id="joinRoomBtn" class="btn btn-secondary">🚪 Odaya Katıl</button>
            </div>
        </div>
    </div>
    
    <div id="waitScreen" class="screen">
        <div class="text-center space-y-4">
            <h2 id="waitTitle" class="text-4xl font-bold">Rakip Bekleniyor...</h2>
            <p class="text-xl">Oda Kodu: <strong id="waitRoomCode" class="text-yellow-400"></strong></p>
            <p id="waitStatus" class="text-lg text-gray-300">Arkadaşın bu kodu girerek katılabilir.</p>
            <button id="cancelWaitBtn" class="btn btn-danger text-base py-3 max-w-xs">İptal Et</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="w-full max-w-3xl absolute top-0 left-1/2 -translate-x-1/2 p-4">
            <div class="flex justify-between items-center text-lg sm:text-2xl font-bold">
                <div id="player1Info" class="text-left">
                    <span id="player1Name">Oyuncu 1</span>
                    <div id="player1Lives" class="text-3xl">❤️❤️</div>
                </div>
                <div id="player2Info" class="text-right">
                    <span id="player2Name">Oyuncu 2</span>
                    <div id="player2Lives" class="text-3xl">❤️❤️</div>
                </div>
            </div>
            <p id="turnIndicator" class="text-center text-xl sm:text-2xl font-bold text-yellow-400 mt-4"></p>
        </div>
        <div id="gameGrid" class="w-full max-w-3xl grid gap-2 sm:gap-3 p-4 mt-32">
            </div>
    </div>
    
    <div id="endScreen" class="screen absolute top-0 left-0">
        <div class="text-center space-y-6">
            <h1 id="endMessage" class="text-6xl font-black">Oyun Bitti!</h1>
            <button id="backToLobbyBtn" class="btn btn-secondary text-base py-3">Lobiye Dön</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Referansları ---
            const screens = {
                loader: document.getElementById('loader'),
                lobby: document.getElementById('lobby'),
                wait: document.getElementById('waitScreen'),
                game: document.getElementById('gameScreen'),
                end: document.getElementById('endScreen'),
            };
            const globalMessage = document.getElementById('globalMessage');
            const globalMessageText = document.getElementById('globalMessageText');
            const globalMessageClose = document.getElementById('globalMessageClose');
            const usernameInput = document.getElementById('username');
            const connectionStatus = document.getElementById('connectionStatus');
            const createRoomBtn = document.getElementById('createRoomBtn');
            const joinRoomCodeInput = document.getElementById('joinRoomCode');
            const joinRoomBtn = document.getElementById('joinRoomBtn');
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            const currentRoomCodeDiv = document.getElementById('currentRoomCode');
            const waitRoomCodeEl = document.getElementById('waitRoomCode');
            const waitTitle = document.getElementById('waitTitle');
            const waitStatusEl = document.getElementById('waitStatus');
            const cancelWaitBtn = document.getElementById('cancelWaitBtn');
            const player1NameEl = document.getElementById('player1Name');
            const player2NameEl = document.getElementById('player2Name');
            const turnIndicator = document.getElementById('turnIndicator');
            const gameGrid = document.getElementById('gameGrid');
            const backToLobbyBtn = document.getElementById('backToLobbyBtn');

            // --- Oyun Durumu (State) ---
            let socket; 
            let username = '';
            let roomCode = '';
            let isHost = false; 
            
            // Oyun içi durum simülasyonu
            const EMOJIS = ["🍎", "🍊", "🍋", "🥝", "🍇", "🍉", "🍓", "🍍"];
            let cards = [];
            let myTurn = false;
            let player1Username = 'Oyuncu 1';
            let player2Username = 'Oyuncu 2';
            let flippedCards = [];

            // --- Temel Fonksiyonlar ---
            function showGlobalMessage(message, isError = true) {
                globalMessageText.textContent = message;
                globalMessage.classList.remove('bg-red-600', 'bg-green-600');
                globalMessage.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
                globalMessage.classList.remove('hidden');
                globalMessage.classList.add('show');
                setTimeout(() => { globalMessage.classList.add('hidden'); globalMessage.classList.remove('show'); }, 3000);
            }
            function showScreen(screenId) {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenId].classList.add('active');
            }
            function validateUsername() {
                username = usernameInput.value.trim();
                if (username.length < 2) {
                    showGlobalMessage('Lütfen geçerli bir kullanıcı adı girin (en az 2 karakter).');
                    return false;
                }
                return true;
            }
            function resetState() {
                roomCode = '';
                isHost = false;
                myTurn = false;
                currentRoomCodeDiv.classList.add('hidden');
                joinRoomCodeInput.value = '';
                // Diğer oyun durumlarını sıfırla (kartlar, skorlar vb.)
            }

            // --- Socket.IO Bağlantısı ve Olay Yönetimi ---
            function connectToServer() {
                const SERVER_URL = 'http://localhost:3000'; // Sunucu adresinizi kontrol edin
                try {
                    socket = io(SERVER_URL, {
                         // Sunucuya CORS ayarı yapıldıysa bu satır zorunlu değil ama faydalıdır.
                         transports: ['websocket'] 
                    });

                    socket.on('connect', () => {
                        connectionStatus.textContent = 'Bağlandı! Hazır.';
                        showScreen('lobby');
                    });

                    socket.on('connect_error', (err) => {
                        console.error('Bağlantı Hatası:', err);
                        connectionStatus.textContent = 'HATA: Sunucuya bağlanılamadı. Lütfen sunucuyu (server.js) çalıştırın.';
                        showGlobalMessage('Sunucuya bağlanılamadı.', true);
                    });
                    
                    // Sunucudan Gelen Olaylar
                    socket.on('roomCreated', (code) => {
                        roomCode = code;
                        isHost = true;
                        roomCodeDisplay.textContent = code;
                        currentRoomCodeDiv.classList.remove('hidden');
                        waitRoomCodeEl.textContent = code;
                        waitStatusEl.textContent = `Oda kodunuz: ${code}. Arkadaşınızın katılmasını bekleyin.`;
                        showScreen('wait');
                        showGlobalMessage(`Oda ${code} koduyla kuruldu.`, false);
                    });

                    socket.on('roomJoined', (code) => {
                        roomCode = code;
                        isHost = false; 
                        waitRoomCodeEl.textContent = code;
                        waitTitle.textContent = 'Odaya Katıldınız.';
                        waitStatusEl.textContent = `Host bekleniyor...`;
                        showScreen('wait');
                        showGlobalMessage(`Oda ${code} koduna katıldınız.`, false);
                    });
                    
                    socket.on('roomFull', () => {
                        showGlobalMessage('Oda dolu veya böyle bir oda bulunamadı.', true);
                        resetState();
                        showScreen('lobby');
                    });

                    socket.on('gameStart', (playerRoles) => {
                        const myRole = playerRoles.find(p => p.id === socket.id);
                        const opponentRole = playerRoles.find(p => p.id !== socket.id);
                        
                        // İsimleri Ayarla
                        player1Username = myRole.isHost ? username : opponentRole.username;
                        player2Username = myRole.isHost ? opponentRole.username : username;
                        player1NameEl.textContent = player1Username;
                        player2NameEl.textContent = player2Username;

                        startGame(myRole.isHost); 
                        showGlobalMessage(`${opponentRole.username} katıldı! Oyun Başlıyor!`, false);
                    });
                    
                    socket.on('opponentLeft', () => {
                        showGlobalMessage('Rakibiniz odadan ayrıldı veya bağlantısı kesildi. Lobiye dönülüyor.', true);
                        resetState();
                        showScreen('lobby');
                    });

                    socket.on('gameData', (data) => {
                        // Rakip hamlelerini (örneğin kart çevirme, skor) burada işleyin.
                        console.log("Rakibinizden gelen oyun verisi:", data);
                        // handleRemoteGameAction(data);
                    });
                    
                    socket.on('disconnect', () => {
                        showGlobalMessage('Sunucu bağlantısı kesildi.', true);
                        resetState();
                        showScreen('loader'); // Tekrar bağlanmayı denemesi için loader'a dön
                        setTimeout(connectToServer, 3000); // Yeniden bağlanmayı dene
                    });

                } catch (e) {
                    console.error('Socket.IO hatası:', e);
                    connectionStatus.textContent = 'HATA: Socket.IO yüklenemedi.';
                }
            }

            // --- Lobi ve Oda İşlemleri ---
            function initCreateRoom() {
                if (!validateUsername() || !socket || !socket.connected) {
                    showGlobalMessage('Önce sunucuya bağlanın ve kullanıcı adınızı girin.', true);
                    return;
                }
                socket.emit('createRoom', { username: username });
            }

            function initJoinRoom() {
                if (!validateUsername() || !socket || !socket.connected) {
                    showGlobalMessage('Önce sunucuya bağlanın ve kullanıcı adınızı girin.', true);
                    return;
                }
                const code = joinRoomCodeInput.value.trim().toUpperCase();
                if (code.length < 4) {
                    showGlobalMessage('Lütfen geçerli bir oda kodu girin (en az 4 haneli).');
                    return;
                }
                socket.emit('joinRoom', { username: username, roomCode: code });
            }
            
            function cancelWaiting() {
                if (socket && roomCode) {
                    socket.emit('leaveRoom', { roomCode: roomCode });
                }
                resetState();
                showScreen('lobby');
            }
            
            function backToLobby() {
                 // Oyun bitince lobiye dönerken odayı terk et
                 if (socket && roomCode) {
                    socket.emit('leaveRoom', { roomCode: roomCode });
                }
                resetState();
                showScreen('lobby');
            }


            // --- Oyun Mantığı Simülasyonu ---
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function startGame(isHost) {
                // Host, kartları oluşturur ve rakibe gönderir.
                if (isHost) {
                    let gameEmojis = shuffle([...EMOJIS, ...EMOJIS]);
                    // Basit kart yapısı
                    cards = gameEmojis.map((emoji, index) => ({
                        id: index,
                        emoji: emoji,
                        isFlipped: false,
                        isMatched: false,
                        // ... bomba vb. eklenebilir
                    }));
                    // Rakibe kart düzenini gönder (Gerekli 'gameData' olayı ile)
                    // socket.emit('gameData', { roomCode: roomCode, type: 'CONFIG', cards: cards });
                } 
                // Misafir, Host'tan 'CONFIG' mesajını bekler.

                myTurn = isHost; // Host başlar
                updateTurnIndicator();
                createGameGrid(cards);
                showScreen('game');
            }

            function createGameGrid(cards) {
                // Basit 4x4 ızgara (Toplam 16 kart)
                gameGrid.style.gridTemplateColumns = 'repeat(4, 1fr)'; 
                gameGrid.innerHTML = '';
                
                cards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'game-card';
                    cardElement.dataset.index = index;
                    cardElement.textContent = '?'; // Başlangıçta kapalı
                    cardElement.addEventListener('click', () => handleCardClick(index));
                    gameGrid.appendChild(cardElement);
                });
            }

            function handleCardClick(index) {
                if (!myTurn || flippedCards.length >= 2 || cards[index].isFlipped) {
                    return;
                }
                
                // Kartı çevir ve hamleyi rakibe yolla
                flipCard(index, cards[index].emoji);
                socket.emit('gameData', { roomCode: roomCode, type: 'FLIP', index: index, emoji: cards[index].emoji });
                
                // Oyun mantığı (Eşleşme kontrolü vb.) buraya gelir.
            }
            
            function flipCard(index, emoji) {
                 // Kartı DOM'da göster
                 const cardEl = gameGrid.querySelector(`[data-index="${index}"]`);
                 if (cardEl) {
                     cardEl.textContent = emoji;
                     cardEl.classList.add('bg-blue-500'); // Açıldığını belirt
                 }
                 cards[index].isFlipped = true;
                 flippedCards.push(index);
            }

            function updateTurnIndicator() {
                const myName = isHost ? player1Username : player2Username;
                const oppName = isHost ? player2Username : player1Username;
                
                if (myTurn) {
                    turnIndicator.textContent = `Sıra Sende (${myName})`;
                    turnIndicator.classList.add('text-yellow-400');
                    turnIndicator.classList.remove('text-red-400');
                } else {
                    turnIndicator.textContent = `Rakip Oynuyor (${oppName}) - Bekle`;
                    turnIndicator.classList.add('text-red-400');
                    turnIndicator.classList.remove('text-yellow-400');
                }
            }
            // --- Olay Dinleyicileri ---
            globalMessageClose.addEventListener('click', () => globalMessage.classList.add('hidden'));
            createRoomBtn.addEventListener('click', initCreateRoom);
            joinRoomBtn.addEventListener('click', initJoinRoom);
            cancelWaitBtn.addEventListener('click', cancelWaiting);
            backToLobbyBtn.addEventListener('click', backToLobby);
            
            // İlk bağlantıyı başlat
            connectToServer();
        });
    </script>
</body>
</html>
