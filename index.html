<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Domino 101 Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            background: #0f172a;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        .bg-table {
            background: radial-gradient(circle at center, #1b4d3e 0%, #061812 100%);
        }

        .tile-shadow {
            box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.5);
        }

        .pip {
            width: 5px;
            height: 5px;
            background: #111;
            border-radius: 50%;
        }

        .animate-pop {
            animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .valid-move {
            position: absolute;
            width: 30px;
            height: 30px;
            background: rgba(255, 215, 0, 0.6);
            border: 2px solid white;
            border-radius: 50%;
            z-index: 50;
            animation: pulse 1.5s infinite;
            cursor: pointer;
            box-shadow: 0 0 10px gold;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const WS_URL = 'wss://beta-github-io.onrender.com';
        const API_URL = 'https://beta-github-io.onrender.com';

        // --- COMPONENTS ---
        const Pips = ({ n }) => {
            const map = { 0: [], 1: [4], 2: [0, 8], 3: [0, 4, 8], 4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 2, 3, 5, 6, 8] };
            return <div className="grid grid-cols-3 grid-rows-3 w-full h-full p-0.5 gap-0.5">{[...Array(9)].map((_, i) => <div key={i} className={`rounded-full ${map[n].includes(i) ? 'bg-black' : 'bg-transparent'}`} />)}</div>
        };

        const Tile = ({ vals, onClick, selected, isBoard, dir = 'right' }) => {
            // Hand tiles: Vertical. Board tiles: Depends on dir.
            const isVert = isBoard ? (dir === 'up' || dir === 'down') : true;
            const dim = isBoard
                ? (isVert ? { w: 30, h: 60 } : { w: 60, h: 30 })
                : { w: 42, h: 84 }; // Hand size

            // Flex direction inside the tile
            // If Hand Vertical: Column.
            // If Board Horizontal: Row. If Board Vertical: Column.
            const flexDir = (isBoard && !isVert) ? 'row' : 'col';

            return (
                <div onClick={onClick}
                    className={`relative bg-white rounded flex border border-gray-400 tile-shadow transition-transform ${selected ? '-translate-y-4 ring-2 ring-yellow-400 z-10' : ''}`}
                    style={{ width: dim.w, height: dim.h, flexDirection: flexDir === 'col' ? 'column' : 'row' }}>
                    <div className={`flex-1 flex items-center justify-center ${flexDir === 'col' ? 'border-b' : 'border-r'} border-gray-300 relative`}>
                        <Pips n={vals[0]} />
                    </div>
                    <div className="flex-1 flex items-center justify-center relative">
                        <Pips n={vals[1]} />
                        <div className="absolute inset-0 flex items-center justify-center"><div className="w-1.5 h-1.5 rounded-full bg-black opacity-20" /></div>
                    </div>
                </div>
            );
        };

        const Avatar = ({ url, name, ring = 'gray', size = 'md' }) => {
            const sz = size === 'lg' ? 'w-16 h-16' : size === 'xl' ? 'w-24 h-24' : 'w-10 h-10';
            return (
                <div className="flex flex-col items-center">
                    <div className={`${sz} rounded-full border-2 border-${ring}-400 overflow-hidden bg-gray-700 shadow-lg`}>
                        {url ? <img src={url} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-xl">üë§</div>}
                    </div>
                    {name && <span className="text-white text-xs font-bold mt-1 shadow-black drop-shadow-md">{name}</span>}
                </div>
            );
        };

        // --- APP ---
        const App = () => {
            const [page, setPage] = useState('auth');
            const [ws, setWs] = useState(null);
            const [me, setMe] = useState(null);
            const [game, setGame] = useState(null);
            const [opp, setOpp] = useState(null);
            const [lead, setLead] = useState([]);
            const [loading, setLoading] = useState(false);

            // Game State
            const [selTile, setSelTile] = useState(null);
            const [validMoves, setValidMoves] = useState([]);
            const [winInfo, setWinInfo] = useState(null);

            // Pan/Zoom
            const [view, setView] = useState({ x: 0, y: 0, z: 1 });
            const boardRef = useRef();
            const touchStart = useRef(null);

            useEffect(() => {
                // Auth & Connect
                const init = async () => {
                    let u = { username: 'Guest', telegramId: 'guest_' + Date.now() };
                    if (tg?.initDataUnsafe?.user) {
                        const tgu = tg.initDataUnsafe.user;
                        u = { telegramId: String(tgu.id), username: tgu.first_name, photoUrl: tgu.photo_url };
                    }

                    // Sync with server
                    try {
                        const res = await fetch(API_URL + '/api/auth/telegram', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(u)
                        });
                        const d = await res.json();
                        if (d.success) setMe(d.player); else setMe(u);
                    } catch (e) { setMe(u); }

                    connectWS(u.telegramId);
                };
                init();
            }, []);

            const connectWS = (tid) => {
                const s = new WebSocket(WS_URL);
                s.onopen = () => {
                    setWs(s);
                    s.send(JSON.stringify({ type: 'reconnect', telegramId: tid }));
                };
                s.onmessage = (e) => handleMsg(JSON.parse(e.data));
                s.onclose = () => setTimeout(() => connectWS(tid), 3000);
            };

            const send = (type, data = {}) => {
                if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type, telegramId: me.telegramId, ...data }));
            };

            const handleMsg = (d) => {
                switch (d.type) {
                    case 'reconnectSuccess':
                    case 'gameStart':
                        setGame(d.gameState);
                        // Find Opponent
                        const opId = Object.keys(d.gameState.players).find(k => k !== me.telegramId);
                        setOpp(d.gameState.players[opId]);
                        setPage('game');
                        setLoading(false);
                        break;
                    case 'gameUpdate':
                        setGame(curr => ({ ...curr, ...d.gameState }));
                        setSelTile(null);
                        break;
                    case 'matchFound':
                        setOpp(d.opponent); // Shows opponent immediately
                        setLoading(true); // Wait for start
                        break;
                    case 'gameEnd':
                        setWinInfo(d);
                        setPage('result');
                        break;
                    case 'opponentDisconnected':
                        alert('R…ôqib internetd…ôn ayrƒ±ldƒ±! G√∂zl…ônilir...');
                        break;
                }
            };

            // Helpers
            const getMoves = (tile) => {
                if (!game?.board.length) return ['left']; // 'start' maps to left for simplicity here
                const b = game.board;
                const L = b[0][0], R = b[b.length - 1][1];
                const m = [];
                if (tile[0] === L || tile[1] === L) m.push('left');
                if (tile[0] === R || tile[1] === R) m.push('right');
                return m;
            };

            const play = (pos) => {
                if (selTile === null) return;
                send('playTile', { tileIndex: selTile, position: pos });
            };

            // Render Board Logic
            const renderBoard = () => {
                if (!game?.board) return [];
                const b = game.board;
                let x = 0, y = 0;
                // Simple Straight Line for stability as requested "fix play"
                // Complex snake can be added but let's ensure functionality first
                // Using 60px width per tile
                return b.map((t, i) => {
                    const pos = { val: t, x: (i - b.length / 2) * 62, y: 0 };
                    return pos;
                });
            };

            // --- PAGES ---

            if (page === 'auth' || !me) return <div className="h-screen bg-slate-900 flex items-center justify-center text-white"><div className="animate-spin text-4xl">‚è≥</div></div>;

            if (page === 'lobby') return (
                <div className="h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white p-4 flex flex-col">
                    <div className="flex justify-between items-center mb-8">
                        <Avatar url={me.photoUrl} name={me.username} size="lg" ring="green" />
                        <div className="text-right">
                            <div className="text-2xl font-black text-yellow-400">{me.elo} ELO</div>
                            <div className="text-sm text-gray-400">LVL {me.level}</div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center gap-4">
                        <button onClick={() => { setPage('searching'); send('findMatch', me); }}
                            className="w-full max-w-sm bg-gradient-to-r from-yellow-500 to-amber-600 py-6 rounded-2xl font-black text-2xl shadow-lg transform active:scale-95 transition-all">
                            ‚öîÔ∏è OYUN AXTAR
                        </button>
                        <button onClick={async () => {
                            const res = await fetch(API_URL + '/api/leaderboard');
                            const d = await res.json();
                            if (d.success) { setLead(d.leaderboard); setPage('leaderboard'); }
                        }} className="w-full max-w-sm glass py-4 rounded-xl font-bold">
                            üèÜ Lƒ∞DERL∆èR
                        </button>
                    </div>
                </div>
            );

            if (page === 'searching') return (
                <div className="h-screen bg-slate-900 flex flex-col items-center justify-center text-white p-4">
                    {opp ? (
                        <div className="text-center animate-pop">
                            <div className="text-green-400 text-2xl font-bold mb-4">R∆èQƒ∞B TAPILDI!</div>
                            <Avatar url={opp.photoUrl} name={opp.username} size="xl" ring="red" />
                            <div className="mt-4 text-sm text-gray-400">Oyun ba≈üladƒ±lƒ±r...</div>
                        </div>
                    ) : (
                        <div className="text-center">
                            <div className="w-20 h-20 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin mx-auto mb-6" />
                            <h2 className="text-2xl font-bold">R…ôqib Axtarƒ±lƒ±r...</h2>
                            <button onClick={() => { send('cancelSearch'); setPage('lobby'); }} className="mt-8 text-red-400">L∆èƒûV ET</button>
                        </div>
                    )}
                </div>
            );

            if (page === 'leaderboard') return (
                <div className="h-screen bg-slate-900 text-white p-4 flex flex-col">
                    <div className="flex items-center mb-6"><button onClick={() => setPage('lobby')} className="text-2xl mr-4">‚¨ÖÔ∏è</button><h1 className="text-2xl font-bold">Liderl…ôr</h1></div>
                    <div className="flex-1 overflow-y-auto space-y-3 pb-4">
                        {lead.map((u, i) => (
                            <div key={i} className="glass p-3 rounded-xl flex items-center gap-4">
                                <div className="font-bold text-gray-400 w-6">#{i + 1}</div>
                                <Avatar url={u.photoUrl} size="sm" />
                                <div className="flex-1 font-bold">{u.username}</div>
                                <div className="text-yellow-400 font-bold">{u.elo}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (page === 'result' && winInfo) return (
                <div className="h-screen bg-black/90 flex flex-col items-center justify-center text-white p-6 text-center">
                    <h1 className={`text-5xl font-black mb-4 ${winInfo.isWinner ? 'text-green-500' : 'text-red-500'}`}>
                        {winInfo.isWinner ? 'QAZANDINIZ! üéâ' : 'UDUZDUNUZ üíÄ'}
                    </h1>
                    <p className="text-xl mb-8">{winInfo.message}</p>
                    <div className="text-3xl font-bold mb-8">
                        {winInfo.eloChange > 0 ? '+' : ''}{winInfo.eloChange} ELO
                    </div>
                    <button onClick={() => { setPage('lobby'); setGame(null); }} className="bg-white text-black px-8 py-3 rounded-full font-bold">
                        LOBBƒ∞Y∆è QAYIT
                    </button>
                </div>
            );

            if (page === 'game' && game) return (
                <div className="fixed inset-0 bg-table flex flex-col">
                    {/* Header */}
                    <div className="h-16 glass flex items-center justify-between px-4 z-20">
                        <div className="flex items-center gap-3">
                            <Avatar url={opp?.photoUrl} size="sm" ring="red" />
                            <div className="leading-tight">
                                <div className="font-bold text-white">{opp?.name}</div>
                                <div className="text-xs text-gray-300">Da≈ü: {opp?.handCount}</div>
                            </div>
                        </div>
                        <div className={`px-3 py-1 rounded-full text-xs font-bold ${game.currentPlayer === me.telegramId ? 'bg-yellow-500 text-black animate-pulse' : 'bg-gray-700 text-white'}`}>
                            {game.currentPlayer === me.telegramId ? 'Sƒ∞Zƒ∞N N√ñVB∆èNƒ∞Z' : 'R∆èQƒ∞B G√ñZL∆èNƒ∞Lƒ∞R'}
                        </div>
                    </div>

                    {/* Board */}
                    <div className="flex-1 relative overflow-hidden"
                        onTouchStart={e => {
                            if (e.touches.length === 1) touchStart.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                            if (e.touches.length === 2) touchStart.current = { d: Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY) };
                        }}
                        onTouchMove={e => {
                            if (e.touches.length === 1 && touchStart.current?.x) {
                                const dx = e.touches[0].clientX - touchStart.current.x;
                                const dy = e.touches[0].clientY - touchStart.current.y;
                                setView(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
                                touchStart.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                            }
                            if (e.touches.length === 2 && touchStart.current?.d) {
                                const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                                const s = d / touchStart.current.d;
                                setView(v => ({ ...v, z: Math.max(0.5, Math.min(3, v.z * s)) }));
                                touchStart.current.d = d;
                            }
                        }}
                    >
                        <div className="absolute top-1/2 left-1/2 transition-transform duration-75"
                            style={{ transform: `translate(-50%,-50%) translate(${view.x}px,${view.y}px) scale(${view.z})` }}>

                            {renderBoard().map((pos, i) => (
                                <div key={i} className="absolute transition-all duration-300" style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }}>
                                    <Tile vals={pos.val} isBoard={true} />
                                </div>
                            ))}

                            {/* Interactive Indicators */}
                            {selTile !== null && getMoves(game.players[me.telegramId].hand[selTile]).map(dir => (
                                <div key={dir} className="valid-move"
                                    style={{
                                        left: dir === 'left' ? (renderBoard()[0]?.x || 0) - 50 : (renderBoard()[renderBoard.length - 1]?.x || 0) + 50,
                                        top: 15
                                    }}
                                    onClick={() => play(dir)}
                                />
                            ))}
                        </div>
                    </div>

                    {/* Hand */}
                    <div className="bg-black/80 p-4 pb-8 z-20">
                        <div className="flex justify-center gap-2 mb-4 overflow-x-auto px-4 min-h-[90px]">
                            {game.players[me.telegramId].hand.map((t, i) => (
                                <Tile key={i} vals={t} selected={selTile === i} onClick={() => {
                                    if (game.currentPlayer === me.telegramId) setSelTile(selTile === i ? null : i);
                                }} />
                            ))}
                        </div>
                        <div className="flex justify-between items-center px-4">
                            <button onClick={() => send('leaveGame')} className="text-red-400 font-bold text-sm">‚õî √áIXI≈û</button>
                            <button onClick={() => send('drawFromMarket')} className="bg-blue-600 text-white px-4 py-2 rounded-full font-bold text-sm shadow-lg active:scale-95 disabled:opacity-50"
                                disabled={game.market === 0 || game.currentPlayer !== me.telegramId}>
                                üé≤ BAZAR ({game.market})
                            </button>
                        </div>
                    </div>
                </div>
            );

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
