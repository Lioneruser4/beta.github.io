<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí£ Emoji Bomb 1v1 - Profesyonel E≈üle≈üme</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        /* Genel Stil ve Arka Plan */
        body { font-family: sans-serif; background: linear-gradient(to bottom right, #1a1a1a, #333333); color: #333; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .screen { width: 100%; max-width: 500px; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; box-sizing: border-box; text-align: center; background-color: #f0f0f0; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); }
        .screen.active { display: flex; }
        
        /* Bile≈üenler */
        .btn { @apply w-full text-xl font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 ease-in-out; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-500 active:scale-95; }
        .input-field { @apply w-full text-lg bg-gray-200 text-gray-900 border-2 border-gray-400 rounded-lg p-3 text-center placeholder-gray-500 focus:outline-none focus:border-blue-500; }
        .code-display { @apply text-4xl font-extrabold p-4 bg-gray-800 text-yellow-300 rounded-lg tracking-widest; }
        #globalMessage.show { display: block; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 50; animation: fadeInDown 0.3s ease-out; }

        /* Kart Stilleri */
        .card-container {
            perspective: 1000px; /* 3D Efekti i√ßin gerekli */
        }
        .card {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            background-color: transparent;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Ters y√ºz√ºn√º gizle */
            border-radius: 8px;
            @apply flex items-center justify-center text-4xl font-black shadow-md;
        }
        .card-front {
            background-color: #4a5568; /* Kapalƒ± Kart Rengi */
            color: #f7fafc;
        }
        .card-back {
            background-color: #e2e8f0; /* A√ßƒ±k Kart Arka Planƒ± */
            color: #333;
            transform: rotateY(180deg);
        }
        .card.bomb-selected .card-front {
            background-color: #e53e3e; /* Se√ßim A≈üamasƒ±nda Kƒ±rmƒ±zƒ± */
            animation: pulse-red 0.5s infinite alternate;
        }
        
        /* Titre≈üim Animasyonu */
        @keyframes vibrate {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-1px, -2px) rotate(-1deg); }
            40% { transform: translate(-3px, 0px) rotate(1deg); }
            60% { transform: translate(3px, 2px) rotate(0deg); }
            80% { transform: translate(1px, -1px) rotate(-1deg); }
            100% { transform: translate(-1px, 2px) rotate(1deg); }
        }
        .vibrate {
            animation: vibrate 0.1s linear infinite;
        }
        
        @keyframes pulse-red {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-900 select-none">

    <div id="globalMessage" class="hidden w-11/12 max-w-md p-4 bg-red-600 text-white rounded-lg shadow-lg">
        <p id="globalMessageText"></p>
    </div>

    <div id="lobby" class="screen active space-y-6">
        <h1 class="text-5xl font-black text-gray-900">üí£ Emoji Bomb</h1>
        <p class="text-gray-700">Sunucuya baƒülƒ±. Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin.</p>
        
        <input type="text" id="username" class="input-field" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="text" id="roomCodeInput" class="input-field uppercase" placeholder="Oda Numarasƒ± (Bo≈ü bƒ±rak=Olu≈ütur)">
        
        <button id="matchBtn" class="btn btn-primary">üéÆ Oda Olu≈ütur / Odaya Gir</button>
    </div>
    
    <div id="waitScreen" class="screen space-y-6">
        <h2 id="waitTitle" class="text-3xl font-bold text-gray-900">Oda Kuruluyor...</h2>
        <div id="codeArea" class="space-y-3 hidden">
            <p class="text-lg text-gray-700">Oda Kodunuz:</p>
            <div id="roomCodeDisplay" class="code-display"></div>
            <button id="copyCodeBtn" class="btn bg-gray-600 text-white text-base py-2 max-w-xs">Kopyala</button>
        </div>
        <p id="waitStatus" class="text-lg text-gray-700"></p>
        <button id="cancelBtn" class="btn bg-red-600 text-base py-3 max-w-xs">ƒ∞ptal Et</button>
    </div>

    <div id="gameScreen" class="screen active space-y-6">
        <h1 class="text-5xl font-black text-gray-900">üïπÔ∏è Emoji Bomb</h1>
        
        <div class="flex justify-between w-full text-gray-800 font-bold">
            <p>Sen: <span id="myLives" class="text-green-600">‚ù§Ô∏è‚ù§Ô∏è</span></p>
            <p>Rakip: <span id="opponentName" class="text-blue-600"></span></p>
            <p>Rakip Can: <span id="opponentLives" class="text-green-600">‚ù§Ô∏è‚ù§Ô∏è</span></p>
        </div>
        <p id="roleStatus" class="text-gray-700"></p>

        <div id="gameContent" class="p-6 bg-gray-200 rounded-lg w-full space-y-4">
            <h3 id="turnStatus" class="text-2xl font-bold text-red-600">Rakip bekleniyor...</h3>
            <p id="actionMessage" class="text-base text-purple-600 font-semibold"></p>
            
            <div id="gameBoard" class="grid w-full max-w-sm mx-auto" style="grid-template-columns: repeat(6, 1fr);">
                </div>
            
        </div>
        
        <button id="endGameBtn" class="btn bg-gray-600 text-white text-base py-3 max-w-xs">Oyunu Bitir</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Referanslarƒ± ve Deƒüi≈ükenler ---
            const screens = { lobby: document.getElementById('lobby'), wait: document.getElementById('waitScreen'), game: document.getElementById('gameScreen') };
            // ... (diƒüer DOM referanslarƒ± aynƒ± kalƒ±r)
            const gameBoardEl = document.getElementById('gameBoard');
            const turnStatusEl = document.getElementById('turnStatus');
            const actionMessageEl = document.getElementById('actionMessage');
            const myLivesEl = document.getElementById('myLives');
            const opponentLivesEl = document.getElementById('opponentLives');
            const opponentNameEl = document.getElementById('opponentName');
            const roleStatusEl = document.getElementById('roleStatus');
            
            // SESLER
            const audioBomb = new Audio('sound1.mp3'); 
            const audioEmoji = new Audio('sound2.mp3');
            const audioWait = new Audio('sound3.mp3'); 
            
            // OYUN DURUMU
            let socket;
            let currentRoomCode = '';
            let username = '';
            let isHost = false;
            let selectedBombs = []; // Se√ßim a≈üamasƒ±nda kendi se√ßtiƒüimiz bombalar
            let level = 1; 
            const LEVELS = [18, 22, 28]; // Kart sayƒ±larƒ±
            let gameStage = 'SELECTION'; // 'SELECTION' (bomba se√ßme) veya 'PLAY' (kart a√ßma)
            
            let gameData = {
                board: [], // {opened: false, emoji: '?', isBomb: false}
                turn: 0,   // 0: Host, 1: Guest
                hostLives: 2,
                guestLives: 2,
                cardsLeft: 0,
                hostBombs: [], // Rakip i√ßin gizli bombalar
                guestBombs: [], // Rakip i√ßin gizli bombalar
                //... diƒüer durumlar
            };
            
            const EMOTICONS = ['üôÇ', 'üòÇ', 'üòç', 'üòé', 'ü§©', 'üëç', 'üéâ', 'üåü', 'üçï', 'üê±'];

            // Render URL'niz (KENDƒ∞ URL'nizle deƒüi≈ütirin)
            const LIVE_SERVER_URL = 'https://beta-github-io.onrender.com'; 
            
            // --- Temel Fonksiyonlar ---
            function showGlobalMessage(message, isError = true) {
                // ... (Aynƒ± kalƒ±r)
                globalMessageText.textContent = message;
                globalMessage.classList.remove('bg-red-600', 'bg-green-600');
                globalMessage.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
                globalMessage.classList.remove('hidden');
                globalMessage.classList.add('show');
                setTimeout(() => { globalMessage.classList.add('hidden'); globalMessage.classList.remove('show'); }, 4000);
            }
            function showScreen(screenId) {
                 Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenId].classList.add('active');
            }
            // ... (resetGame, validateInput aynƒ± kalƒ±r)
            
            // --- OYUN MANTIƒûI ---

            function initializeGame(initialBoardSize) {
                gameData.board = Array(initialBoardSize).fill(null).map(() => ({
                    opened: false,
                    content: '?',
                    isBomb: false
                }));
                gameData.cardsLeft = initialBoardSize;
                gameData.hostLives = 2;
                gameData.guestLives = 2;
                gameData.hostBombs = [];
                gameData.guestBombs = [];
                selectedBombs = [];
                gameData.turn = 0; // Host Ba≈ülar
                gameStage = 'SELECTION'; 
            }
            
            function drawBoard() {
                const boardSize = LEVELS[level - 1];
                gameBoardEl.style.gridTemplateColumns = `repeat(${boardSize <= 22 ? 6 : 7}, 1fr)`; // 18, 22 i√ßin 6 s√ºtun, 28 i√ßin 7 s√ºtun
                gameBoardEl.innerHTML = '';
                
                gameData.board.forEach((cardState, index) => {
                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'card-container aspect-square';

                    const card = document.createElement('div');
                    card.className = `card cursor-pointer`;
                    card.dataset.index = index;

                    const front = document.createElement('div');
                    front.className = 'card-face card-front text-gray-100';
                    front.textContent = '?';
                    
                    const back = document.createElement('div');
                    back.className = 'card-face card-back';
                    back.textContent = cardState.content;

                    card.appendChild(front);
                    card.appendChild(back);
                    cardContainer.appendChild(card);
                    
                    if (cardState.opened) {
                        card.classList.add('is-flipped');
                    } else {
                        // Se√ßim a≈üamasƒ±nda tƒ±klanabilir yap
                        if (gameStage === 'SELECTION') {
                           // Bu a≈üamada kartƒ± i≈üaretle
                           if (selectedBombs.includes(index)) {
                                card.classList.add('bomb-selected');
                            }
                        }
                        card.addEventListener('click', handleCardClick);
                    }
                    
                    gameBoardEl.appendChild(cardContainer);
                });
                updateStatusDisplay();
            }

            function updateStatusDisplay() {
                myLivesEl.textContent = '‚ù§Ô∏è'.repeat(isHost ? gameData.hostLives : gameData.guestLives);
                myLivesEl.classList.toggle('text-red-600', (isHost ? gameData.hostLives : gameData.guestLives) <= 1);
                myLivesEl.classList.toggle('text-green-600', (isHost ? gameData.hostLives : gameData.guestLives) > 1);
                
                opponentLivesEl.textContent = '‚ù§Ô∏è'.repeat(isHost ? gameData.guestLives : gameData.hostLives);
                opponentLivesEl.classList.toggle('text-red-600', (isHost ? gameData.guestLives : gameData.hostLives) <= 1);
                opponentLivesEl.classList.toggle('text-green-600', (isHost ? gameData.guestLives : gameData.hostLives) > 1);

                const isMyTurn = (isHost && gameData.turn === 0) || (!isHost && gameData.turn === 1);

                if (gameStage === 'SELECTION') {
                    if (selectedBombs.length < 3) {
                        turnStatusEl.textContent = `Bomba Se√ß: ${selectedBombs.length} / 3`;
                        actionMessageEl.textContent = "3 adet gizli bombayƒ± se√ßin.";
                        turnStatusEl.classList.add('text-green-600');
                    } else {
                        turnStatusEl.textContent = `Rakip Bombasƒ±nƒ± Se√ßiyor...`;
                        actionMessageEl.textContent = "Se√ßiminiz tamamlandƒ±. Rakibi bekleyin.";
                        turnStatusEl.classList.add('text-red-600');
                    }
                } else if (gameStage === 'PLAY') {
                    if (isMyTurn) {
                        turnStatusEl.textContent = 'SIRA SENDE!';
                        turnStatusEl.classList.add('text-green-600');
                        actionMessageEl.textContent = "Bir kart a√ß!";
                    } else {
                        turnStatusEl.textContent = 'RAKƒ∞Bƒ∞N SIRASI';
                        turnStatusEl.classList.add('text-red-600');
                        actionMessageEl.textContent = "Rakibin hareketini bekle.";
                    }
                }
                
                // Oyun Bitti Kontrol√º
                if (gameData.hostLives <= 0 || gameData.guestLives <= 0) {
                     endGame(gameData.hostLives <= 0 ? 'Guest' : 'Host');
                }
            }

            // --- ANIMASYON VE SES ---

            function startVibration() {
                const cardContainers = gameBoardEl.querySelectorAll('.card-container');
                cardContainers.forEach(container => {
                    const card = container.querySelector('.card');
                    if (!card.classList.contains('is-flipped')) {
                        card.classList.add('vibrate');
                    }
                });
                audioWait.play().catch(() => {}); // Ses √ßalma hatasƒ± y√∂netimi
            }

            function stopVibration() {
                const cardContainers = gameBoardEl.querySelectorAll('.card-container');
                 cardContainers.forEach(container => {
                    const card = container.querySelector('.card');
                    card.classList.remove('vibrate');
                });
                audioWait.pause();
                audioWait.currentTime = 0;
            }
            
            async function triggerWaitAndVibrate() {
                 if (gameData.cardsLeft < 8 && gameStage === 'PLAY') { // Kalan kart sayƒ±sƒ± azaldƒ±ysa
                    startVibration();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    stopVibration();
                }
            }

            // --- KART TIKLAMA VE VERƒ∞ G√ñNDERME ---
            
            function handleCardClick(event) {
                const cardElement = event.currentTarget.querySelector('.card');
                const cardIndex = parseInt(cardElement.dataset.index);

                if (gameStage === 'SELECTION') {
                    // Bomba Se√ßim A≈üamasƒ±
                    if (selectedBombs.includes(cardIndex)) {
                        selectedBombs = selectedBombs.filter(i => i !== cardIndex);
                    } else if (selectedBombs.length < 3) {
                        selectedBombs.push(cardIndex);
                    }
                    drawBoard(); // Tahtayƒ± tekrar √ßiz, se√ßimi g√∂ster
                    
                    if (selectedBombs.length === 3) {
                        // 3 bomba se√ßildi, rakibe g√∂nder
                        socket.emit('bombSelectionComplete', { roomCode: currentRoomCode, bombs: selectedBombs });
                        updateStatusDisplay();
                    }
                } else if (gameStage === 'PLAY') {
                    // Kart A√ßma A≈üamasƒ±
                    const isMyTurn = (isHost && gameData.turn === 0) || (!isHost && gameData.turn === 1);
                    if (!isMyTurn || gameData.board[cardIndex].opened || gameData.isGameOver) return; 
                    
                    sendMove(cardIndex);
                }
            }
            
            function sendMove(index) {
                if (socket && socket.connected) {
                    socket.emit('gameData', {
                        roomCode: currentRoomCode,
                        type: 'MOVE',
                        cardIndex: index,
                    });
                }
            }

            // --- HAREKETƒ∞ UYGULAMA (KART A√áMA) ---
            
            async function applyMove(index, nextTurn) {
                if (gameData.board[index].opened) return;

                await triggerWaitAndVibrate(); // Bekleme ve titre≈üim

                // Kartƒ± a√ß
                gameData.board[index].opened = true;
                gameData.cardsLeft -= 1;
                
                // Bombayƒ± kontrol et (Kendi rol√ºne g√∂re rakibin bombasƒ±nƒ± kontrol et)
                const opponentBombs = isHost ? gameData.guestBombs : gameData.hostBombs;
                const hitBomb = opponentBombs.includes(index);
                
                if (hitBomb) {
                    // BOMBA!
                    gameData.board[index].content = 'üí£';
                    const myLives = isHost ? --gameData.hostLives : --gameData.guestLives;
                    
                    audioBomb.play().catch(() => {});
                    showGlobalMessage(`BOOM! Bomba buldun. Kalan can: ${myLives}`, true);
                } else {
                    // G√úVENLƒ∞
                    gameData.board[index].content = EMOTICONS[Math.floor(Math.random() * EMOTICONS.length)];
                    audioEmoji.play().catch(() => {});
                }
                
                // Animasyon i√ßin local √ßizim
                drawBoard(); 
                
                // 1 saniye sonra sƒ±rayƒ± deƒüi≈ütir
                setTimeout(() => {
                    gameData.turn = nextTurn;
                    updateStatusDisplay();
                    
                    // Eƒüer oyun bittiyse (can kalmadƒ±ysa)
                    if (gameData.hostLives <= 0 || gameData.guestLives <= 0) {
                        endGame(gameData.hostLives <= 0 ? 'Guest' : 'Host');
                    }
                    
                }, 1000); // Kart a√ßƒ±lma animasyonu s√ºresi kadar bekle
            }
            
            function endGame(winnerRole) {
                gameData.isGameOver = true;
                gameStage = 'ENDED';
                turnStatusEl.textContent = `OYUN Bƒ∞TTƒ∞! KAZANAN: ${winnerRole}!`;
                actionMessageEl.textContent = `Tebrikler. Yeni seviyeye ge√ßiliyor...`;
                
                // Bir sonraki seviyeye ge√ßi≈ü
                setTimeout(() => {
                    if (level < LEVELS.length) {
                        level++;
                        showGlobalMessage(`Yeni Seviye: ${LEVELS[level-1]} Kart!`, false);
                        
                        // Oyunu yeniden ba≈ülatma sinyalini Host'un g√∂ndermesi idealdir.
                        if (isHost) {
                            socket.emit('nextLevel', { roomCode: currentRoomCode, newLevel: level });
                        }
                    } else {
                         showGlobalMessage("Oyunun t√ºm seviyeleri tamamlandƒ±!", false);
                         resetGame();
                    }
                }, 4000);
            }


            // --- SOCKET.IO ƒ∞≈ûLEYƒ∞Cƒ∞LERƒ∞ ---

            // Socket.IO Baƒülantƒ±sƒ± (Aynƒ± kalƒ±r)
            // ... (connectToServer fonksiyonu aynƒ± kalƒ±r, LIVE_SERVER_URL'nizle)
            
            // ODA OLU≈ûTURMA VE KATILMA (Aynƒ± Kalƒ±r)
            // ... (matchBtn olay dinleyicisi aynƒ± kalƒ±r)

            
            // gameStart Olayƒ± (Yeni Mantƒ±k)
            socket.on('gameStart', (players) => {
                const opponent = players.find(p => p.id !== socket.id);
                const self = players.find(p => p.id === socket.id);

                opponentNameEl.textContent = opponent.username;
                isHost = self.isHost;
                roleStatusEl.textContent = isHost ? "Rol√ºn√ºz: HOST" : "Rol√ºn√ºz: GUEST";
                
                showGlobalMessage(`Oyun ${opponent.username} ile ba≈üladƒ±! Bomba se√ßimine ge√ßiliyor.`, false);
                
                initializeGame(LEVELS[level - 1]); // Mevcut seviye kart sayƒ±sƒ± ile ba≈ülat
                drawBoard(); 
                updateStatusDisplay();
                showScreen('game');
            });
            
            // Bomb Se√ßimi Tamamlandƒ± (Rakip Bombasƒ±nƒ± G√∂nderdi)
            socket.on('bombSelectionComplete', ({ isHost, bombs }) => {
                if (isHost) {
                    gameData.hostBombs = bombs;
                } else {
                    gameData.guestBombs = bombs;
                }
                
                // Eƒüer iki taraf da se√ßimi tamamladƒ±ysa
                if (gameData.hostBombs.length === 3 && gameData.guestBombs.length === 3) {
                    gameStage = 'PLAY';
                    showGlobalMessage('Herkes bombasƒ±nƒ± se√ßti! Kart a√ßma a≈üamasƒ± ba≈ülƒ±yor.', false);
                    drawBoard(); // Kart se√ßim i≈üaretlerini kaldƒ±rƒ±r
                } else {
                    actionMessageEl.textContent = "Rakip bombasƒ±nƒ± se√ßti. L√ºtfen siz de 3 bomba se√ßin.";
                }
                updateStatusDisplay();
            });

            // gameData Olayƒ± (Rakibin Hareketi Geldi)
            socket.on('gameData', (data) => {
                if (gameStage !== 'PLAY') return;
                
                if (data.type === 'MOVE') {
                    const opponentTurn = gameData.turn; // Hareket eden tarafƒ±n sƒ±rasƒ±
                    const nextTurn = 1 - opponentTurn; // Sƒ±ra deƒüi≈üecek
                    
                    // Rakibin hareketini uygula
                    applyMove(data.cardIndex, nextTurn); 
                    
                    // Rakibin hareketi olduƒüu i√ßin, canlar zaten applyMove i√ßinde azalƒ±r
                }
            });

            // Seviye Atlama Sinyali (Sadece Host g√∂nderir)
             socket.on('nextLevel', ({ newLevel }) => {
                level = newLevel;
                showGlobalMessage(`Yeni Seviye: ${LEVELS[level-1]} Kart! Tekrar Bomb Se√ßimi Ba≈ülƒ±yor...`, false);
                initializeGame(LEVELS[level - 1]);
                drawBoard();
                updateStatusDisplay();
            });

            // ... (Diƒüer socket olaylarƒ± aynƒ± kalƒ±r)
            
            // --- Olay Dinleyicileri (Lobi ve Baƒülantƒ±) ---
            // ... (matchBtn, cancelBtn, endGameBtn, copyCodeBtn aynƒ± kalƒ±r)
            
            // Ba≈ülangƒ±√ßta sunucuya baƒülan
            // connectToServer(); // Bu fonksiyonu manuel olarak kendiniz √ßaƒüƒ±rmalƒ±sƒ±nƒ±z.
        });
    </script>
</body>
</html>
